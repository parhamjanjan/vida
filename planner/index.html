<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù¾Ù„Ù†Ø± - Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§</title>

<!-- Tailwind + FontAwesome + Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
  
  :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #1e293b;
    --bg-color: #0f172a;
    --text-color: #e2e8f0;
    --sidebar-bg: rgba(30,41,59,0.9);
    --card-bg: rgba(30,41,59,0.5);
    --border-color: rgba(255,255,255,0.04);
    --input-bg: rgba(30,41,59,0.8);
  }

  [data-theme="light"] {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #f8fafc;
    --bg-color: #f1f5f9;
    --text-color: #1e293b;
    --sidebar-bg: rgba(255,255,255,0.9);
    --card-bg: rgba(255,255,255,0.7);
    --border-color: rgba(0,0,0,0.08);
    --input-bg: rgba(255,255,255,0.9);
  }

  /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØºÛŒÛŒØ± ØªÙ… */
  body {
    background: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.5s ease, color 0.5s ease;
  }

  * {
    box-sizing: border-box;
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ dropdown */
  .form-input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
    font-family: 'Vazirmatn', sans-serif;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø¯Ø§Ø¯ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ */
  .completed-count {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 2px 6px;
    border-radius: 999px;
    font-size: 0.7rem;
    margin-right: 8px;
  }

  .list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.9rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    background: var(--card-bg);
  }

  .list-item-content {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex: 1;
  }

  .list-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ options Ø¯Ø± dropdown */
  .form-input option {
    background: var(--input-bg);
    color: var(--text-color);
    padding: 10px;
    border: none;
  }

  /* ÙˆÙ‚ØªÛŒ dropdown Ø¨Ø§Ø² Ø§Ø³Øª */
  .form-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ input Ø²Ù…Ø§Ù† */
  .time-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .time-input-group .form-input:first-child {
    flex: 1;
  }

  .time-input-group .form-input:last-child {
    width: 100px;
  }

  .flex-1 {
    flex: 1;
  }

  .w-24 {
    width: 6rem;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ */
  .charts-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 16px;
  }

  .chart-card {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
  }

  .chart-wrapper {
    position: relative;
    height: 250px;
    width: 100%;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØµÙØ­Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ */
  .print-report {
    display: none;
  }

  .print-page {
    background: white;
    color: black;
    padding: 20mm;
    min-height: 297mm;
    width: 210mm;
    margin: 0 auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    font-family: 'Vazirmatn', sans-serif;
  }

  .print-header {
    text-align: center;
    border-bottom: 2px solid #4f46e5;
    padding-bottom: 15px;
    margin-bottom: 20px;
  }

  .print-header h1 {
    color: #4f46e5;
    font-size: 24px;
    margin-bottom: 10px;
  }

  .print-meta {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
  }

  .print-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
  }

  .print-table th {
    background: #4f46e5;
    color: white;
    padding: 12px 8px;
    text-align: right;
    border: 1px solid #ddd;
  }

  .print-table td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: right;
  }

  .print-table tr:nth-child(even) {
    background: #f8f9fa;
  }

  .print-summary {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-right: 4px solid #4f46e5;
  }

  .print-summary h3 {
    color: #4f46e5;
    margin-bottom: 10px;
  }

  .print-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    color: #666;
    font-size: 12px;
  }

  .no-print {
    display: block;
  }

  @media print {
    body * {
      visibility: hidden;
    }
    .print-report, .print-report * {
      visibility: visible;
    }
    .print-report {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      background: white;
    }
    .no-print {
      display: none !important;
    }
    .print-page {
      box-shadow: none;
      margin: 0;
      padding: 15mm;
    }
  }

  body {
    margin: 0;
    font-family: 'Vazirmatn', sans-serif;
  }
  
  nav {
    height: 72px;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    padding: 0 16px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .planner {
    display: flex;
    gap: 16px;
    padding: 18px 0;
  }
  
  /* Sidebar full-height */
  .sidebar {
    width: 300px;
    background: var(--sidebar-bg);
    border-radius: 12px;
    padding: 18px;
    border: 1px solid var(--border-color);
    height: calc(100vh - 72px);
    overflow: auto;
    position: relative;
  }
  
  .main {
    flex: 1;
    overflow: auto;
    padding-bottom: 40px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .add-task-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border-color);
    padding: .7rem 0;
    color: inherit;
    outline: none;
  }

  .list-item.active {
    background: rgba(79,70,229,.12);
    border-right: 3px solid var(--primary);
  }
  
  .list-count {
    background: var(--card-bg);
    padding: .15rem .5rem;
    border-radius: 999px;
    font-size: .8rem;
    margin-right: .5rem;
  }

  /* menu (three-dot) */
  .list-controls {
    position: relative;
  }
  
  .list-menu-btn {
    background: transparent;
    border: none;
    color: var(--text-color);
    opacity: 0.7;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
  }
  
  .list-menu {
    position: absolute;
    top: 36px;
    left: 0;
    background: var(--card);
    border: 1px solid var(--border-color);
    padding: 6px;
    border-radius: 8px;
    display: none;
    min-width: 140px;
    z-index: 80;
  }
  
  .list-menu button {
    display: block;
    width: 100%;
    text-align: right;
    padding: 8px;
    border-radius: 6px;
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
  }
  
  .list-item:hover .list-menu-btn {
    opacity: 1;
  }
  
  .list-item:hover .list-menu {
    display: block;
  }

  /* week */
  .weekly-planner {
    background: var(--card-bg);
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
  }
  
  .week-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 12px;
  }
  
  .day-cell {
    min-height: 120px;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 8px;
    border: 1px dashed var(--border-color);
    position: relative;
  }
  
  .day-cell.today {
    background: rgba(79,70,229,0.12);
    border-color: var(--primary);
  }
  
  .day-task {
    background: var(--card-bg);
    padding: 6px;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .day-task .delete-task-btn {
    color: #ef4444;
    cursor: pointer;
    margin-left: 8px;
  }

  /* task list */
  .task-list {
    background: var(--card-bg);
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
  }
  
  .task-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .task-checkbox {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .task-checkbox.checked {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }
  
  .task-title.completed {
    text-decoration: line-through;
    opacity: 0.75;
  }

  /* modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  
  .modal .modal-content {
    background: var(--card);
    padding: 16px;
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    border: 1px solid var(--border-color);
  }

  .drop-active {
    background: rgba(79,70,229,0.12);
    border-color: var(--primary);
  }

  /* Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± ØªÙ… */
  .theme-toggle {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 8px;
    border-radius: 50%;
    transition: transform 0.3s ease;
  }

  .theme-toggle:hover {
    transform: rotate(30deg);
  }

  /* Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    color: var(--text-color);
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 350px;
    transform: translateX(400px);
    transition: transform 0.3s ease;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification-icon {
    font-size: 1.5rem;
    color: var(--primary);
  }

  .notification-close {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.2rem;
  }

  /* Ù†Ø´Ø§Ù†Ú¯Ø± Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ ØªØ³Ú© */
  .task-time-badge {
    background: rgba(79, 70, 229, 0.2);
    color: var(--primary);
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.7rem;
    margin-right: 8px;
  }

  .task-time-badge.past {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
  }

  .task-time-badge.upcoming {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ */
  .time-category {
    margin-bottom: 20px;
  }

  .time-category-header {
    display: flex;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
  }

  .time-category-title {
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .time-category-count {
    background: var(--card-bg);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
  }

  .time-category-content {
    display: none;
  }

  .time-category.expanded .time-category-content {
    display: block;
  }

  .time-category.expanded .time-category-header {
    border-bottom: none;
  }

  .time-category-icon {
    transition: transform 0.3s ease;
  }

  .time-category.expanded .time-category-icon {
    transform: rotate(90deg);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯ */
  .league-section {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
  }

  .league-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .league-title {
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .league-icon {
    font-size: 1.5rem;
  }

  .league-info {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }

  .league-stat {
    text-align: center;
    flex: 1;
  }

  .league-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .league-stat-label {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.7;
  }

  .league-progress {
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 16px;
  }

  .league-progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .league-rankings {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }

  .ranking-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .ranking-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
  }

  .ranking-info {
    flex: 1;
  }

  .ranking-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .ranking-stats {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.7;
  }

  .ranking-position {
    font-weight: 700;
    font-size: 1.2rem;
  }

  .badges-container {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .badge-icon {
    font-size: 1rem;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÚ¯â€ŒÙ‡Ø§ */
  .league-legendary {
    background: linear-gradient(135deg, #ffd700, #ff8c00);
    color: #000;
  }

  .league-professional {
    background: linear-gradient(135deg, #c0c0c0, #808080);
    color: #fff;
  }

  .league-beginner {
    background: linear-gradient(135deg, #cd7f32, #8b4513);
    color: #fff;
  }

  .league-training {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    color: #fff;
  }

  /* Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  @media (max-width: 768px) {
    .planner {
      flex-direction: column;
    }
    
    .sidebar {
      width: 100%;
      height: auto;
    }
    
    .week-days {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .charts-container {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .chart-wrapper {
      height: 220px;
    }
    
    .chart-card {
      padding: 12px;
      margin-bottom: 0;
    }

    .time-input-group {
      flex-direction: column;
      gap: 4px;
    }
    
    .time-input-group .form-input:last-child {
      width: 100%;
    }

    .print-page {
      padding: 10mm;
      width: 100%;
    }

    .print-table {
      font-size: 12px;
    }

    .print-table th,
    .print-table td {
      padding: 6px 4px;
    }

    .league-rankings {
      grid-template-columns: 1fr;
    }

    .league-info {
      flex-direction: column;
      gap: 8px;
    }
  }

  /* Ù…ÙˆØ¨Ø§ÛŒÙ„ Ú©ÙˆÚ†Ú© */
  @media (max-width: 480px) {
    .charts-container {
      gap: 8px;
    }
    
    .chart-card {
      padding: 10px;
    }
    
    .chart-wrapper {
      height: 200px;
    }
    
    .chart-title {
      font-size: 14px;
    }
  }
</style>
</head>
<body>
<nav>
  <div class="container flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-emerald-400 flex items-center justify-center">
        <i class="fas fa-graduation-cap text-white"></i>
      </div>
      <div style="-webkit-background-clip:text;background:linear-gradient(135deg,var(--primary),var(--green));color:white;" class="font-bold text-lg">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§</div>
    </div>
    <div class="flex items-center gap-4 no-print">
      <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      <button id="printReportBtn" class="btn-primary">
        <i class="fas fa-print ml-2"></i>
        Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="planner">
    <!-- Sidebar (requested structure) -->
    <div class="sidebar h-full" id="sidebar">
      <div class="mb-8">
        <button class="btn-primary w-full mb-4" id="addListBtn">
            <i class="fas fa-plus ml-2"></i>
            Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯
        </button>
        <input type="text" class="add-task-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªØ³Ú©â€ŒÙ‡Ø§..." id="searchInput">
      </div>
      
      <div class="mb-6">
        <div class="list-item active" data-view="inbox" id="view-inbox">
            <div class="list-item-content">
                <i class="fas fa-inbox ml-3"></i>
                <span>ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ</span>
                <span class="list-count" id="inbox-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="today" id="view-today">
            <div class="list-item-content">
                <i class="fas fa-calendar-day ml-3" style="color: #10b981;"></i>
                <span>Ø§Ù…Ø±ÙˆØ²</span>
                <span class="list-count" id="today-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="week" id="view-week">
            <div class="list-item-content">
                <i class="fas fa-calendar-week ml-3" style="color: #f59e0b;"></i>
                <span>Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</span>
                <span class="list-count" id="week-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="important" id="view-important">
            <div class="list-item-content">
                <i class="fas fa-star ml-3" style="color: #ef4444;"></i>
                <span>Ù…Ù‡Ù…</span>
                <span class="list-count" id="important-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="league" id="view-league">
            <div class="list-item-content">
                <i class="fas fa-trophy ml-3" style="color: #f59e0b;"></i>
                <span>Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ</span>
            </div>
        </div>
      </div>
      
      <div class="mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-slate-400">Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ</h3>
        </div>
        <div id="study-lists"><!-- JS fills here --></div>
      </div>
      
      <div>
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-slate-400">Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ</h3>
        </div>
        <div id="personal-lists"><!-- JS fills here --></div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- stats -->
      <div class="stats-grid mb-4" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
        <div class="stat-card">
          <div class="text-2xl font-bold" id="total-study-time">0</div>
          <div class="text-sm text-slate-400">Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù‡ÙØªÙ‡</div>
        </div>
        <div class="stat-card">
          <div class="text-2xl font-bold" id="completed-tasks">0</div>
          <div class="text-sm text-slate-400">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
        </div>
        <div class="stat-card">
          <div class="text-2xl font-bold" id="productivity-score">0%</div>
          <div class="text-sm text-slate-400">Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ</div>
        </div>
      </div>

      <!-- weekly planner -->
      <div class="weekly-planner mb-4">
        <div class="flex justify-between items-center">
          <button id="prev-week" class="btn-primary"><i class="fas fa-chevron-right ml-2"></i> Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„</button>
          <h3 class="section-title" id="current-week">Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</h3>
          <button id="next-week" class="btn-primary">Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯ <i class="fas fa-chevron-left mr-2"></i></button>
        </div>

        <div class="week-days" id="week-days"></div>
      </div>

      <!-- Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ -->
      <div id="league-view" style="display: none;">

        <div class="league-section">
          <div class="league-header">
            <div class="league-title">
              <i class="fas fa-trophy league-icon" id="league-icon"></i>
              <span id="league-name">Ù„ÛŒÚ¯ Ø¢Ù…ÙˆØ²Ø´ÛŒ</span>
            </div>
            <div class="flex items-center gap-2">
              <span id="league-points">Ø§Ù…ØªÛŒØ§Ø²: 0</span>
            </div>
          </div>

          <div class="league-info">
            <div class="league-stat">
              <div class="league-stat-value" id="daily-hours">0</div>
              <div class="league-stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø³Ø§Ø¹Øª)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="weekly-hours">0</div>
              <div class="league-stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù‡ÙØªÚ¯ÛŒ (Ø³Ø§Ø¹Øª)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="streak-days">0</div>
              <div class="league-stat-label">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ</div>
            </div>
          </div>

          <div class="league-progress">
            <div class="league-progress-bar" id="league-progress-bar" style="width: 0%;"></div>
          </div>

          <div class="flex justify-between items-center mb-3">
            <div class="text-sm">Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡ Ù„ÛŒÚ¯ Ø¨Ø¹Ø¯ÛŒ</div>
            <div class="text-sm" id="league-next">0%</div>
          </div>

          <div class="badges-container" id="badges-container">
            <!-- Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
          </div>
        </div>

        <div class="league-section">
          <h3 class="section-title mb-4">Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø´Ù…Ø§</h3>
          <div class="league-rankings flex" id="league-rankings">
            <!-- Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
          </div>
        </div>
      </div>

      <!-- charts -->
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title mb-2"><i class="fas fa-chart-line ml-2"></i> Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</div>
          <div class="chart-wrapper">
            <canvas id="studyTimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title mb-2"><i class="fas fa-tasks ml-2"></i> Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ÛŒ</div>
          <div class="chart-wrapper">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- tasks -->
      <div id="tasks-view">
        <div class="section-title mb-4">
          <i class="fas fa-inbox ml-2"></i>
          <span id="current-list-title" class="text-lg font-bold">ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ</span>
        </div>

        <div class="mb-4 flex gap-3">
          <input type="text" id="new-task-input" class="add-task-input" placeholder="Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ³Ú© (Enter)..." />
          <button id="openTaskModal" class="btn-primary">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>

        <div class="task-list" id="task-list"></div>

        <div class="mt-6" id="completed-section">
          <div class="section-title">
            <i class="fas fa-check-circle text-green-500"></i>
            <span>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ (<span id="completed-count">0</span>)</span>
          </div>
          <div id="completed-tasks-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
<div class="notification" id="notification">
  <div class="notification-icon">
    <i class="fas fa-bell"></i>
  </div>
  <div class="notification-content">
    <div class="notification-title font-bold" id="notification-title">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</div>
    <div class="notification-message text-sm" id="notification-message">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!</div>
  </div>
  <button class="notification-close" id="notification-close">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- ØµÙØ­Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ -->
<div class="print-report" id="printReport">
  <div class="print-page">
    <div class="print-header">
      <h1>Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h1>
      <div class="print-meta">
        <div id="report-week-range">Ù‡ÙØªÙ‡: -</div>
        <div id="report-generation-date">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: -</div>
      </div>
    </div>

    <div class="print-summary">
      <h3>Ø®Ù„Ø§ØµÙ‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù‡ÙØªÚ¯ÛŒ</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #4f46e5;" id="report-total-tasks">0</div>
          <div style="font-size: 12px; color: #666;">ØªØ¹Ø¯Ø§Ø¯ ØªØ³Ú©â€ŒÙ‡Ø§</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #10b981;" id="report-total-time">0 Ø³Ø§Ø¹Øª</div>
          <div style="font-size: 12px; color: #666;">Ù…Ø¬Ù…ÙˆØ¹ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #f59e0b;" id="report-avg-time">0 Ø³Ø§Ø¹Øª</div>
          <div style="font-size: 12px; color: #666;">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</div>
        </div>
      </div>
    </div>

    <table class="print-table">
      <thead>
        <tr>
          <th>Ø±Ø¯ÛŒÙ</th>
          <th>Ø¹Ù†ÙˆØ§Ù† ØªØ³Ú©</th>
          <th>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
          <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…</th>
          <th>Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
          <th>Ø§ÙˆÙ„ÙˆÛŒØª</th>
          <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="report-tasks-table">
        <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </tbody>
    </table>

    <div class="print-summary">
      <h3>ØªÙˆØ²ÛŒØ¹ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</h3>
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px; font-size: 12px;">
        <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆØ²ÛŒØ¹ Ø²Ù…Ø§Ù†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </div>
    </div>

    <div class="print-footer">
      <p>Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆØ³Ø· Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
      <p>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: <span id="report-footer-date">-</span></p>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="listModal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4" id="listModalTitle">Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯</h2>
    <div class="mb-3">
      <label class="block mb-1">Ù†Ø§Ù… Ù„ÛŒØ³Øª</label>
      <input id="listNameInput" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø±ÛŒØ§Ø¶ÛŒØ§Øª">
    </div>
    <div class="mb-3">
      <label class="block mb-1">Ø±Ù†Ú¯</label>
      <input id="listColorInput" type="color" class="form-input" value="#4f46e5">
    </div>
    <div class="flex justify-end gap-2">
      <button id="saveListBtn" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="cancelListBtn" class="btn-primary" style="background:transparent;border:1px solid var(--border-color)">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<div class="modal" id="taskModal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3" id="taskModalTitle">Ø§ÛŒØ¬Ø§Ø¯ ØªØ³Ú© Ø¬Ø¯ÛŒØ¯</h2>
    <div class="mb-2"><label class="block mb-1">Ø¹Ù†ÙˆØ§Ù†</label><input id="taskTitleInput" class="form-input"></div>
    <div class="mb-2"><label class="block mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="taskDescriptionInput" class="form-input" rows="3"></textarea></div>
    <div class="mb-2 grid grid-cols-2 gap-2">
      <div><label class="block mb-1">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯</label><input id="taskDueDateInput" type="date" class="form-input"></div>
      <div>
        <label class="block mb-1">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</label>
        <div class="time-input-group">
          <input id="taskStudyTimeInput" type="number" class="form-input flex-1" min="0" step="1" value="1" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
          <select id="taskTimeUnitInput" class="form-input w-24">
            <option value="hours">Ø³Ø§Ø¹Øª</option>
            <option value="minutes">Ø¯Ù‚ÛŒÙ‚Ù‡</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mb-2 grid grid-cols-2 gap-2">
      <div>
        <label class="block mb-1">Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹</label>
        <input id="taskStartTimeInput" type="time" class="form-input">
      </div>
      <div>
        <label class="block mb-1">Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†</label>
        <input id="taskEndTimeInput" type="time" class="form-input">
      </div>
    </div>
    <div class="mb-2 grid grid-cols-2 gap-2">
      <div>
        <label class="block mb-1">ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</label>
        <select id="taskReminderInput" class="form-input">
          <option value="none">Ø¨Ø¯ÙˆÙ† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          <option value="5">Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
          <option value="10">Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
          <option value="15">Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
          <option value="30">Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
          <option value="60">Û± Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„</option>
        </select>
      </div>
      <div>
        <label class="block mb-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ</label>
        <select id="taskTimeCategoryInput" class="form-input">
          <option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
          <option value="morning">ØµØ¨Ø­ (ØªØ§ 10:00)</option>
          <option value="noon">Ø¸Ù‡Ø± (ØªØ§ 14:00)</option>
          <option value="afternoon">ØºØ±ÙˆØ¨ (ØªØ§ 18:00)</option>
          <option value="evening">Ø´Ø¨ (ØªØ§ 22:00)</option>
          <option value="midnight">Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨ (ØªØ§ 2:00)</option>
        </select>
      </div>
    </div>
    <div class="mb-2"><label class="block mb-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label><select id="taskCategoryInput" class="form-input"></select></div>
    <div class="flex justify-end gap-2">
      <button id="saveTaskBtn" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="cancelTaskBtn" class="btn-primary" style="background:transparent;border:1px solid var(--border-color)">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Data & persistence (start with default lists)
   --------------------------- */
let tasks = JSON.parse(localStorage.getItem('plannerTasks') || '[]');
let lists = JSON.parse(localStorage.getItem('plannerLists') || '[]');

// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯
let userStats = JSON.parse(localStorage.getItem('plannerUserStats') || '{}');

// Ø§Ú¯Ø± Ù„ÛŒØ³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
if (lists.length === 0) {
  lists = [
    { id: 'math', name: 'Ø±ÛŒØ§Ø¶ÛŒØ§Øª', color: '#4f46e5' },
    { id: 'science', name: 'Ø¹Ù„ÙˆÙ…', color: '#10b981' },
    { id: 'english', name: 'Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', color: '#f59e0b' },
    { id: 'history', name: 'ØªØ§Ø±ÛŒØ®', color: '#ef4444' },
    { id: 'shopping', name: 'Ø®Ø±ÛŒØ¯', color: '#8b5cf6' },
    { id: 'home', name: 'Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø®Ø§Ù†Ù‡', color: '#06b6d4' }
  ];
  localStorage.setItem('plannerLists', JSON.stringify(lists));
}

// Ø§Ú¯Ø± Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
if (Object.keys(userStats).length === 0) {
  userStats = {
    dailyHours: 0,
    weeklyHours: 0,
    streak: 0,
    league: 'training',
    points: 0,
    lastStudyDate: null,
    completedTasks: 0,
    badges: [],
    studyHistory: {}
  };
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats));
}

let currentWeek = 0;
let currentView = 'inbox';
let currentCategory = '';
let editingListId = null;
let editingTaskId = null;

// Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…
let currentTheme = localStorage.getItem('plannerTheme') || 'dark';

// Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
let reminderTimeouts = [];

function saveAll(){ 
  localStorage.setItem('plannerTasks', JSON.stringify(tasks)); 
  localStorage.setItem('plannerLists', JSON.stringify(lists)); 
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats)); 
}
function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function isoDate(d){ return new Date(d).toISOString().split('T')[0]; }

/* ---------------------------
   Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ
   --------------------------- */
function updateUserStats() {
  const today = todayISO();
  const weekDates = getCurrentWeekDates(currentWeek);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  const weeklyHours = tasks
    .filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡
  const dailyHours = weeklyHours / 7;
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø­Ø¯Ø§Ù‚Ù„ 4 Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø§Ø´ØªÙ‡â€ŒØ§ÛŒØ¯
  const streak = calculateStudyStreak();
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²
  let points = Math.round(weeklyHours * 10); // 10 Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡
  
  // ØªØ¹ÛŒÛŒÙ† Ù„ÛŒÚ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡
  let league = 'training';
  if (weeklyHours >= 50) {
    league = 'legendary';
  } else if (weeklyHours >= 40) {
    league = 'professional';
  } else if (weeklyHours >= 30) {
    league = 'beginner';
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±
  userStats.dailyHours = dailyHours;
  userStats.weeklyHours = weeklyHours;
  userStats.streak = streak;
  userStats.league = league;
  userStats.points = points;
  userStats.lastStudyDate = today;
  userStats.completedTasks = tasks.filter(t => t.completed).length;
  
  // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡
  if (!userStats.studyHistory) userStats.studyHistory = {};
  userStats.studyHistory[today] = weeklyHours;
  
  // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§
  checkBadges();
  
  saveAll();
}

function calculateStudyStreak() {
  // ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ 30 Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡
  const dates = [];
  for (let i = 0; i < 30; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    dates.push(isoDate(date));
  }
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ²
  const dailyStudy = {};
  dates.forEach(date => {
    dailyStudy[date] = tasks
      .filter(t => t.completed && t.dueDate === date)
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  });
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ø² Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ Ø¹Ù‚Ø¨
  let streak = 0;
  const today = todayISO();
  
  for (let i = 0; i < dates.length; i++) {
    const date = dates[i];
    const studyHours = dailyStudy[date] || 0;
    
    // Ø§Ú¯Ø± Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª Ùˆ Ù‡Ù†ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯
    if (date === today && studyHours === 0) {
      continue;
    }
    
    // Ø§Ú¯Ø± Ø±ÙˆØ²ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ 4 Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
    if (studyHours >= 4) {
      streak++;
    } else {
      // Ø§Ú¯Ø± Ø±ÙˆØ²ÛŒ Ø¨Ø§ Ú©Ù…ØªØ± Ø§Ø² 4 Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
      break;
    }
  }
  
  return streak;
}

function checkBadges() {
  const badges = [];
  
  // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‡ÙØªÚ¯ÛŒ (7 Ø±ÙˆØ² Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ 4 Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ø±ÙˆØ²)
  if (userStats.streak >= 7) {
    badges.push({ id: 'streak-7', name: 'Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‡ÙØªÚ¯ÛŒ', icon: 'fa-fire', description: 'Û· Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ø³Ø§Ø¹Øª Ø¯Ø± Ø±ÙˆØ²' });
  }
  
  // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡ (30 Ø±ÙˆØ² Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ 4 Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ø±ÙˆØ²)
  if (userStats.streak >= 30) {
    badges.push({ id: 'streak-30', name: 'Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡', icon: 'fa-calendar', description: 'Û³Û° Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ø³Ø§Ø¹Øª Ø¯Ø± Ø±ÙˆØ²' });
  }
  
  // Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
  if (userStats.weeklyHours >= 50) {
    badges.push({ id: 'study-50', name: 'Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', icon: 'fa-graduation-cap', description: 'ÛµÛ° Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ù‡ÙØªÙ‡' });
  }
  
  // Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ
  if (userStats.weeklyHours >= 100) {
    badges.push({ id: 'study-100', name: 'Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ', icon: 'fa-crown', description: 'Û±Û°Û° Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ù‡ÙØªÙ‡' });
  }
  
  // ØªØ³Ú© Ù…Ø³ØªØ±
  if (userStats.completedTasks >= 100) {
    badges.push({ id: 'task-master', name: 'ØªØ³Ú© Ù…Ø³ØªØ±', icon: 'fa-tasks', description: 'ØªÚ©Ù…ÛŒÙ„ Û±Û°Û° ØªØ³Ú©' });
  }
  
  // Ù¾Ø±Ù†Ø¯Ù‡ Ø³Ø­Ø±Ø®ÛŒØ²
  const earlyBirdTasks = tasks.filter(t => {
    if (!t.startTime || !t.completed) return false;
    const [hours] = t.startTime.split(':').map(Number);
    return hours < 7;
  });
  
  if (earlyBirdTasks.length >= 10) {
    badges.push({ id: 'early-bird', name: 'Ù¾Ø±Ù†Ø¯Ù‡ Ø³Ø­Ø±Ø®ÛŒØ²', icon: 'fa-sun', description: 'Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Û· ØµØ¨Ø­' });
  }
  
  // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
  badges.forEach(badge => {
    if (!userStats.badges.some(b => b.id === badge.id)) {
      userStats.badges.push(badge);
      showNotification('ğŸ‰ ØªØ¨Ø±ÛŒÚ©!', `Ù†Ø´Ø§Ù† "${badge.name}" Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!`);
    }
  });
  
  saveAll();
}

function renderLeagueView() {
  updateUserStats();
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„ÛŒÚ¯
  document.getElementById('league-name').textContent = getLeagueName(userStats.league);
  document.getElementById('league-icon').className = `fas ${getLeagueIcon(userStats.league)} league-icon`;
  document.getElementById('league-points').textContent = `Ø§Ù…ØªÛŒØ§Ø²: ${userStats.points}`;
  document.getElementById('daily-hours').textContent = userStats.dailyHours.toFixed(1);
  document.getElementById('weekly-hours').textContent = userStats.weeklyHours.toFixed(1);
  document.getElementById('streak-days').textContent = userStats.streak;
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡ Ù„ÛŒÚ¯ Ø¨Ø¹Ø¯ÛŒ
  const progress = calculateLeagueProgress();
  document.getElementById('league-progress-bar').style.width = `${progress}%`;
  document.getElementById('league-progress-bar').style.background = getLeagueColor(userStats.league);
  document.getElementById('league-next').textContent = `${progress}%`;
  
  // Ù†Ù…Ø§ÛŒØ´ Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§
  renderBadges();
  
  // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§
  renderAchievements();
}

function getLeagueName(league) {
  const names = {
    'legendary': 'Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ',
    'professional': 'Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ',
    'beginner': 'Ù…Ø¨ØªØ¯ÛŒ',
    'training': 'Ø¢Ù…ÙˆØ²Ø´ÛŒ'
  };
  return names[league] || 'Ø¢Ù…ÙˆØ²Ø´ÛŒ';
}

function getLeagueIcon(league) {
  const icons = {
    'legendary': 'fa-crown',
    'professional': 'fa-medal',
    'beginner': 'fa-award',
    'training': 'fa-user-graduate'
  };
  return icons[league] || 'fa-user-graduate';
}

function getLeagueColor(league) {
  const colors = {
    'legendary': '#ffd700',
    'professional': '#c0c0c0',
    'beginner': '#cd7f32',
    'training': '#4f46e5'
  };
  return colors[league] || '#4f46e5';
}

function calculateLeagueProgress() {
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡ Ù„ÛŒÚ¯ Ø¨Ø¹Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡
  const nextLeagueThreshold = getNextLeagueThreshold();
  if (!nextLeagueThreshold) return 100;
  
  const progress = (userStats.weeklyHours / nextLeagueThreshold) * 100;
  return Math.min(100, Math.round(progress));
}

function getNextLeagueThreshold() {
  // Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÚ¯â€ŒÙ‡Ø§
  const thresholds = {
    'training': 30,
    'beginner': 40,
    'professional': 50,
    'legendary': null // Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ù„ÛŒÚ¯
  };
  
  return thresholds[userStats.league];
}

function renderBadges() {
  const container = document.getElementById('badges-container');
  container.innerHTML = '';
  
  if (userStats.badges.length === 0) {
    container.innerHTML = '<div class="text-slate-400 text-center py-4">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù†Ø´Ø§Ù†â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</div>';
    return;
  }
  
  userStats.badges.forEach(badge => {
    const badgeEl = document.createElement('div');
    badgeEl.className = 'badge bg-green-500 text-white';
    badgeEl.title = badge.description;
    
    badgeEl.innerHTML = `
      <i class="fas ${badge.icon} badge-icon"></i>
      <span>${badge.name}</span>
    `;
    
    container.appendChild(badgeEl);
  });
}

function renderAchievements() {
  const container = document.getElementById('league-rankings');
  container.innerHTML = '';
  
  const achievements = [
    {
      title: 'ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
      value: userStats.completedTasks,
      target: 100,
      icon: 'fa-check-circle',
      color: '#10b981'
    },
    {
      title: 'Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡',
      value: userStats.streak,
      target: 30,
      icon: 'fa-fire',
      color: '#f59e0b'
    },
    {
      title: 'Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù‡ÙØªÙ‡',
      value: userStats.weeklyHours,
      target: 50,
      icon: 'fa-clock',
      color: '#4f46e5'
    },
    {
      title: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡',
      value: userStats.dailyHours,
      target: 7,
      icon: 'fa-chart-line',
      color: '#8b5cf6'
    }
  ];
  
  achievements.forEach(achievement => {
    const progress = Math.min(100, (achievement.value / achievement.target) * 100);
    
    const achievementEl = document.createElement('div');
    achievementEl.className = 'ranking-card';
    
    achievementEl.innerHTML = `
      <div class="ranking-avatar" style="background: ${achievement.color}">
        <i class="fas ${achievement.icon}"></i>
      </div>
      <div class="ranking-info">
        <div class="ranking-name">${achievement.title}</div>
        <div class="ranking-stats">${achievement.value.toFixed(1)} Ø§Ø² ${achievement.target}</div>
        <div class="league-progress mt-2">
          <div class="league-progress-bar" style="width: ${progress}%; background: ${achievement.color}"></div>
        </div>
      </div>
      <div class="ranking-position">${Math.round(progress)}%</div>
    `;
    
    container.appendChild(achievementEl);
  });
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…
   --------------------------- */
function initTheme() {
  document.documentElement.setAttribute('data-theme', currentTheme);
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

function toggleTheme() {
  if (currentTheme === 'dark') {
    currentTheme = 'light';
  } else {
    currentTheme = 'dark';
  }
  
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('plannerTheme', currentTheme);
  
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
   --------------------------- */
function setupReminders() {
  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
  reminderTimeouts.forEach(timeout => clearTimeout(timeout));
  reminderTimeouts = [];

  const now = new Date();
  
  tasks.forEach(task => {
    if (task.completed || !task.startTime || !task.dueDate) return;
    
    // ØªØ±Ú©ÛŒØ¨ ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
    const startDateTime = new Date(`${task.dueDate}T${task.startTime}`);
    
    // Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³ØªØŒ Ø§Ø² Ø¢Ù† ØµØ±Ù Ù†Ø¸Ø± Ú©Ù†
    if (startDateTime <= now) return;
    
    // ØªÙ†Ø¸ÛŒÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§ØµÙ„ÛŒ
    const timeUntilStart = startDateTime - now;
    if (timeUntilStart > 0) {
      const timeout = setTimeout(() => {
        showNotification('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªØ³Ú©', `Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ ØªØ³Ú© "${task.title}" ÙØ±Ø§ Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.`);
        playNotificationSound();
      }, timeUntilStart);
      
      reminderTimeouts.push(timeout);
    }
    
    // ØªÙ†Ø¸ÛŒÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø²ÙˆØ¯ØªØ± Ø§Ø² Ù…ÙˆØ¹Ø¯ (Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
    if (task.reminder && task.reminder !== 'none') {
      const reminderMinutes = parseInt(task.reminder);
      const reminderTime = startDateTime - (reminderMinutes * 60 * 1000);
      const timeUntilReminder = reminderTime - now;
      
      if (timeUntilReminder > 0) {
        const reminderTimeout = setTimeout(() => {
          showNotification('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªØ³Ú©', `ØªØ³Ú© "${task.title}" Ø¯Ø± ${reminderMinutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`);
          playNotificationSound();
        }, timeUntilReminder);
        
        reminderTimeouts.push(reminderTimeout);
      }
    }
  });
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
   --------------------------- */
function showNotification(title, message) {
  const notification = document.getElementById('notification');
  const notificationTitle = document.getElementById('notification-title');
  const notificationMessage = document.getElementById('notification-message');
  
  notificationTitle.textContent = title;
  notificationMessage.textContent = message;
  
  notification.classList.add('show');
  
  // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø±ÙˆØ±Ú¯Ø±
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body: message, icon: '/favicon.ico' });
  }
  
  // Ù¾Ø®Ø´ ØµØ¯Ø§
  playNotificationSound();
  
  // Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
  setTimeout(() => {
    hideNotification();
  }, 5000);
}

function hideNotification() {
  const notification = document.getElementById('notification');
  notification.classList.remove('show');
}

function playNotificationSound() {
  // Ø§ÛŒØ¬Ø§Ø¯ ØµØ¯Ø§ Ø¨Ø§ Web Audio API
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.value = 800;
    gainNode.gain.value = 0.1;
    
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
    oscillator.stop(audioContext.currentTime + 1);
  } catch (e) {
    console.log('ØµØ¯Ø§ Ù¾Ø®Ø´ Ù†Ø´Ø¯:', e);
  }
}

/* ---------------------------
   Helpers
   --------------------------- */
function getCategoryName(id){ 
  if (!id || id === 'general') return 'Ø¹Ù…ÙˆÙ…ÛŒ';
  const l = lists.find(x=>x.id===id); 
  return l ? l.name : 'Ø¹Ù…ÙˆÙ…ÛŒ'; 
}
function getCategoryIcon(id){ const map = { math:'fa-book', science:'fa-flask', english:'fa-language', history:'fa-history', shopping:'fa-shopping-cart', home:'fa-home' }; return map[id] || 'fa-list'; }
function getCategoryColor(id){ const l = lists.find(x=>x.id===id); return l ? l.color : '#6b7280'; }
function formatShort(dateStr){ if(!dateStr) return 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'; try { return new Date(dateStr).toLocaleDateString('fa-IR'); } catch(e){ return dateStr; } }

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
function formatTimeForDisplay(hours) {
  if (hours < 1) {
    const minutes = Math.round(hours * 60);
    return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
  } else if (hours === Math.floor(hours)) {
    return `${hours} Ø³Ø§Ø¹Øª`;
  } else {
    const wholeHours = Math.floor(hours);
    const minutes = Math.round((hours - wholeHours) * 60);
    if (wholeHours === 0) {
      return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
    } else {
      return `${wholeHours} Ø³Ø§Ø¹Øª Ùˆ ${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
function formatStartTime(task) {
  if (!task.startTime) return '';
  
  const now = new Date();
  const today = todayISO();
  const taskDate = task.dueDate || today;
  
  if (taskDate === today) {
    const [hours, minutes] = task.startTime.split(':');
    const taskTime = new Date();
    taskTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    
    if (taskTime > now) {
      return `<span class="task-time-badge upcoming"><i class="fas fa-clock ml-1"></i>Ø§Ù…Ø±ÙˆØ² ${task.startTime}</span>`;
    } else {
      return `<span class="task-time-badge past"><i class="fas fa-clock ml-1"></i>Ø§Ù…Ø±ÙˆØ² ${task.startTime}</span>`;
    }
  } else {
    return `<span class="task-time-badge"><i class="fas fa-clock ml-1"></i>${formatShort(taskDate)} ${task.startTime}</span>`;
  }
}

/* ---------------------------
   ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†
   --------------------------- */
function getTimeCategory(endTime) {
  if (!endTime) return 'no-time';
  
  const [hours, minutes] = endTime.split(':').map(Number);
  const totalMinutes = hours * 60 + minutes;
  
  // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†
  if (totalMinutes < 600) { // Ù‚Ø¨Ù„ Ø§Ø² 10:00
    return 'morning';
  } else if (totalMinutes < 840) { // Ù‚Ø¨Ù„ Ø§Ø² 14:00
    return 'noon';
  } else if (totalMinutes < 1080) { // Ù‚Ø¨Ù„ Ø§Ø² 18:00
    return 'afternoon';
  } else if (totalMinutes < 1320) { // Ù‚Ø¨Ù„ Ø§Ø² 22:00
    return 'evening';
  } else { // Ù‚Ø¨Ù„ Ø§Ø² 2:00 Ø±ÙˆØ² Ø¨Ø¹Ø¯
    return 'midnight';
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ùˆ Ù…Ø¯Øª Ù…Ø·Ø§Ù„Ø¹Ù‡
function calculateEndTime(startTime, studyTime) {
  if (!startTime || !studyTime) return '';
  
  const [hours, minutes] = startTime.split(':').map(Number);
  const totalMinutes = hours * 60 + minutes + (studyTime * 60);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¬Ø¯ÛŒØ¯
  let newHours = Math.floor(totalMinutes / 60) % 24;
  const newMinutes = totalMinutes % 60;
  
  // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø¨Ù‡ ÙØ±Ù…Øª HH:MM
  return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
}

/* ---------------------------
   Improved startOfWeek function
   --------------------------- */
function startOfWeek(refDate, offsetWeeks = 0) {
  const d = new Date(refDate);
  // ØªÙ†Ø¸ÛŒÙ… Ø¨Ù‡ Ø´Ø±ÙˆØ¹ Ù‡ÙØªÙ‡ (Ø´Ù†Ø¨Ù‡)
  let day = d.getDay(); // 0=ÛŒÚ©Ø´Ù†Ø¨Ù‡, 1=Ø¯ÙˆØ´Ù†Ø¨Ù‡, ..., 6=Ø´Ù†Ø¨Ù‡
  // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªÙ‚ÙˆÛŒÙ… Ø§ÛŒØ±Ø§Ù†ÛŒ: Ø´Ù†Ø¨Ù‡=0, ÛŒÚ©Ø´Ù†Ø¨Ù‡=1, ..., Ø¬Ù…Ø¹Ù‡=6
  let iranDay = (day) % 7;
  
  const start = new Date(d);
  start.setDate(d.getDate() - iranDay + (offsetWeeks * 7));
  start.setHours(0, 0, 0, 0);
  return start;
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
function getCurrentWeekDates(offsetWeeks = 0) {
  const start = startOfWeek(new Date(), offsetWeeks);
  const dates = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    dates.push(isoDate(date));
  }
  return dates;
}

/* ---------------------------
   Render sidebar lists (with 3-dot menu for edit/delete)
   --------------------------- */
function renderSidebarLists(){
  const studyEl = document.getElementById('study-lists');
  const personalEl = document.getElementById('personal-lists');
  studyEl.innerHTML = '';
  personalEl.innerHTML = '';

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ù‡ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
  const generalTasksCount = tasks.filter(t => !t.completed && (!t.category || t.category === '')).length;
  const generalCompletedCount = tasks.filter(t => t.completed && (!t.category || t.category === '')).length;
  
  const generalEl = document.createElement('div');
  generalEl.style.display = "flex"
  generalEl.className = 'list-item';
  generalEl.dataset.category = 'general';
  generalEl.innerHTML = `
    <div class="list-item-content">
      <i class="fas fa-list ml-3" style="color:#6b7280"></i>
      <span>Ø¹Ù…ÙˆÙ…ÛŒ</span>
      <span class="list-count">${generalTasksCount}</span>
    </div>
    <div class="flex items-center gap-1">
      <span class="text-xs text-green-400">${generalCompletedCount}</span>
    </div>
  `;
  
  generalEl.addEventListener('click', () => { setActiveView('category', 'general'); });
  studyEl.appendChild(generalEl);

  // Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
  lists.forEach(l => {
    const tasksCount = tasks.filter(t => !t.completed && t.category === l.id).length;
    const completedCount = tasks.filter(t => t.completed && t.category === l.id).length;
    
    const el = document.createElement('div');
    el.style.display = "flex"
    el.className = 'list-item';
    el.dataset.category = l.id;

    // left content
    const left = document.createElement('div');
    left.className = 'list-item-content';
    left.innerHTML = `<i class="fas ${getCategoryIcon(l.id)} ml-3" style="color:${l.color}"></i><span>${l.name}</span><span class="list-count">${tasksCount}</span>`;

    // controls (three-dot)
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.className = 'list-controls';
    controls.innerHTML = `
      <button class="list-menu-btn" title="Ø¨ÛŒØ´ØªØ±"><i class="fas fa-ellipsis-v"></i></button>
      <div class="list-menu" style="margin-top:-30px;">
        <button class="edit-list">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="delete-list text-red-400">Ø­Ø°Ù</button>
      </div>
    `;

    // completed count
    const completedDiv = document.createElement('div');
    completedDiv.className = 'flex items-center gap-1 ml-3';
    completedDiv.innerHTML = `<span class="text-xs text-green-400">${completedCount}</span>`;

    el.appendChild(left);
    el.appendChild(completedDiv);
    el.appendChild(controls);

    // click on list -> set category view
    left.addEventListener('click', () => { setActiveView('category', l.id); });

    // edit
    controls.querySelector('.edit-list').addEventListener('click', (e) => {
      e.stopPropagation();
      openListModal(l.id);
    });

    // delete
    controls.querySelector('.delete-list').addEventListener('click', (e) => {
      e.stopPropagation();
      if(!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù„ÛŒØ³Øª "${l.name}" Ùˆ ØªÙ…Ø§Ù… ØªØ³Ú©â€ŒÙ‡Ø§ÛŒØ´ Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ`)) return;
      tasks = tasks.filter(t => t.category !== l.id);
      lists = lists.filter(x => x.id !== l.id);
      saveAll();
      renderSidebarLists();
      updateStats();
      updateSidebarCounts();
      if(currentView === 'category' && currentCategory === l.id) { setActiveView('inbox'); }
      renderAll();
      updateStats();
      updateSidebarCounts();
    });

    // append: decide whether study or personal
    if(['shopping','home'].includes(l.id)) personalEl.appendChild(el); 
    else studyEl.appendChild(el);
  });

  // If no lists, show helpful message
  if(lists.length === 0){
    personalEl.innerHTML = '<div class="muted text-slate-400 text-sm">Ù‡ÛŒÚ† Ù„ÛŒØ³Øª Ø´Ø®ØµÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
  }
}

/* ---------------------------
   Render tasks with time categories
   --------------------------- */
function renderTasks(){
  const taskList = document.getElementById('task-list');
  const completedListEl = document.getElementById('completed-tasks-list');
  taskList.innerHTML = '';
  if(completedListEl) completedListEl.innerHTML = '';

  let filtered = tasks.slice();
  const today = todayISO();

  if(currentView === 'today') filtered = filtered.filter(t => t.dueDate === today);
  else if(currentView === 'week'){
    const weekDates = getCurrentWeekDates(currentWeek);
    filtered = filtered.filter(t => t.dueDate && weekDates.includes(t.dueDate));
  } else if(currentView === 'important') filtered = filtered.filter(t => t.important);
  else if(currentView === 'category' && currentCategory) {
    if (currentCategory === 'general') {
      filtered = filtered.filter(t => !t.category || t.category === '');
    } else {
      filtered = filtered.filter(t => t.category === currentCategory);
    }
  }

  // search
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  if(q) filtered = filtered.filter(t => (t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q));

  const active = filtered.filter(t => !t.completed);
  const completed = filtered.filter(t => t.completed);

  // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ
  const timeCategories = {
    morning: { name: 'ØµØ¨Ø­', icon: 'fa-sun', tasks: [] },
    noon: { name: 'Ø¸Ù‡Ø±', icon: 'fa-cloud-sun', tasks: [] },
    afternoon: { name: 'ØºØ±ÙˆØ¨', icon: 'fa-sun', tasks: [] },
    evening: { name: 'Ø´Ø¨', icon: 'fa-moon', tasks: [] },
    midnight: { name: 'Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨', icon: 'fa-star', tasks: [] },
    'no-time': { name: 'Ø¨Ø¯ÙˆÙ† Ø²Ù…Ø§Ù†', icon: 'fa-clock', tasks: [] }
  };

  // Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
  active.forEach(task => {
    // Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø² Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ùˆ Ù…Ø¯Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†
    let endTime = task.startTime;
    if (!endTime && task.startTime && task.studyTime) {
      endTime = calculateEndTime(task.startTime, task.studyTime);
    }
    
    const timeCategory = getTimeCategory(endTime);
    timeCategories[timeCategory].tasks.push(task);
  });

  // Ù†Ù…Ø§ÛŒØ´ ØªØ³Ú©â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ
  if(active.length === 0) {
    taskList.innerHTML = '<div class="text-slate-400 py-4 text-center">Ù‡ÛŒÚ† ØªØ³Ú©ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
  } else {
    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ù…Ø´Ø®Øµ
    const categoryOrder = ['morning', 'noon', 'afternoon', 'evening', 'midnight', 'no-time'];
    
    categoryOrder.forEach(categoryKey => {
      const category = timeCategories[categoryKey];
      if (category.tasks.length > 0) {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'time-category expanded';
        categoryEl.innerHTML = `
          <div class="time-category-header">
            <div class="time-category-title">
              <i class="fas ${category.icon} time-category-icon"></i>
              <span>${category.name}</span>
              <span class="time-category-count">${category.tasks.length}</span>
            </div>
          </div>
          <div class="time-category-content"></div>
        `;
        
        const contentEl = categoryEl.querySelector('.time-category-content');
        
        category.tasks.forEach(t => {
          const el = document.createElement('div');
          el.className = 'task-item';
          el.draggable = true;
          el.dataset.taskId = t.id;
          el.innerHTML = `
            <div class="flex items-center gap-3 left">
              <div class="task-checkbox ${t.completed ? 'checked' : ''}"></div>
              <div>
                <div class="task-title ${t.completed ? 'completed' : ''}">${t.title}</div>
                <div class="text-slate-400 text-xs mt-1 flex items-center gap-2">
                  ${formatShort(t.dueDate)} 
                  ${t.startTime ? 'â€¢ ' + formatStartTime(t) : ''}
                  ${t.endTime ? `â€¢ Ù¾Ø§ÛŒØ§Ù†: ${t.endTime}` : ''}
                  â€¢ ${getCategoryName(t.category)} 
                  â€¢ ${formatTimeForDisplay(t.studyTime||0)}
                </div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <i class="fas fa-star ${t.important ? 'text-yellow-400' : 'text-slate-400'} ml-3 cursor-pointer star"></i>
              <i class="fas fa-pen text-sky-400 cursor-pointer edit"></i>
              <i class="fas fa-trash text-slate-400 cursor-pointer delete-task"></i>
            </div>
          `;
          // events
          el.querySelector('.task-checkbox').addEventListener('click', ()=> toggleTaskCompletion(t.id));
          el.querySelector('.star').addEventListener('click', ()=> toggleTaskImportance(t.id));
          el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('Ø­Ø°ÙØŸ')) deleteTask(t.id); });
          el.querySelector('.edit').addEventListener('click', ()=> openTaskModal(t.id));

          // drag
          el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); el.classList.add('dragging'); });
          el.addEventListener('dragend', () => el.classList.remove('dragging'));

          contentEl.appendChild(el);
        });
        
        // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
        categoryEl.querySelector('.time-category-header').addEventListener('click', () => {
          categoryEl.classList.toggle('expanded');
        });
        
        taskList.appendChild(categoryEl);
      }
    });
  }

  // completed
  document.getElementById('completed-count').textContent = completed.length;
  completed.forEach(t => {
    const el = document.createElement('div');
    el.className = 'task-item';
    el.innerHTML = `
      <div class="flex items-center gap-3 left">
        <div class="task-checkbox checked"></div>
        <div>
          <div class="task-title completed">${t.title}</div>
          <div class="text-slate-400 text-xs mt-1">${formatShort(t.dueDate)} Â· ${getCategoryName(t.category)} Â· ${formatTimeForDisplay(t.studyTime||0)}</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fas fa-undo text-sky-400 cursor-pointer undo"></i>
        <i class="fas fa-trash text-slate-400 cursor-pointer delete-task"></i>
      </div>
    `;
    el.querySelector('.undo').addEventListener('click', ()=> toggleTaskCompletion(t.id));
    el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('Ø­Ø°ÙØŸ')) deleteTask(t.id); });
    if(completedListEl) completedListEl.appendChild(el);
  });

  updateSidebarCounts();
}

/* ---------------------------
   Weekly planner + drag/drop
   --------------------------- */
function renderWeeklyPlanner(){
  const container = document.getElementById('week-days');
  container.innerHTML = '';
  const start = startOfWeek(new Date(), currentWeek);
  const days = ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'];
  const today = todayISO();

  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const key = isoDate(d);
    const cell = document.createElement('div');
    cell.className = 'day-cell' + (key === today ? ' today' : '');
    cell.dataset.date = key;
    cell.innerHTML = `<div class="font-semibold">${days[i]}<br/><span class="text-slate-400 text-sm">${formatShort(key)}</span></div>`;

    // tasks for that date
    tasks.filter(t => t.dueDate === key && !t.completed).forEach(t => {
      const dt = document.createElement('div');
      dt.className = 'day-task';
      dt.draggable = true;
      dt.dataset.taskId = t.id;
      dt.innerHTML = `<div style="flex:1">${t.title} ${t.startTime ? `<small class="text-xs text-slate-400">(${t.startTime})</small>` : ''}</div><div class="delete-task-btn"><i class="fas fa-times"></i></div>`;

      // delete button
      dt.querySelector('.delete-task-btn').addEventListener('click', (e) => { e.stopPropagation(); if(confirm('Ø­Ø°ÙØŸ')) deleteTask(t.id); });
      // drag
      dt.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); dt.classList.add('dragging'); });
      dt.addEventListener('dragend', () => dt.classList.remove('dragging'));
      cell.appendChild(dt);
    });

    // allow drop
    cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drop-active'); });
    cell.addEventListener('dragleave', () => cell.classList.remove('drop-active'));
    cell.addEventListener('drop', (e) => {
      e.preventDefault(); cell.classList.remove('drop-active');
      const id = e.dataTransfer.getData('text/plain'); if(!id) return;
      const t = tasks.find(x=>x.id===id); if(!t) return;
      t.dueDate = cell.dataset.date; saveAll(); renderTasks(); renderWeeklyPlanner(); renderCharts(); updateStats();
      setupReminders(); // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
    });

    container.appendChild(cell);
  }

  // week title
  const end = new Date(start); end.setDate(start.getDate()+6);
  document.getElementById('current-week').textContent = `${formatShort(start.toISOString().split('T')[0])} â€” ${formatShort(end.toISOString().split('T')[0])}`;
}

/* ---------------------------
   Charts (use tasks, support fractional >1)
   --------------------------- */
let studyChart = null, progressChart = null;

function computeStudyByDateForCurrentWeek(){
  const weekDates = getCurrentWeekDates(currentWeek);
  const map = {};
  weekDates.forEach(date => { map[date] = 0; });
  
  tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate)).forEach(t => {
    const v = parseFloat(t.studyTime) || 0;
    map[t.dueDate] = (map[t.dueDate] || 0) + v;
  });
  
  return { dates: weekDates, data: weekDates.map(date => map[date] || 0) };
}

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡Ø± Ø¯Ø±Ø³ Ø¯Ø± Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
function computeStudyTimeByCategoryForCurrentWeek(){
  const weekDates = getCurrentWeekDates(currentWeek);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù„ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  const totalStudyTime = tasks
    .filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø± Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  const categoryStudy = {};
  
  // Ø¯Ø³ØªÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  const generalTime = tasks
    .filter(t => t.completed && (!t.category || t.category === '') && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  if (generalTime > 0 || totalStudyTime === 0) {
    categoryStudy['Ø¹Ù…ÙˆÙ…ÛŒ'] = {
      time: generalTime,
      percentage: totalStudyTime > 0 ? (generalTime / totalStudyTime * 100) : 0
    };
  }
  
  // Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ Ø¯Ø± Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  lists.forEach(list => {
    const categoryTime = tasks
      .filter(t => t.completed && t.category === list.id && t.dueDate && weekDates.includes(t.dueDate))
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
    
    if (categoryTime > 0) {
      categoryStudy[list.name] = {
        time: categoryTime,
        percentage: totalStudyTime > 0 ? (categoryTime / totalStudyTime * 100) : 0
      };
    }
  });
  
  return {
    categories: Object.keys(categoryStudy),
    percentages: Object.values(categoryStudy).map(item => Math.round(item.percentage)),
    times: Object.values(categoryStudy).map(item => item.time),
    totalStudyTime: totalStudyTime
  };
}

function renderCharts(){
  // Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ
  const weekData = computeStudyByDateForCurrentWeek();
  const labels = weekData.dates.map(date => formatShort(date));
  const data = weekData.data;
  const maxVal = Math.max(1, ...data);
  const suggestedMax = Math.ceil(maxVal + 0.5);

  const ctx1 = document.getElementById('studyTimeChart').getContext('2d');
  if(studyChart) studyChart.destroy();
  studyChart = new Chart(ctx1, {
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label:'Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡', 
        data, 
        backgroundColor:'rgba(79,70,229,0.8)',
        borderColor: 'rgba(79,70,229,1)',
        borderWidth: 1
      }] 
    },
    options:{ 
      responsive:true, 
      scales:{ 
        y:{ 
          beginAtZero:true, 
          max:suggestedMax, 
          ticks:{ stepSize:0.5 }, 
          title:{display:true,text:'Ø³Ø§Ø¹Øª'} 
        } 
      } 
    }
  });

  // Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ÛŒ (Ø¯Ø±ØµØ¯ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡Ø± Ø¯Ø±Ø³ Ø¯Ø± Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ)
  const categoryData = computeStudyTimeByCategoryForCurrentWeek();
  
  // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ ÛŒÚ© Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
  const displayCategories = categoryData.categories.length > 0 ? categoryData.categories : ['Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'];
  const displayPercentages = categoryData.percentages.length > 0 ? categoryData.percentages : [100];

  const ctx2 = document.getElementById('progressChart').getContext('2d');
  if(progressChart) progressChart.destroy();
  progressChart = new Chart(ctx2, {
    type:'line',
    data:{ 
      labels: displayCategories, 
      datasets:[{ 
        label:'Ø¯Ø±ØµØ¯ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù‡ÙØªÙ‡', 
        data: displayPercentages, 
        borderColor:'rgba(16,185,129,1)', 
        backgroundColor:'rgba(16,185,129,0.12)', 
        tension:0.3, 
        fill:true,
        pointBackgroundColor: 'rgba(16,185,129,1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }] 
    },
    options:{ 
      responsive:true, 
      scales:{ 
        y:{ 
          min:0, 
          max:100, 
          title:{display:true,text:'Ø¯Ø±ØµØ¯'},
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              if (categoryData.categories.length === 0) {
                return 'Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯';
              }
              const label = context.label || '';
              const value = context.raw || 0;
              const index = context.dataIndex;
              const hours = categoryData.times[index] || 0;
              return `${label}: ${value}% (${hours.toFixed(1)} Ø³Ø§Ø¹Øª)`;
            },
            afterLabel: function(context) {
              if (categoryData.categories.length > 0) {
                return `Ú©Ù„ Ø²Ù…Ø§Ù† Ù‡ÙØªÙ‡: ${categoryData.totalStudyTime.toFixed(1)} Ø³Ø§Ø¹Øª`;
              }
            }
          }
        }
      }
    }
  });
}

/* ---------------------------
   Stats & sidebar counts
   --------------------------- */
function updateStats(){
  const weekDates = getCurrentWeekDates(currentWeek);
  const total = tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
                    .reduce((s,t)=> s + (parseFloat(t.studyTime)||0), 0);
  const done = tasks.filter(t=>t.completed).length;
  const prod = tasks.length ? Math.round(done / tasks.length * 100) : 0;
  document.getElementById('total-study-time').textContent = total.toFixed(1);
  document.getElementById('completed-tasks').textContent = done;
  document.getElementById('productivity-score').textContent = prod + '%';
}

function updateSidebarCounts(){
  const today = todayISO();
  const weekLater = new Date(); weekLater.setDate(weekLater.getDate()+7); const weekLaterStr = weekLater.toISOString().split('T')[0];
  document.getElementById('inbox-count').textContent = tasks.filter(t => !t.completed).length;
  document.getElementById('today-count').textContent = tasks.filter(t => t.dueDate === today && !t.completed).length;
  document.getElementById('week-count').textContent = tasks.filter(t => t.dueDate && t.dueDate >= today && t.dueDate <= weekLaterStr && !t.completed).length;
  document.getElementById('important-count').textContent = tasks.filter(t => t.important && !t.completed).length;

  // list counts
  lists.forEach(l => {
    const el = document.querySelector(`#study-lists [data-category="${l.id}"] .list-count`) || document.querySelector(`#personal-lists [data-category="${l.id}"] .list-count`);
    if(el) el.textContent = tasks.filter(t => t.category === l.id && !t.completed).length;
  });
}

/* ---------------------------
   Task actions
   --------------------------- */
function toggleTaskCompletion(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  t.completed = !t.completed;
  if(t.completed && !t.dueDate) t.dueDate = todayISO();
  saveAll(); 
  renderTasks(); 
  renderWeeklyPlanner(); 
  renderCharts(); 
  updateStats();
  setupReminders(); // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯
  updateUserStats();
  if (currentView === 'league') {
    renderLeagueView();
  }
}
function toggleTaskImportance(id){ const t = tasks.find(x=>x.id===id); if(!t) return; t.important = !t.important; saveAll(); renderTasks(); updateSidebarCounts(); }
function deleteTask(id){ 
  tasks = tasks.filter(t=>t.id!==id); 
  saveAll(); 
  renderTasks(); 
  renderWeeklyPlanner(); 
  renderCharts(); 
  updateStats();
  setupReminders(); // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
}

function openTaskModal(taskId=null){
  editingTaskId = taskId;
  populateCategorySelect();
  
  if(taskId){
    const t = tasks.find(x=>x.id===taskId); 
    if(!t) return;
    
    document.getElementById('taskModalTitle').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ³Ú©';
    document.getElementById('taskTitleInput').value = t.title;
    document.getElementById('taskDescriptionInput').value = t.description || '';
    document.getElementById('taskDueDateInput').value = t.dueDate || '';
    document.getElementById('taskStartTimeInput').value = t.startTime || '';
    document.getElementById('taskEndTimeInput').value = t.endTime || '';
    document.getElementById('taskReminderInput').value = t.reminder || 'none';
    document.getElementById('taskTimeCategoryInput').value = t.timeCategory || '';
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† - Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
    if (t.studyTime && t.studyTime < 1) {
      // Ø§Ú¯Ø± Ú©Ù…ØªØ± Ø§Ø² 1 Ø³Ø§Ø¹Øª Ø§Ø³ØªØŒ Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
      document.getElementById('taskStudyTimeInput').value = Math.round(t.studyTime * 60);
      document.getElementById('taskTimeUnitInput').value = 'minutes';
    } else {
      document.getElementById('taskStudyTimeInput').value = t.studyTime || 1;
      document.getElementById('taskTimeUnitInput').value = 'hours';
    }
    
    document.getElementById('taskCategoryInput').value = t.category || '';
  } else {
    document.getElementById('taskModalTitle').textContent = 'Ø§ÛŒØ¬Ø§Ø¯ ØªØ³Ú© Ø¬Ø¯ÛŒØ¯';
    document.getElementById('taskTitleInput').value = '';
    document.getElementById('taskDescriptionInput').value = '';
    document.getElementById('taskDueDateInput').value = '';
    document.getElementById('taskStartTimeInput').value = '';
    document.getElementById('taskEndTimeInput').value = '';
    document.getElementById('taskReminderInput').value = 'none';
    document.getElementById('taskTimeCategoryInput').value = '';
    document.getElementById('taskStudyTimeInput').value = 1;
    document.getElementById('taskTimeUnitInput').value = 'hours';
    document.getElementById('taskCategoryInput').value = lists[0] ? lists[0].id : '';
  }
  document.getElementById('taskModal').style.display = 'flex';
}

function saveTaskFromModal(){
  const title = document.getElementById('taskTitleInput').value.trim();
  if(!title){ alert('Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const desc = document.getElementById('taskDescriptionInput').value.trim();
  const dueDate = document.getElementById('taskDueDateInput').value || null;
  const startTime = document.getElementById('taskStartTimeInput').value || null;
  const endTime = document.getElementById('taskEndTimeInput').value || null;
  const reminder = document.getElementById('taskReminderInput').value || 'none';
  const timeCategory = document.getElementById('taskTimeCategoryInput').value || '';
  
  // Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù†
  const timeValue = parseFloat(document.getElementById('taskStudyTimeInput').value) || 0;
  const timeUnit = document.getElementById('taskTimeUnitInput').value;
  let studyTime = timeValue;
  
  if (timeUnit === 'minutes') {
    studyTime = timeValue / 60; // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ Ø³Ø§Ø¹Øª
  }
  
  const category = document.getElementById('taskCategoryInput').value || '';

  if(editingTaskId){
    const t = tasks.find(x=>x.id===editingTaskId); if(!t) return;
    t.title = title; 
    t.description = desc; 
    t.dueDate = dueDate; 
    t.startTime = startTime;
    t.endTime = endTime;
    t.reminder = reminder;
    t.timeCategory = timeCategory;
    t.studyTime = studyTime; 
    t.category = category;
    editingTaskId = null;
  } else {
    tasks.push({ 
      id: genId(), 
      title, 
      description: desc, 
      completed:false, 
      important:false, 
      category, 
      dueDate, 
      startTime,
      endTime,
      reminder,
      timeCategory,
      studyTime, 
      createdAt: new Date().toISOString() 
    });
  }
  saveAll(); 
  closeModal('taskModal'); 
  renderTasks(); 
  renderWeeklyPlanner(); 
  renderCharts(); 
  updateStats(); 
  updateSidebarCounts();
  setupReminders(); // ØªÙ†Ø¸ÛŒÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
}

/* ---------------------------
   List actions (create & edit via modal)
   --------------------------- */
function openListModal(listId = null){
  editingListId = listId;
  document.getElementById('listModalTitle').textContent = listId ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ³Øª' : 'Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯';
  if(listId){
    const l = lists.find(x=>x.id===listId);
    if(!l) return;
    document.getElementById('listNameInput').value = l.name;
    document.getElementById('listColorInput').value = l.color || '#4f46e5';
  } else {
    document.getElementById('listNameInput').value = '';
    document.getElementById('listColorInput').value = '#4f46e5';
  }
  document.getElementById('listModal').style.display = 'flex';
}

function updateCurrentListTitle() {
  const titleEl = document.getElementById('current-list-title');
  if (currentView === 'category' && currentCategory === 'general') {
    titleEl.textContent = 'Ø¹Ù…ÙˆÙ…ÛŒ';
  } else if (currentView === 'category' && currentCategory) {
    const list = lists.find(l => l.id === currentCategory);
    titleEl.textContent = list ? list.name : 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ';
  } else if (currentView === 'league') {
    titleEl.textContent = 'Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ';
  } else {
    const viewTitles = {
      'inbox': 'ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ',
      'today': 'Ø§Ù…Ø±ÙˆØ²', 
      'week': 'Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ',
      'important': 'Ù…Ù‡Ù…'
    };
    titleEl.textContent = viewTitles[currentView] || 'ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ';
  }
}

function saveListFromModal(){
  const name = document.getElementById('listNameInput').value.trim();
  const color = document.getElementById('listColorInput').value || '#4f46e5';
  if(!name){ alert('Ù†Ø§Ù… Ù„ÛŒØ³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  if(editingListId){
    const l = lists.find(x=>x.id===editingListId); if(!l) return;
    l.name = name; l.color = color; editingListId = null;
  } else {
    lists.push({ id: genId(), name, color });
  }
  saveAll(); closeModal('listModal'); renderSidebarLists(); populateCategorySelect(); renderTasks(); renderCharts(); updateSidebarCounts();
}

/* ---------------------------
   UI helpers & wiring
   --------------------------- */
function populateCategorySelect(){
  const sel = document.getElementById('taskCategoryInput');
  sel.innerHTML = '';
  
  // add an empty/general option
  const opt0 = document.createElement('option'); 
  opt0.value = ''; 
  opt0.textContent = 'ğŸ¯ Ø¹Ù…ÙˆÙ…ÛŒ (Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡)'; 
  sel.appendChild(opt0);
  
  if (lists.length === 0) {
    const optInfo = document.createElement('option');
    optInfo.value = '';
    optInfo.textContent = 'ğŸ“ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù„ÛŒØ³Øª Ø¯Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯';
    optInfo.disabled = true;
    sel.appendChild(optInfo);
  } else {
    // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ Ùˆ Ø´Ø®ØµÛŒ
    const studyLists = lists.filter(l => !['shopping','home'].includes(l.id));
    const personalLists = lists.filter(l => ['shopping','home'].includes(l.id));
    
    if (studyLists.length > 0) {
      const optgroupStudy = document.createElement('optgroup');
      optgroupStudy.style.color = "black"
      optgroupStudy.label = 'ğŸ“š Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ';
      studyLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        
        // Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        const icons = {
          'math': 'ğŸ“Š',
          'science': 'ğŸ”¬', 
          'english': 'ğŸ”¤',
          'history': 'ğŸ“œ',
          'shopping': 'ğŸ›’',
          'home': 'ğŸ '
        };
        
        const icon = icons[l.id] || 'ğŸ“';
        o.textContent = `${icon} ${l.name}`;
        
        
        optgroupStudy.appendChild(o);
      });
      sel.appendChild(optgroupStudy);
    }
    
    if (personalLists.length > 0) {
      const optgroupPersonal = document.createElement('optgroup');
      optgroupPersonal.label = 'ğŸ  Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ';
      personalLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        
        const icons = {
          'shopping': 'ğŸ›’',
          'home': 'ğŸ '
        };
        
        const icon = icons[l.id] || 'ğŸ“';
        o.textContent = `${icon} ${l.name}`;
        o.style.color = l.color;
        
        optgroupPersonal.appendChild(o);
      });
      sel.appendChild(optgroupPersonal);
    }
  }
}

function setActiveView(view, category=''){
  currentView = view;
  if(view === 'category'){
    currentView = 'category';
    currentCategory = category;
  } else { 
    currentCategory = ''; 
  }
  
  // update active classes
  document.querySelectorAll('.list-item').forEach(x => x.classList.remove('active'));
  
  // mark sidebar view items
  if(view && view !== 'category'){
    const el = document.querySelector(`.list-item[data-view="${view}"]`);
    if(el) el.classList.add('active');
  } else if(view === 'category' && category){
    const el = document.querySelector(`.list-item[data-category="${category}"]`);
    if(el) el.classList.add('active');
  }
  
  // Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
  if (view === 'league') {
    document.getElementById('tasks-view').style.display = 'none';
    document.getElementById('league-view').style.display = 'block';
    renderLeagueView();
  } else {
    document.getElementById('tasks-view').style.display = 'block';
    document.getElementById('league-view').style.display = 'none';
    renderTasks();
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†ÙˆØ§Ù†
  updateCurrentListTitle();
}

function renderAll() {
  renderSidebarLists();
  renderTasks();
  renderWeeklyPlanner();
  renderCharts();
  updateStats();
  updateSidebarCounts();
  setupReminders(); // ØªÙ†Ø¸ÛŒÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
}

/* ---------------------------
   Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ
   --------------------------- */
function generateWeeklyReport() {
  const weekDates = getCurrentWeekDates(currentWeek);
  const completedTasks = tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate));
  
  // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† ØªØ³Ú©â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® (Ø§Ø² Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯)
  completedTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙØªÙ‡
  const start = startOfWeek(new Date(), currentWeek);
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  document.getElementById('report-week-range').textContent = 
    `Ù‡ÙØªÙ‡: ${formatShort(start.toISOString().split('T')[0])} ØªØ§ ${formatShort(end.toISOString().split('T')[0])}`;
  
  const now = new Date();
  document.getElementById('report-generation-date').textContent = 
    `ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: ${now.toLocaleDateString('fa-IR')} - ${now.toLocaleTimeString('fa-IR')}`;
  
  document.getElementById('report-footer-date').textContent = now.toLocaleDateString('fa-IR');

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±
  const totalTasks = completedTasks.length;
  const totalTime = completedTasks.reduce((sum, task) => sum + (task.studyTime || 0), 0);
  const avgTime = totalTasks > 0 ? (totalTime / 7).toFixed(1) : 0;

  document.getElementById('report-total-tasks').textContent = totalTasks;
  document.getElementById('report-total-time').textContent = totalTime.toFixed(1) + ' Ø³Ø§Ø¹Øª';
  document.getElementById('report-avg-time').textContent = avgTime + ' Ø³Ø§Ø¹Øª';

  // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ ØªØ³Ú©â€ŒÙ‡Ø§
  const tasksTable = document.getElementById('report-tasks-table');
  tasksTable.innerHTML = '';
  
  if (completedTasks.length === 0) {
    tasksTable.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
          Ù‡ÛŒÚ† ØªØ³Ú© ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù‡ÙØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
        </td>
      </tr>
    `;
  } else {
    // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
    const tasksByDate = {};
    completedTasks.forEach(task => {
      if (!tasksByDate[task.dueDate]) {
        tasksByDate[task.dueDate] = [];
      }
      tasksByDate[task.dueDate].push(task);
    });

    // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
    const sortedDates = Object.keys(tasksByDate).sort((a, b) => new Date(a) - new Date(b));
    
    let rowIndex = 1;
    
    sortedDates.forEach(date => {
      const dateTasks = tasksByDate[date];
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± ØªØ§Ø±ÛŒØ®
      const dateRow = document.createElement('tr');
      dateRow.style.background = '#e8f4fd';
      dateRow.innerHTML = `
        <td colspan="7" style="font-weight: bold; padding: 12px 8px; color: #4f46e5;">
          ğŸ“… ${formatShort(date)} - ${dateTasks.length} ØªØ³Ú©
        </td>
      `;
      tasksTable.appendChild(dateRow);
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ®
      dateTasks.forEach((task, taskIndex) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${rowIndex}</td>
          <td>${task.title}</td>
          <td>${getCategoryName(task.category)}</td>
          <td>${formatShort(task.dueDate)}</td>
          <td>${formatTimeForDisplay(task.studyTime || 0)}</td>
          <td>${task.important ? 'â­ Ù…Ù‡Ù…' : 'Ø¹Ø§Ø¯ÛŒ'}</td>
          <td>${task.description || '-'}</td>
        `;
        tasksTable.appendChild(row);
        rowIndex++;
      });
    });
  }

  // ØªÙˆØ²ÛŒØ¹ Ø²Ù…Ø§Ù†ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
  const timeDistribution = {};
  weekDates.forEach(date => {
    timeDistribution[date] = 0;
  });
  
  completedTasks.forEach(task => {
    timeDistribution[task.dueDate] += task.studyTime || 0;
  });

  const distributionContainer = document.querySelector('.print-summary:last-child div');
  if (distributionContainer) {
    distributionContainer.innerHTML = '';
    
    const days = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
    
    weekDates.forEach((date, index) => {
      const dayDiv = document.createElement('div');
      dayDiv.style.textAlign = 'center';
      dayDiv.style.padding = '8px';
      dayDiv.style.background = '#f8f9fa';
      dayDiv.style.borderRadius = '4px';
      
      dayDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 4px;">${days[index]}</div>
        <div style="color: #4f46e5; font-size: 11px;">${timeDistribution[date].toFixed(1)} Ø³Ø§Ø¹Øª</div>
      `;
      
      distributionContainer.appendChild(dayDiv);
    });
  }

  // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ùˆ Ù¾Ø±ÛŒÙ†Øª
  document.getElementById('printReport').style.display = 'block';
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      document.getElementById('printReport').style.display = 'none';
    }, 100);
  }, 500);
}

/* ---------------------------
   Event listeners init
   --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // initial rendering
  initTheme();
  renderAll();

  // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }

  // close notification
  document.getElementById('notification-close').addEventListener('click', hideNotification);

  // add list button
  document.getElementById('addListBtn').addEventListener('click', () => openListModal(null));
  document.getElementById('saveListBtn').addEventListener('click', () => {saveListFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelListBtn').addEventListener('click', () => { editingListId = null; closeModal('listModal'); });
  document.getElementById('listModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('listModal')) closeModal('listModal'); });

  // open task modal
  document.getElementById('openTaskModal').addEventListener('click', () => openTaskModal(null));
  document.getElementById('saveTaskBtn').addEventListener('click',() =>{ saveTaskFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelTaskBtn').addEventListener('click', () => { editingTaskId = null; closeModal('taskModal'); });
  document.getElementById('taskModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('taskModal')) { editingTaskId=null; closeModal('taskModal'); } });

  // quick add
  document.getElementById('new-task-input').addEventListener('keypress', function(e){
    if(e.key === 'Enter' && this.value.trim() !== ''){
      const title = this.value.trim();
      // default: no category
      tasks.push({ 
        id: genId(), 
        title, 
        description:'', 
        completed:false, 
        important:false, 
        category:'', 
        dueDate:null, 
        startTime: null,
        endTime: null,
        reminder: 'none',
        timeCategory: '',
        studyTime:1, 
        createdAt:new Date().toISOString() 
      });
      saveAll();
      this.value = '';
      renderTasks(); 
      renderWeeklyPlanner(); 
      renderCharts(); 
      updateStats(); 
      updateSidebarCounts();
      setupReminders();
    }
  });

  // search
  document.getElementById('searchInput').addEventListener('input', () => renderTasks());

  // view buttons
  document.getElementById('view-inbox').addEventListener('click', ()=> setActiveView('inbox'));
  document.getElementById('view-today').addEventListener('click', ()=> setActiveView('today'));
  document.getElementById('view-week').addEventListener('click', ()=> setActiveView('week'));
  document.getElementById('view-important').addEventListener('click', ()=> setActiveView('important'));
  document.getElementById('view-league').addEventListener('click', ()=> setActiveView('league'));

  // week nav
  document.getElementById('prev-week').addEventListener('click', ()=> { currentWeek--; renderWeeklyPlanner(); renderCharts(); updateStats(); });
  document.getElementById('next-week').addEventListener('click', ()=> { currentWeek++; renderWeeklyPlanner(); renderCharts(); updateStats(); });

  // event listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ§Ø­Ø¯ Ø²Ù…Ø§Ù†
  document.getElementById('taskTimeUnitInput').addEventListener('change', function() {
    const timeInput = document.getElementById('taskStudyTimeInput');
    const currentValue = parseFloat(timeInput.value) || 0;
    
    if (this.value === 'minutes') {
      timeInput.step = '5';
      timeInput.min = '0';
      timeInput.placeholder = 'Ø¯Ù‚ÛŒÙ‚Ù‡';
    } else {
      timeInput.step = '0.5';
      timeInput.min = '0';
      timeInput.placeholder = 'Ø³Ø§Ø¹Øª';
    }
  });

  // event listener Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†
  document.getElementById('taskStartTimeInput').addEventListener('change', function() {
    const startTime = this.value;
    const studyTime = parseFloat(document.getElementById('taskStudyTimeInput').value) || 0;
    const timeUnit = document.getElementById('taskTimeUnitInput').value;
    
    if (startTime && studyTime > 0) {
      let studyTimeHours = studyTime;
      if (timeUnit === 'minutes') {
        studyTimeHours = studyTime / 60;
      }
      
      const endTime = startTime
      document.getElementById('taskStartTimeInput').value = endTime;
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ
      const timeCategory = getTimeCategory(endTime);
      document.getElementById('taskTimeCategoryInput').value = timeCategory;
    }
  });

  // event listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡
  document.getElementById('taskStudyTimeInput').addEventListener('change', function() {
    const startTime = document.getElementById('taskStartTimeInput').value;
    const studyTime = parseFloat(this.value) || 0;
    const timeUnit = document.getElementById('taskTimeUnitInput').value;
    
    if (startTime && studyTime > 0) {
      let studyTimeHours = studyTime;
      if (timeUnit === 'minutes') {
        studyTimeHours = studyTime / 60;
      }
      
      const endTime = startTime
      document.getElementById('taskStartTimeInput').value = endTime;
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ
      const timeCategory = getTimeCategory(endTime);
      document.getElementById('taskTimeCategoryInput').value = timeCategory;
    }
  });

  // ØªØºÛŒÛŒØ± ØªÙ…
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ
  const printReportBtn = document.getElementById('printReportBtn');
  if (printReportBtn) {
    printReportBtn.addEventListener('click', generateWeeklyReport);
  }
});

/* ---------------------------
   Utilities
   --------------------------- */
function closeModal(id){ document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
