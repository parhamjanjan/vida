<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>پلنر - سامانه آموزشی ویدا</title>

<!-- Tailwind + FontAwesome + Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
  
  :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #1e293b;
    --bg-color: #0f172a;
    --text-color: #e2e8f0;
    --sidebar-bg: rgba(30,41,59,0.9);
    --card-bg: rgba(30,41,59,0.5);
    --border-color: rgba(255,255,255,0.04);
    --input-bg: rgba(30,41,59,0.8);
  }

  [data-theme="light"] {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #f8fafc;
    --bg-color: #f1f5f9;
    --text-color: #1e293b;
    --sidebar-bg: rgba(255,255,255,0.9);
    --card-bg: rgba(255,255,255,0.7);
    --border-color: rgba(0,0,0,0.08);
    --input-bg: rgba(255,255,255,0.9);
  }

  /* انیمیشن‌های عمومی */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideInLeft {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  @keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* انیمیشن تغییر تم */
  body {
    background: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.5s ease, color 0.5s ease;
    animation: fadeIn 0.5s ease-out;
  }

  * {
    box-sizing: border-box;
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
  }

  /* انیمیشن برای المان‌های جدید */
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out;
  }

  .animate-slide-in-right {
    animation: slideInRight 0.4s ease-out;
  }

  .animate-slide-in-left {
    animation: slideInLeft 0.4s ease-out;
  }

  .animate-pulse {
    animation: pulse 2s infinite;
  }

  .animate-bounce {
    animation: bounce 0.5s ease-in-out;
  }

  .animate-scale-in {
    animation: scaleIn 0.3s ease-out;
  }

  .animate-float {
    animation: float 3s ease-in-out infinite;
  }

  /* استایل dropdown */
  .form-input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
    font-family: 'Vazirmatn', sans-serif;
    transition: all 0.3s ease;
  }

  .form-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    transform: translateY(-2px);
  }

  /* استایل برای تعداد تسک‌های انجام شده */
  .completed-count {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.4));
    color: #10b981;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    margin-right: 8px;
    animation: scaleIn 0.3s ease-out;
  }

  .list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    border-radius: 12px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid transparent;
    transition: all 0.3s ease;
  }

  .list-item:hover {
    transform: translateX(-5px);
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .list-item.active {
    background: linear-gradient(135deg, rgba(79,70,229,.15), rgba(79,70,229,.25));
    border-right: 4px solid var(--primary);
    transform: translateX(-5px);
  }

  .list-item-content {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    flex: 1;
  }

  .list-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* استایل options در dropdown */
  .form-input option {
    background: var(--input-bg);
    color: var(--text-color);
    padding: 12px;
    border: none;
  }

  /* استایل برای گروه input زمان */
  .time-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .time-input-group .form-input:first-child {
    flex: 1;
  }

  .time-input-group .form-input:last-child {
    width: 100px;
  }

  .flex-1 {
    flex: 1;
  }

  .w-24 {
    width: 6rem;
  }

  /* استایل برای نمودارها */
  .charts-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  .chart-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
    animation: scaleIn 0.5s ease-out;
    transition: all 0.3s ease;
  }

  .chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }

  .chart-wrapper {
    position: relative;
    height: 280px;
    width: 100%;
  }

  /* استایل برای صفحه گزارش هفتگی */
  .print-report {
    display: none;
  }

  .print-page {
    background: white;
    color: black;
    padding: 20mm;
    min-height: 297mm;
    width: 210mm;
    margin: 0 auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    font-family: 'Vazirmatn', sans-serif;
    animation: scaleIn 0.5s ease-out;
  }

  .print-header {
    text-align: center;
    border-bottom: 3px solid #4f46e5;
    padding-bottom: 20px;
    margin-bottom: 30px;
    animation: slideInLeft 0.5s ease-out;
  }

  .print-header h1 {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 28px;
    margin-bottom: 15px;
  }

  .print-meta {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #666;
    margin-bottom: 30px;
  }

  .print-table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    animation: slideInRight 0.5s ease-out;
  }

  .print-table th {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    color: white;
    padding: 15px 12px;
    text-align: right;
    border: 1px solid #ddd;
    font-weight: 600;
  }

  .print-table td {
    padding: 12px 10px;
    border: 1px solid #ddd;
    text-align: right;
    transition: background-color 0.3s ease;
  }

  .print-table tr:hover td {
    background: rgba(79, 70, 229, 0.05);
  }

  .print-table tr:nth-child(even) {
    background: #f8f9fa;
  }

  .print-summary {
    margin-top: 40px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    border-right: 5px solid #4f46e5;
    animation: slideInLeft 0.5s ease-out;
  }

  .print-summary h3 {
    color: #4f46e5;
    margin-bottom: 15px;
    font-size: 20px;
  }

  .print-footer {
    text-align: center;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid #ddd;
    color: #666;
    font-size: 14px;
  }

  .no-print {
    display: block;
  }

  @media print {
    body * {
      visibility: hidden;
    }
    .print-report, .print-report * {
      visibility: visible;
    }
    .print-report {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      background: white;
    }
    .no-print {
      display: none !important;
    }
    .print-page {
      box-shadow: none;
      margin: 0;
      padding: 15mm;
    }
  }

  body {
    margin: 0;
    font-family: 'Vazirmatn', sans-serif;
    overflow-x: hidden;
  }
  
  nav {
    height: 80px;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    padding: 0 24px;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
    animation: slideInLeft 0.5s ease-out;
  }
  
  .container {
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
    padding: 0 20px;
  }
  
  .planner {
    display: flex;
    gap: 24px;
    padding: 24px 0;
    animation: fadeIn 0.8s ease-out;
  }
  
  /* Sidebar full-height */
  .sidebar {
    width: 320px;
    background: var(--sidebar-bg);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid var(--border-color);
    height: calc(100vh - 104px);
    overflow: auto;
    position: sticky;
    top: 24px;
    backdrop-filter: blur(10px);
    animation: slideInLeft 0.6s ease-out;
  }
  
  .main {
    flex: 1;
    overflow: auto;
    padding-bottom: 40px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn-primary::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }

  .btn-primary:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }

  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    100% {
      transform: scale(40, 40);
      opacity: 0;
    }
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
  }

  .btn-primary:active {
    transform: translateY(0);
  }
  
  .add-task-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--border-color);
    padding: 1rem 0;
    color: inherit;
    outline: none;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .add-task-input:focus {
    border-bottom-color: var(--primary);
  }

  .list-item.active {
    background: linear-gradient(135deg, rgba(79,70,229,.15), rgba(79,70,229,.25));
    border-right: 4px solid var(--primary);
  }
  
  .list-count {
    background: var(--card-bg);
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
    animation: scaleIn 0.3s ease-out;
  }

  /* menu (three-dot) */
  .list-controls {
    position: relative;
  }
  
  .list-menu-btn {
    background: transparent;
    border: none;
    color: var(--text-color);
    opacity: 0.7;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  
  .list-menu-btn:hover {
    background: rgba(255,255,255,0.1);
    opacity: 1;
    transform: rotate(90deg);
  }
  
  .list-menu {
    position: absolute;
    left: 0;
    background: var(--card);
    border: 1px solid var(--border-color);
    padding: 8px;
    border-radius: 12px;
    display: none;
    min-width: 160px;
    z-index: 80;
    backdrop-filter: blur(10px);
    animation: scaleIn 0.2s ease-out;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .list-menu button {
    display: block;
    width: 100%;
    text-align: right;
    padding: 10px 12px;
    border-radius: 8px;
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .list-menu button:hover {
    background: rgba(255,255,255,0.1);
    padding-right: 20px;
  }
  
  .list-item:hover .list-menu-btn {
    opacity: 1;
  }
  
  .list-item:hover .list-menu {
    display: block;
  }

  /* week */
  .weekly-planner {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease-out;
  }
  
  .week-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  
  .day-cell {
    min-height: 160px;
    background: var(--card-bg);
    border-radius: 12px;
    padding: 12px;
    border: 2px dashed var(--border-color);
    position: relative;
    transition: all 0.3s ease;
  }
  
  .day-cell.today {
    background: linear-gradient(135deg, rgba(79,70,229,.12), rgba(79,70,229,.2));
    border-color: var(--primary);
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(79,70,229,0.2);
  }
  
  .day-task {
    background: var(--card-bg);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 8px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid transparent;
    transition: all 0.3s ease;
    animation: scaleIn 0.3s ease-out;
  }
  
  .day-task:hover {
    transform: translateX(-5px);
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .day-task .delete-task-btn {
    color: #ef4444;
    cursor: pointer;
    margin-left: 12px;
    padding: 4px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .day-task .delete-task-btn:hover {
    background: rgba(239,68,68,0.1);
    transform: scale(1.1);
  }

  /* task list */
  .task-list {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease-out;
  }
  
  .task-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
    animation: slideInRight 0.4s ease-out;
  }
  
  .task-item:hover {
    background: rgba(255,255,255,0.03);
    transform: translateX(-5px);
  }
  
  .task-checkbox {
    width: 24px;
    height: 24px;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .task-checkbox:hover {
    border-color: var(--primary);
    transform: scale(1.1);
  }
  
  .task-checkbox.checked {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-color: var(--primary);
    color: white;
    animation: bounce 0.5s ease-in-out;
  }
  
  .task-title.completed {
    text-decoration: line-through;
    opacity: 0.6;
  }

  /* modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease-out;
  }
  
  .modal .modal-content {
    background: var(--card);
    padding: 30px;
    border-radius: 20px;
    width: 100%;
    max-width: 560px;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
    animation: scaleIn 0.3s ease-out;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .drop-active {
    background: rgba(79,70,229,0.12);
    border-color: var(--primary);
    transform: scale(1.02);
  }

  /* دکمه تغییر تم */
  .theme-toggle {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.3rem;
    padding: 10px;
    border-radius: 50%;
    transition: all 0.3s ease;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle:hover {
    transform: rotate(30deg) scale(1.1);
    background: rgba(255,255,255,0.1);
  }

  /* نوتیفیکیشن */
  .notification {
    position: fixed;
    top: 30px;
    right: 30px;
    background: var(--card);
    color: var(--text-color);
    padding: 20px;
    border-radius: 12px;
    border-left: 5px solid var(--primary);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 15px;
    max-width: 400px;
    transform: translateX(500px);
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    backdrop-filter: blur(10px);
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification-icon {
    font-size: 1.8rem;
    color: var(--primary);
    animation: pulse 2s infinite;
  }

  .notification-close {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.3rem;
    padding: 5px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .notification-close:hover {
    background: rgba(255,255,255,0.1);
    transform: rotate(90deg);
  }

  /* نشانگر زمان شروع تسک */
  .task-time-badge {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(79, 70, 229, 0.3));
    color: var(--primary);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    margin-right: 10px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    animation: scaleIn 0.3s ease-out;
  }

  .task-time-badge.past {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.3));
    color: #ef4444;
  }

  .task-time-badge.upcoming {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.3));
    color: #f59e0b;
  }

  /* استایل‌های جدید برای دسته‌بندی زمانی */
  .time-category {
    margin-bottom: 25px;
    animation: fadeIn 0.5s ease-out;
  }

  .time-category-header {
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
    cursor: pointer;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .time-category-header:hover {
    background: rgba(255,255,255,0.05);
    transform: translateX(-5px);
  }

  .time-category-title {
    font-weight: 600;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .time-category-count {
    background: var(--card-bg);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.9rem;
    animation: scaleIn 0.3s ease-out;
  }

  .time-category-content {
    display: none;
    animation: fadeIn 0.3s ease-out;
  }

  .time-category.expanded .time-category-content {
    display: block;
  }

  .time-category.expanded .time-category-header {
    border-bottom: none;
    background: rgba(79,70,229,0.1);
  }

  .time-category-icon {
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  .time-category.expanded .time-category-icon {
    transform: rotate(90deg);
  }

  /* استایل‌های جدید برای سیستم لیگ */
  .league-section {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease-out;
    transition: all 0.3s ease;
  }

  .league-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  }

  .league-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }

  .league-title {
    font-size: 1.4rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .league-icon {
    font-size: 2rem;
    animation: float 3s ease-in-out infinite;
  }

  .league-info {
    display: flex;
    gap: 30px;
    margin-bottom: 25px;
  }

  .league-stat {
    text-align: center;
    flex: 1;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 16px;
    transition: all 0.3s ease;
    animation: scaleIn 0.5s ease-out;
  }

  .league-stat:hover {
    transform: translateY(-5px);
    background: rgba(255,255,255,0.1);
  }

  .league-stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--primary), var(--green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .league-stat-label {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
  }

  .league-progress {
    height: 12px;
    background: var(--border-color);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 25px;
    position: relative;
  }

  .league-progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
  }

  .league-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(255,255,255,0.3), 
      transparent);
    animation: shimmer 2s infinite;
  }

  .league-rankings {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }

  .ranking-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
    animation: scaleIn 0.5s ease-out;
  }

  .ranking-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    border-color: var(--primary);
  }

  .ranking-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1.2rem;
    animation: float 4s ease-in-out infinite;
  }

  .ranking-info {
    flex: 1;
  }

  .ranking-name {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1.1rem;
  }

  .ranking-stats {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.7;
  }

  .ranking-position {
    font-weight: 700;
    font-size: 1.4rem;
    background: linear-gradient(135deg, var(--primary), var(--green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .badges-container {
    display: flex;
    gap: 12px;
    margin-top: 25px;
    flex-wrap: wrap;
  }

  .badge {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
    animation: scaleIn 0.5s ease-out;
    cursor: pointer;
  }

  .badge:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }

  .badge-icon {
    font-size: 1.2rem;
  }

  /* استایل‌های لیگ‌ها */
  .league-legendary {
    background: linear-gradient(135deg, #ffd700, #ff8c00);
    color: #000;
  }

  .league-professional {
    background: linear-gradient(135deg, #c0c0c0, #808080);
    color: #fff;
  }

  .league-beginner {
    background: linear-gradient(135deg, #cd7f32, #8b4513);
    color: #fff;
  }

  .league-training {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    color: #fff;
  }

  /* استایل برای بخش پیش‌بینی نمره */
  .grade-prediction-section {
    background: linear-gradient(135deg, rgba(79,70,229,0.1), rgba(16,185,129,0.1));
    border: 2px solid rgba(79,70,229,0.2);
    animation: pulse 2s infinite;
  }

  .grade-prediction {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 25px;
  }

  .grade-card {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 16px;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    animation: scaleIn 0.5s ease-out;
    position: relative;
    overflow: hidden;
  }

  .grade-card:hover {
    transform: translateY(-8px);
    border-color: var(--primary);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
  }

  .grade-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--primary), var(--green));
  }

  .grade-percentage {
    font-size: 3rem;
    font-weight: 800;
    margin: 15px 0;
    background: linear-gradient(135deg, var(--primary), var(--green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: float 3s ease-in-out infinite;
  }

  .grade-subject {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .grade-progress {
    height: 8px;
    background: var(--border-color);
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
  }

  .grade-progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    background: linear-gradient(90deg, var(--primary), var(--green));
    position: relative;
    overflow: hidden;
  }

  .grade-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(255,255,255,0.4), 
      transparent);
    animation: shimmer 2s infinite;
  }

  /* استایل برای تشخیص خودکار دسته‌بندی */
  .auto-category-detection {
    background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(79,70,229,0.1));
    border: 2px dashed rgba(16,185,129,0.3);
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
    animation: slideInRight 0.5s ease-out;
    display: none;
  }

  .detected-category {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-top: 10px;
    animation: scaleIn 0.3s ease-out;
  }

  .detected-category i {
    font-size: 1.5rem;
    animation: bounce 1s infinite;
  }

  /* موبایل */
  @media (max-width: 768px) {
    .planner {
      flex-direction: column;
      gap: 20px;
    }
    
    .sidebar {
      width: 100%;
      height: auto;
      position: static;
    }
    
    .week-days {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .charts-container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .chart-wrapper {
      height: 250px;
    }
    
    .chart-card {
      padding: 20px;
      margin-bottom: 0;
    }

    .time-input-group {
      flex-direction: column;
      gap: 10px;
    }
    
    .time-input-group .form-input:last-child {
      width: 100%;
    }

    .print-page {
      padding: 10mm;
      width: 100%;
    }

    .print-table {
      font-size: 12px;
    }

    .print-table th,
    .print-table td {
      padding: 10px 6px;
    }

    .league-rankings {
      grid-template-columns: 1fr;
    }

    .league-info {
      flex-direction: column;
      gap: 15px;
    }

    .grade-prediction {
      grid-template-columns: 1fr;
    }
  }

  /* موبایل کوچک */
  @media (max-width: 480px) {
    .charts-container {
      gap: 15px;
    }
    
    .chart-card {
      padding: 15px;
    }
    
    .chart-wrapper {
      height: 220px;
    }
    
    .chart-title {
      font-size: 16px;
    }

    .week-days {
      grid-template-columns: 1fr;
    }

    .league-stat-value {
      font-size: 1.8rem;
    }

    .grade-percentage {
      font-size: 2.5rem;
    }
  }

  /* انیمیشن برای المان‌های جدید */
  .new-item {
    animation: slideInRight 0.5s ease-out, pulse 2s 0.5s;
  }

  .removing-item {
    animation: slideInLeft 0.3s ease-out reverse forwards;
  }

  /* استایل برای ripple effect */
  .ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.7);
    transform: scale(0);
    animation: ripple-animation 0.6s linear;
  }

  @keyframes ripple-animation {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  /* استایل برای glass effect */
  .glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* استایل برای hover 3D */
  .hover-3d {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .hover-3d:hover {
    transform: translateY(-10px) rotateX(5deg);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<nav>
  <div class="container flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-emerald-400 flex items-center justify-center animate-float">
        <i class="fas fa-graduation-cap text-white text-xl"></i>
      </div>
      <div style="-webkit-background-clip:text;background:linear-gradient(135deg,var(--primary),var(--green));color:white;" class="font-bold text-xl animate-slide-in-right">
        سامانه آموزشی ویدا
      </div>
    </div>
    <div class="flex items-center gap-4 no-print">
      <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      <button id="printReportBtn" class="btn-primary">
        <i class="fas fa-print ml-2"></i>
        گزارش هفتگی
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="planner">
    <!-- Sidebar -->
    <div class="sidebar h-full" id="sidebar">
      <div class="mb-8 animate-fade-in">
        <button class="btn-primary w-full mb-6" id="addListBtn">
            <i class="fas fa-plus ml-2"></i>
            لیست جدید
        </button>
        <input type="text" class="add-task-input" placeholder="جستجو در تسک‌ها..." id="searchInput">
      </div>
      
      <div class="mb-8">
        <div class="list-item active" data-view="inbox" id="view-inbox">
            <div class="list-item-content">
                <i class="fas fa-inbox ml-3"></i>
                <span>صندوق ورودی</span>
                <span class="list-count" id="inbox-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="today" id="view-today">
            <div class="list-item-content">
                <i class="fas fa-calendar-day ml-3" style="color: #10b981;"></i>
                <span>امروز</span>
                <span class="list-count" id="today-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="week" id="view-week">
            <div class="list-item-content">
                <i class="fas fa-calendar-week ml-3" style="color: #f59e0b;"></i>
                <span>هفته جاری</span>
                <span class="list-count" id="week-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="important" id="view-important">
            <div class="list-item-content">
                <i class="fas fa-star ml-3" style="color: #ef4444;"></i>
                <span>مهم</span>
                <span class="list-count" id="important-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="league" id="view-league">
            <div class="list-item-content">
                <i class="fas fa-trophy ml-3" style="color: #f59e0b;"></i>
                <span>لیگ مطالعاتی</span>
            </div>
        </div>
      </div>
      
      <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-semibold text-slate-400">لیست‌های درسی</h3>
        </div>
        <div id="study-lists"><!-- JS fills here --></div>
      </div>
      
      <div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-semibold text-slate-400">لیست‌های شخصی</h3>
        </div>
        <div id="personal-lists"><!-- JS fills here --></div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- stats -->
      <div class="stats-grid mb-6" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:24px">
        <div class="stat-card animate-fade-in" style="animation-delay: 0.1s">
          <div class="text-3xl font-bold" id="total-study-time">0</div>
          <div class="text-sm text-slate-400">ساعت مطالعه این هفته</div>
        </div>
        <div class="stat-card animate-fade-in" style="animation-delay: 0.2s">
          <div class="text-3xl font-bold" id="completed-tasks">0</div>
          <div class="text-sm text-slate-400">تسک‌های تکمیل شده</div>
        </div>
        <div class="stat-card animate-fade-in" style="animation-delay: 0.3s">
          <div class="text-3xl font-bold" id="productivity-score">0%</div>
          <div class="text-sm text-slate-400">امتیاز بهره‌وری</div>
        </div>
      </div>

      <!-- weekly planner -->
      <div class="weekly-planner mb-6">
        <div class="flex justify-between items-center">
          <button id="prev-week" class="btn-primary animate-slide-in-left"><i class="fas fa-chevron-right ml-2"></i> هفته قبل</button>
          <h3 class="section-title text-xl font-bold" id="current-week">هفته جاری</h3>
          <button id="next-week" class="btn-primary animate-slide-in-right">هفته بعد <i class="fas fa-chevron-left mr-2"></i></button>
        </div>

        <div class="week-days" id="week-days"></div>
      </div>

      <!-- لیگ مطالعاتی -->
      <div id="league-view" style="display: none;">

        <div class="league-section">
          <!-- در بخش league-header تغییر دهید -->
<div class="league-header">
  <div class="league-title">
    <i class="fas fa-trophy league-icon" id="league-icon"></i>
    <span id="league-name">لیگ آموزشی</span>
  </div>
  <div class="flex items-center gap-3">
    <span id="league-points">امتیاز: 0</span>
    <button id="predictionSettingsBtn" class="btn-primary py-2 px-3 text-sm">
      <i class="fas fa-cog ml-1"></i>
      تنظیمات پیش‌بینی
    </button>
  </div>
</div>

          <div class="league-info">
            <div class="league-stat">
              <div class="league-stat-value" id="daily-hours">0</div>
              <div class="league-stat-label">میانگین روزانه (ساعت)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="weekly-hours">0</div>
              <div class="league-stat-label">مجموع هفتگی (ساعت)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="streak-days">0</div>
              <div class="league-stat-label">روزهای متوالی</div>
            </div>
          </div>

          <div class="league-progress">
            <div class="league-progress-bar" id="league-progress-bar" style="width: 0%;"></div>
          </div>

          <div class="flex justify-between items-center mb-3">
            <div class="text-sm">پیشرفت به لیگ بعدی</div>
            <div class="text-sm font-bold" id="league-next">0%</div>
          </div>

          <div class="badges-container" id="badges-container">
            <!-- نشان‌ها اینجا نمایش داده می‌شوند -->
          </div>
        </div>

        <!-- بخش جدید: پیش‌بینی نمره آزمون -->
        <div class="league-section grade-prediction-section">
          <h3 class="section-title mb-4 flex items-center gap-3">
            <i class="fas fa-chart-line text-green-500"></i>
            پیش‌بینی نمره آزمون‌های آخر هفته
          </h3>
          <div class="grade-prediction" id="grade-prediction">
            <!-- پیش‌بینی نمره دروس اینجا نمایش داده می‌شود -->
          </div>
        </div>

        <div class="league-section">
          <h3 class="section-title mb-4 flex items-center gap-3">
            <i class="fas fa-award text-yellow-500"></i>
            دستاوردهای شما
          </h3>
          <div class="league-rankings flex" id="league-rankings">
            <!-- دستاوردهای کاربر اینجا نمایش داده می‌شود -->
          </div>
        </div>
      </div>

      <!-- charts -->
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title mb-4 text-lg font-semibold"><i class="fas fa-chart-line ml-2"></i> ساعات مطالعه هفته جاری</div>
          <div class="chart-wrapper">
            <canvas id="studyTimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title mb-4 text-lg font-semibold"><i class="fas fa-tasks ml-2"></i> پیشرفت درسی</div>
          <div class="chart-wrapper">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- tasks -->
      <div id="tasks-view">
        <div class="section-title mb-6">
          <i class="fas fa-inbox ml-2"></i>
          <span id="current-list-title" class="text-xl font-bold animate-fade-in">صندوق ورودی</span>
        </div>

        <!-- بخش تشخیص خودکار دسته‌بندی -->
        <div class="auto-category-detection" id="auto-category-detection">
          <div class="flex items-center gap-3 mb-3">
            <i class="fas fa-robot text-green-500"></i>
            <span class="font-semibold">تشخیص خودکار دسته‌بندی</span>
          </div>
          <div class="detected-category" id="detected-category">
            <!-- تشخیص دسته‌بندی اینجا نمایش داده می‌شود -->
          </div>
        </div>

        <div class="mb-6 flex gap-4">
          <input type="text" id="new-task-input" class="add-task-input" placeholder="اضافه کردن تسک (برای تشخیص خودکار عنوان را وارد کنید)..." />
          <button id="openTaskModal" class="btn-primary">افزودن</button>
        </div>

        <div class="task-list" id="task-list"></div>

        <div class="mt-8 animate-fade-in" id="completed-section" style="animation-delay: 0.2s">
          <div class="section-title">
            <i class="fas fa-check-circle text-green-500"></i>
            <span>تکمیل شده (<span id="completed-count">0</span>)</span>
          </div>
          <div id="completed-tasks-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- نوتیفیکیشن -->
<div class="notification" id="notification">
  <div class="notification-icon">
    <i class="fas fa-bell"></i>
  </div>
  <div class="notification-content">
    <div class="notification-title font-bold" id="notification-title">یادآوری</div>
    <div class="notification-message text-sm" id="notification-message">زمان مطالعه شما به پایان رسید!</div>
  </div>
  <button class="notification-close" id="notification-close">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- صفحه گزارش هفتگی -->
<div class="print-report" id="printReport">
  <div class="print-page">
    <div class="print-header">
      <h1>گزارش هفتگی فعالیت‌های آموزشی</h1>
      <div class="print-meta">
        <div id="report-week-range">هفته: -</div>
        <div id="report-generation-date">تاریخ تولید: -</div>
      </div>
    </div>

    <div class="print-summary">
      <h3>خلاصه عملکرد هفتگی</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
        <div style="text-align: center;">
          <div style="font-size: 22px; font-weight: bold; color: #4f46e5;" id="report-total-tasks">0</div>
          <div style="font-size: 14px; color: #666;">تعداد تسک‌ها</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 22px; font-weight: bold; color: #10b981;" id="report-total-time">0 ساعت</div>
          <div style="font-size: 14px; color: #666;">مجموع زمان مطالعه</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 22px; font-weight: bold; color: #f59e0b;" id="report-avg-time">0 ساعت</div>
          <div style="font-size: 14px; color: #666;">میانگین روزانه</div>
        </div>
      </div>
    </div>

    <table class="print-table">
      <thead>
        <tr>
          <th>ردیف</th>
          <th>عنوان تسک</th>
          <th>دسته‌بندی</th>
          <th>تاریخ انجام</th>
          <th>زمان مطالعه</th>
          <th>اولویت</th>
          <th>توضیحات</th>
        </tr>
      </thead>
      <tbody id="report-tasks-table">
        <!-- داده‌های تسک‌ها اینجا پر می‌شود -->
      </tbody>
    </table>

    <div class="print-summary">
      <h3>توزیع زمانی بر اساس روزهای هفته</h3>
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; margin-top: 15px; font-size: 14px;">
        <!-- داده‌های توزیع زمانی اینجا پر می‌شود -->
      </div>
    </div>

    <div class="print-footer">
      <p>این گزارش به صورت خودکار توسط سامانه آموزشی ویدا تولید شده است</p>
      <p>تاریخ تولید: <span id="report-footer-date">-</span></p>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="listModal">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-6" id="listModalTitle">ایجاد لیست جدید</h2>
    <div class="mb-4">
      <label class="block mb-2 text-sm font-semibold">نام لیست</label>
      <input id="listNameInput" class="form-input" placeholder="مثال: ریاضیات">
    </div>
    <div class="mb-6">
      <label class="block mb-2 text-sm font-semibold">رنگ</label>
      <input id="listColorInput" type="color" class="form-input" value="#4f46e5">
    </div>
    <div class="flex justify-end gap-3">
      <button id="saveListBtn" class="btn-primary">ذخیره</button>
      <button id="cancelListBtn" class="btn-primary" style="background:transparent;border:2px solid var(--border-color)">لغو</button>
    </div>
  </div>
</div>

<div class="modal" id="taskModal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4" id="taskModalTitle">ایجاد تسک جدید</h2>
    
    <div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
      <!-- Title -->
      <div>
        <label class="block mb-1 text-sm font-semibold">عنوان</label>
        <input id="taskTitleInput" class="form-input py-2" placeholder="عنوان تسک">
      </div>
      
      <!-- Description -->
      <div>
        <label class="block mb-1 text-sm font-semibold">توضیحات</label>
        <textarea id="taskDescriptionInput" class="form-input py-2" rows="2" placeholder="توضیحات اختیاری"></textarea>
      </div>
      
      <!-- Date and Study Time in one row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block mb-1 text-sm font-semibold">تاریخ سررسید</label>
          <input id="taskDueDateInput" type="date" class="form-input py-2">
        </div>
        <div>
          <label class="block mb-1 text-sm font-semibold">زمان مطالعه</label>
          <div class="flex gap-2">
            <input id="taskStudyTimeInput" type="number" class="form-input py-2 flex-1" min="0" step="0.5" value="1" placeholder="مقدار">
            <select id="taskTimeUnitInput" class="form-input py-2 w-24">
              <option value="hours">ساعت</option>
              <option value="minutes">دقیقه</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Start and End Time -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block mb-1 text-sm font-semibold">زمان شروع</label>
          <input id="taskStartTimeInput" type="time" class="form-input py-2">
        </div>
        <div>
          <label class="block mb-1 text-sm font-semibold">زمان پایان</label>
          <input id="taskEndTimeInput" type="time" class="form-input py-2">
        </div>
      </div>
      
      <!-- Reminder and Time Category -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block mb-1 text-sm font-semibold">یادآوری</label>
          <select id="taskReminderInput" class="form-input py-2">
            <option value="none">بدون یادآوری</option>
            <option value="5">۵ دقیقه قبل</option>
            <option value="10">۱۰ دقیقه قبل</option>
            <option value="15">۱۵ دقیقه قبل</option>
            <option value="30">۳۰ دقیقه قبل</option>
            <option value="60">۱ ساعت قبل</option>
          </select>
        </div>
        <div>
          <label class="block mb-1 text-sm font-semibold">دسته‌بندی زمانی</label>
          <select id="taskTimeCategoryInput" class="form-input py-2">
            <option value="">بدون دسته‌بندی</option>
            <option value="morning">صبح (تا 10:00)</option>
            <option value="noon">ظهر (تا 14:00)</option>
            <option value="afternoon">غروب (تا 18:00)</option>
            <option value="evening">شب (تا 22:00)</option>
            <option value="midnight">نیمه‌شب (تا 2:00)</option>
          </select>
        </div>
      </div>
      
      <!-- Category -->
      <div>
        <label class="block mb-1 text-sm font-semibold">دسته‌بندی</label>
        <select id="taskCategoryInput" class="form-input py-2"></select>
      </div>
    </div>
    
    <!-- Buttons -->
    <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
      <button id="saveTaskBtn" class="btn-primary px-4 py-2">
        <i class="fas fa-save ml-2"></i>
        ذخیره
      </button>
      <button id="cancelTaskBtn" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        لغو
      </button>
    </div>
  </div>
</div>
<!-- مودال تنظیمات پیش‌بینی -->
<div class="modal" id="predictionSettingsModal">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-6">تنظیمات پیش‌بینی نمره</h2>
    
    <div class="mb-6">
      <label class="block mb-3 text-sm font-semibold">انتخاب دروس برای پیش‌بینی</label>
      <div class="space-y-3" id="subject-selection">
        <!-- دروس اینجا اضافه می‌شوند -->
      </div>
    </div>
    
    <div class="mb-6">
      <label class="block mb-2 text-sm font-semibold">روش پیش‌بینی</label>
      <select id="predictionMethodSelect" class="form-input">
        <option value="simple">ساده (بر اساس ساعات مطالعه)</option>
        <option value="advanced">پیشرفته (ساعات + کیفیت + زمان)</option>
      </select>
    </div>
    
    <div class="mb-6">
      <label class="block mb-2 text-sm font-semibold">درصد هدف برای پیش‌بینی</label>
      <input type="range" id="targetPercentageSlider" min="50" max="100" step="5" value="70" class="w-full">
      <div class="flex justify-between text-sm text-slate-400 mt-2">
        <span>50%</span>
        <span id="targetPercentageValue">70%</span>
        <span>100%</span>
      </div>
    </div>
    
    <div class="flex justify-end gap-3">
      <button id="savePredictionSettingsBtn" class="btn-primary">ذخیره تنظیمات</button>
      <button id="cancelPredictionSettingsBtn" class="btn-primary" style="background:transparent;border:2px solid var(--border-color)">لغو</button>
    </div>
  </div>
</div>


<script>
/* ---------------------------
   Data & persistence (start with default lists)
   --------------------------- */


   // تنظیمات کاربر برای دروس پیش‌بینی
let predictionSettings = JSON.parse(localStorage.getItem('plannerPredictionSettings') || '{}');

// اگر تنظیمات وجود ندارد، ایجاد کن
if (Object.keys(predictionSettings).length === 0) {
  predictionSettings = {
    enabledSubjects: [], // دروس فعال به صورت پیش‌فرض
    predictionMethod: 'advanced', // simple یا advanced
    targetPercentage: 70 // درصد هدف برای پیش‌بینی
  };
  localStorage.setItem('plannerPredictionSettings', JSON.stringify(predictionSettings));
}

let tasks = JSON.parse(localStorage.getItem('plannerTasks') || '[]');
let lists = JSON.parse(localStorage.getItem('plannerLists') || '[]');

// داده‌های سیستم لیگ
let userStats = JSON.parse(localStorage.getItem('plannerUserStats') || '{}');

// اگر لیستی وجود ندارد، لیست‌های پیش‌فرض ایجاد کن
if (lists.length === 0) {
  lists = [
    { id: 'math', name: 'ریاضیات', color: '#4f46e5' },
    { id: 'biology', name: 'زیست شناسی', color: '#10b981' },
    { id: 'chemistry', name: 'شیمی', color: '#f59e0b' },
    { id: 'physics', name: 'فیزیک', color: '#ef4444' },
    { id: 'earth', name: 'زمین شناسی', color: '#8b5cf6' },
  ];
  localStorage.setItem('plannerLists', JSON.stringify(lists));
}

// اگر آمار کاربر وجود ندارد، ایجاد کن
if (Object.keys(userStats).length === 0) {
  userStats = {
    dailyHours: 0,
    weeklyHours: 0,
    streak: 0,
    league: 'training',
    points: 0,
    lastStudyDate: null,
    completedTasks: 0,
    badges: [],
    studyHistory: {}
  };
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats));
}

let currentWeek = 0;
let currentView = 'inbox';
let currentCategory = '';
let editingListId = null;
let editingTaskId = null;

// مدیریت تم
let currentTheme = localStorage.getItem('plannerTheme') || 'dark';

// مدیریت یادآوری‌ها
let reminderTimeouts = [];

// تاریخ امروز برای استفاده در مودال
const todayDate = new Date().toISOString().split('T')[0];

function saveAll(){ 
  localStorage.setItem('plannerTasks', JSON.stringify(tasks)); 
  localStorage.setItem('plannerLists', JSON.stringify(lists)); 
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats)); 
}
function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function isoDate(d){ return new Date(d).toISOString().split('T')[0]; }

/* ---------------------------
   سیستم تشخیص خودکار دسته‌بندی
   --------------------------- */
function detectCategoryFromTitle(title) {
  if (!title || typeof title !== 'string') return null;
  
  const titleLower = title.toLowerCase();
  
  // کلمات کلیدی برای هر دسته‌بندی
  const keywords = {
    'math': ['ریاضی'],
    'biology': ['زیست'],
    'chemistry': ['شیمی'],
    'physics': ['فیزیک'],
    'earth': ['فیزیک'],
  };
  
  // محاسبه امتیاز برای هر دسته
  let bestCategory = null;
  let bestScore = 0;
  
  for (const [categoryId, wordList] of Object.entries(keywords)) {
    let score = 0;
    
    for (const word of wordList) {
      if (titleLower.includes(word)) {
        score += 2; // امتیاز برای تطابق کامل
      }
      
      // همچنین کلمات مشابه هم بررسی شوند
      const titleWords = titleLower.split(' ');
      for (const titleWord of titleWords) {
        if (titleWord.length > 2 && word.includes(titleWord) || titleWord.includes(word)) {
          score += 1;
        }
      }
    }
    
    if (score > bestScore) {
      bestScore = score;
      bestCategory = categoryId;
    }
  }
  
  // اگر امتیاز بالاتر از آستانه باشد، دسته را بازگردان
  if (bestScore >= 2) {
    return bestCategory;
  }
  
  return null;
}

function showCategoryDetection(categoryId) {
  const detectionDiv = document.getElementById('auto-category-detection');
  const detectedCategoryDiv = document.getElementById('detected-category');
  
  if (!categoryId) {
    detectionDiv.style.display = 'none';
    return;
  }
  
  const list = lists.find(l => l.id === categoryId);
  if (!list) {
    detectionDiv.style.display = 'none';
    return;
  }
  
  detectionDiv.style.display = 'block';
  detectedCategoryDiv.innerHTML = `
    <i class="fas ${getCategoryIcon(categoryId)}" style="color: ${list.color}"></i>
    <span>تشخیص خودکار: <strong>${list.name}</strong></span>
    <button class="btn-primary ml-auto py-1 px-3 text-sm" onclick="applyDetectedCategory('${categoryId}')">
      اعمال
    </button>
  `;
  
  // انیمیشن
  detectionDiv.classList.remove('animate-slide-in-right');
  setTimeout(() => {
    detectionDiv.classList.add('animate-slide-in-right');
  }, 10);
}

function applyDetectedCategory(categoryId) {
  const select = document.getElementById('taskCategoryInput');
  if (select) {
    select.value = categoryId;
    showNotification('تشخیص خودکار', `دسته‌بندی "${getCategoryName(categoryId)}" اعمال شد.`);
  }
}

/* ---------------------------
   سیستم پیش‌بینی نمره آزمون
   --------------------------- */
function calculateGradePredictions() {
  const weekDates = getCurrentWeekDates(currentWeek);
  const predictions = [];
  
  // فقط دروس فعال را بررسی کن
  const activeLists = lists.filter(list => 
    !['shopping', 'home'].includes(list.id) && // درس‌های غیردرسی را حذف کن
    predictionSettings.enabledSubjects.includes(list.id) // فقط دروس فعال
  );
  
  activeLists.forEach(list => {
    const studyHours = tasks
      .filter(t => t.completed && t.category === list.id && t.dueDate && weekDates.includes(t.dueDate))
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
    
    // تعداد تسک‌های انجام شده
    const completedTasks = tasks.filter(t => 
      t.completed && 
      t.category === list.id && 
      t.dueDate && 
      weekDates.includes(t.dueDate) &&
      (!t.dueDate || new Date(t.dueDate) <= new Date())
    ).length;
    
    const totalTasks = tasks.filter(t => 
      t.category === list.id && 
      t.dueDate && 
      weekDates.includes(t.dueDate)
    ).length;
    
    let predictedPercentage = 0;
    
    // انتخاب روش پیش‌بینی
    if (predictionSettings.predictionMethod === 'simple') {
      // روش ساده: فقط بر اساس ساعات مطالعه
      predictedPercentage = Math.min(100, (studyHours / 10) * 100);
    } else {
      // روش پیشرفته
      const prediction = calculateAdvancedPrediction(studyHours, completedTasks, totalTasks);
      predictedPercentage = prediction.total;
    }
    
    predictions.push({
      subject: list.name,
      subjectId: list.id,
      hours: studyHours,
      predictedPercentage: Math.round(predictedPercentage * 10) / 10,
      grade: studyHours > 0 ? calculateGradeFromPercentage(predictedPercentage) : 0,
      completedTasks: completedTasks,
      totalTasks: totalTasks,
      color: list.color
    });
  });
  
  // درس عمومی (اگر فعال باشد)
  if (predictionSettings.enabledSubjects.includes('general')) {
    const generalHours = tasks
      .filter(t => t.completed && (!t.category || t.category === '') && t.dueDate && weekDates.includes(t.dueDate))
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
    
    if (generalHours > 0) {
      const completedTasks = tasks.filter(t => 
        t.completed && 
        (!t.category || t.category === '') && 
        t.dueDate && 
        weekDates.includes(t.dueDate) &&
        (!t.dueDate || new Date(t.dueDate) <= new Date())
      ).length;
      
      const totalTasks = tasks.filter(t => 
        (!t.category || t.category === '') && 
        t.dueDate && 
        weekDates.includes(t.dueDate)
      ).length;
      
      let predictedPercentage = 0;
      
      if (predictionSettings.predictionMethod === 'simple') {
        predictedPercentage = Math.min(100, (generalHours / 10) * 100);
      } else {
        const prediction = calculateAdvancedPrediction(generalHours, completedTasks, totalTasks);
        predictedPercentage = prediction.total;
      }
      
      predictions.push({
        subject: 'عمومی',
        subjectId: 'general',
        hours: generalHours,
        predictedPercentage: Math.round(predictedPercentage * 10) / 10,
        grade: calculateGradeFromPercentage(predictedPercentage),
        completedTasks: completedTasks,
        totalTasks: totalTasks,
        color: '#6b7280'
      });
    }
  }
  
  return predictions;
}


// تابع برای باز کردن مودال تنظیمات
function openPredictionSettingsModal() {
  const modal = document.getElementById('predictionSettingsModal');
  const subjectSelection = document.getElementById('subject-selection');
  
  // پر کردن لیست دروس
  subjectSelection.innerHTML = '';
  
  // اضافه کردن درس عمومی
  const generalDiv = document.createElement('div');
  generalDiv.className = 'flex items-center gap-3 p-3 bg-slate-800 rounded-lg';
  generalDiv.innerHTML = `
    <input type="checkbox" id="subject-general" class="w-5 h-5 rounded" ${predictionSettings.enabledSubjects.includes('general') ? 'checked' : ''}>
    <label for="subject-general" class="flex-1 cursor-pointer">
      <i class="fas fa-list ml-2" style="color: #6b7280"></i>
      عمومی
    </label>
  `;
  subjectSelection.appendChild(generalDiv);
  
  // اضافه کردن سایر دروس
  lists.forEach(list => {
    if (['shopping', 'home'].includes(list.id)) return;
    
    const subjectDiv = document.createElement('div');
    subjectDiv.className = 'flex items-center gap-3 p-3 bg-slate-800 rounded-lg';
    subjectDiv.innerHTML = `
      <input type="checkbox" id="subject-${list.id}" class="w-5 h-5 rounded" ${predictionSettings.enabledSubjects.includes(list.id) ? 'checked' : ''}>
      <label for="subject-${list.id}" class="flex-1 cursor-pointer">
        <i class="fas ${getCategoryIcon(list.id)} ml-2" style="color: ${list.color}"></i>
        ${list.name}
      </label>
    `;
    subjectSelection.appendChild(subjectDiv);
  });
  
  // تنظیم مقادیر فعلی
  document.getElementById('predictionMethodSelect').value = predictionSettings.predictionMethod;
  document.getElementById('targetPercentageSlider').value = predictionSettings.targetPercentage;
  document.getElementById('targetPercentageValue').textContent = predictionSettings.targetPercentage + '%';
  
  // رویداد برای اسلایدر
  document.getElementById('targetPercentageSlider').addEventListener('input', function() {
    document.getElementById('targetPercentageValue').textContent = this.value + '%';
  });
  
  modal.style.display = 'flex';
}

// تابع برای ذخیره تنظیمات
function savePredictionSettings() {
  const enabledSubjects = [];
  
  // جمع‌آوری دروس انتخاب شده
  document.querySelectorAll('#subject-selection input[type="checkbox"]:checked').forEach(checkbox => {
    const subjectId = checkbox.id.replace('subject-', '');
    enabledSubjects.push(subjectId);
  });
  
  predictionSettings.enabledSubjects = enabledSubjects;
  predictionSettings.predictionMethod = document.getElementById('predictionMethodSelect').value;
  predictionSettings.targetPercentage = parseInt(document.getElementById('targetPercentageSlider').value);
  
  localStorage.setItem('plannerPredictionSettings', JSON.stringify(predictionSettings));
  closeModal('predictionSettingsModal');
  
  // به‌روزرسانی نمایش پیش‌بینی
  if (currentView === 'league') {
    renderGradePredictions();
  }
  
  showNotification('تنظیمات ذخیره شد', 'تنظیمات پیش‌بینی با موفقیت ذخیره شدند.');
}

// تابع پیشرفته برای پیش‌بینی
function calculateAdvancedPrediction(studyHours, completedTasks, totalTasks, daysUntilExam = 7) {
  let basePercentage = 0;
  
  // بخش اول: ساعات مطالعه (حداکثر 60%)
  if (studyHours > 0) {
    // فرمول: هر ساعت مطالعه 4% (تا 15 ساعت = 60%)
    basePercentage = Math.min(60, studyHours * 4);
  }
  
  // بخش دوم: کیفیت انجام تسک‌ها (حداکثر 25%)
  const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) : 0;
  const qualityBonus = completionRate * 25;
  
  // بخش سوم: فاکتور زمان باقی‌مانده (حداکثر 15%)
  const timeFactor = Math.min(15, daysUntilExam * 2); // هر روز 2% شانس بیشتر
  
  // مجموع
  const totalPercentage = Math.min(100, basePercentage + qualityBonus + timeFactor);
  
  return {
    base: Math.round(basePercentage),
    quality: Math.round(qualityBonus),
    time: Math.round(timeFactor),
    total: Math.round(totalPercentage)
  };
}



function renderGradePredictions() {
  const container = document.getElementById('grade-prediction');
  const predictions = calculateGradePredictions();
  
  container.innerHTML = '';
  
  if (predictions.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-slate-400">
        <i class="fas fa-cog text-4xl mb-4"></i>
        <p>هیچ درسی برای پیش‌بینی انتخاب نشده است.</p>
        <p class="text-sm mt-2">برای انتخاب دروس، روی دکمه "تنظیمات پیش‌بینی" کلیک کنید.</p>
        <button id="openSettingsFromEmpty" class="btn-primary mt-4 py-2 px-4">
          <i class="fas fa-cog ml-2"></i>
          تنظیمات پیش‌بینی
        </button>
      </div>
    `;
    
    // اضافه کردن رویداد برای دکمه
    document.getElementById('openSettingsFromEmpty')?.addEventListener('click', openPredictionSettingsModal);
    return;
  }
  
  // نمایش درصد هدف
  const targetHeader = document.createElement('div');
  targetHeader.className = 'mb-4 p-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg';
  targetHeader.innerHTML = `
    <div class="flex justify-between items-center">
      <div>
        <div class="text-sm opacity-80">هدف پیش‌بینی</div>
        <div class="text-xl font-bold">${predictionSettings.targetPercentage}%</div>
      </div>
      <div class="text-right">
        <div class="text-sm opacity-80">روش پیش‌بینی</div>
        <div class="text-sm font-semibold">${predictionSettings.predictionMethod === 'simple' ? 'ساده' : 'پیشرفته'}</div>
      </div>
    </div>
  `;
  container.appendChild(targetHeader);
  
  predictions.forEach(prediction => {
    const gradeCard = document.createElement('div');
    gradeCard.className = 'grade-card hover-3d';
    gradeCard.style.animationDelay = `${Math.random() * 0.5}s`;
    
    // رنگ بر اساس درصد و مقایسه با هدف
    let colorClass = 'text-red-500';
    let progressColor = '#ef4444';
    let statusText = 'نیاز به تلاش بیشتر';
    
    if (prediction.predictedPercentage >= predictionSettings.targetPercentage * 0.7) {
      colorClass = 'text-yellow-500';
      progressColor = '#f59e0b';
      statusText = 'در مسیر هدف';
    }
    if (prediction.predictedPercentage >= predictionSettings.targetPercentage) {
      colorClass = 'text-green-500';
      progressColor = '#10b981';
      statusText = 'دستیابی به هدف';
    }
    if (prediction.predictedPercentage >= 90) {
      colorClass = 'text-blue-500';
      progressColor = '#3b82f6';
      statusText = 'عالی';
    }
    
    gradeCard.innerHTML = `
      <div class="flex justify-between items-start mb-2">
        <div class="grade-subject">${prediction.subject}</div>
        <button class="text-xs text-slate-400 hover:text-white" onclick="toggleSubjectPrediction('${prediction.subjectId}')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="grade-percentage ${colorClass}">${prediction.predictedPercentage}%</div>
      
      <div class="text-sm text-slate-400 mb-2">
        <i class="fas fa-clock ml-1"></i>
        ${prediction.hours.toFixed(1)} ساعت مطالعه
      </div>
      
      ${predictionSettings.predictionMethod === 'advanced' ? `
        <div class="text-xs text-slate-400 mb-3 space-y-1">
          <div class="flex justify-between">
            <span>تسک‌های انجام شده:</span>
            <span>${prediction.completedTasks} از ${prediction.totalTasks}</span>
          </div>
          <div class="flex justify-between">
            <span>نمره پیش‌بینی:</span>
            <span class="font-bold">${prediction.grade}/20</span>
          </div>
        </div>
      ` : ''}
      
      <div class="grade-progress">
        <div class="grade-progress-bar" style="width: ${prediction.predictedPercentage}%; background: ${progressColor}"></div>
      </div>
      
      <div class="text-xs text-slate-400 mt-2 flex justify-between items-center">
        <span>${statusText}</span>
        <span class="font-bold ${colorClass}">${Math.round((prediction.predictedPercentage / predictionSettings.targetPercentage) * 100)}% از هدف</span>
      </div>
    `;
    
    container.appendChild(gradeCard);
  });
}

// تابع برای حذف یک درس از پیش‌بینی
function toggleSubjectPrediction(subjectId) {
  if (confirm('آیا می‌خواهید این درس را از پیش‌بینی حذف کنید؟')) {
    predictionSettings.enabledSubjects = predictionSettings.enabledSubjects.filter(id => id !== subjectId);
    localStorage.setItem('plannerPredictionSettings', JSON.stringify(predictionSettings));
    
    if (currentView === 'league') {
      renderGradePredictions();
    }
    
    showNotification('درس حذف شد', `درس از لیست پیش‌بینی حذف شد.`);
  }
}

/* ---------------------------
   سیستم لیگ مطالعاتی
   --------------------------- */
function updateUserStats() {
  const today = todayISO();
  const weekDates = getCurrentWeekDates(currentWeek);
  
  // محاسبه ساعات مطالعه هفته جاری
  const weeklyHours = tasks
    .filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  // محاسبه میانگین روزانه
  const dailyHours = weeklyHours / 7;
  
  // محاسبه استمرار بر اساس روزهایی که حداقل 4 ساعت مطالعه داشته‌اید
  const streak = calculateStudyStreak();
  
  // محاسبه امتیاز
  let points = Math.round(weeklyHours * 10); // 10 امتیاز به ازای هر ساعت مطالعه
  
  // تعیین لیگ بر اساس ساعات مطالعه
  let league = 'training';
  if (weeklyHours >= 50) {
    league = 'legendary';
  } else if (weeklyHours >= 40) {
    league = 'professional';
  } else if (weeklyHours >= 30) {
    league = 'beginner';
  }
  
  // به‌روزرسانی آمار کاربر
  userStats.dailyHours = dailyHours;
  userStats.weeklyHours = weeklyHours;
  userStats.streak = streak;
  userStats.league = league;
  userStats.points = points;
  userStats.lastStudyDate = today;
  userStats.completedTasks = tasks.filter(t => t.completed).length;
  
  // ذخیره تاریخچه مطالعه
  if (!userStats.studyHistory) userStats.studyHistory = {};
  userStats.studyHistory[today] = weeklyHours;
  
  // بررسی نشان‌ها
  checkBadges();
  
  saveAll();
}

function calculateStudyStreak() {
  // تاریخ‌های 30 روز گذشته
  const dates = [];
  for (let i = 0; i < 30; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    dates.push(isoDate(date));
  }
  
  // محاسبه ساعات مطالعه برای هر روز
  const dailyStudy = {};
  dates.forEach(date => {
    dailyStudy[date] = tasks
      .filter(t => t.completed && t.dueDate === date)
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  });
  
  // محاسبه استمرار از امروز به عقب
  let streak = 0;
  const today = todayISO();
  
  for (let i = 0; i < dates.length; i++) {
    const date = dates[i];
    const studyHours = dailyStudy[date] || 0;
    
    // اگر امروز است و هنوز مطالعه نکرده‌اید، ادامه دهید
    if (date === today && studyHours === 0) {
      continue;
    }
    
    // اگر روزی با حداقل 4 ساعت مطالعه پیدا شد
    if (studyHours >= 4) {
      streak++;
    } else {
      // اگر روزی با کمتر از 4 ساعت مطالعه پیدا شد، استمرار قطع می‌شود
      break;
    }
  }
  
  return streak;
}

function checkBadges() {
  const badges = [];
  
  // استمرار هفتگی (7 روز متوالی با حداقل 4 ساعت مطالعه در روز)
  if (userStats.streak >= 7) {
    badges.push({ id: 'streak-7', name: 'استمرار هفتگی', icon: 'fa-fire', description: '۷ روز مطالعه متوالی با حداقل ۴ ساعت در روز' });
  }
  
  // استمرار ماهانه (30 روز متوالی با حداقل 4 ساعت مطالعه در روز)
  if (userStats.streak >= 30) {
    badges.push({ id: 'streak-30', name: 'استمرار ماهانه', icon: 'fa-calendar', description: '۳۰ روز مطالعه متوالی با حداقل ۴ ساعت در روز' });
  }
  
  // مطالعه‌گر حرفه‌ای
  if (userStats.weeklyHours >= 50) {
    badges.push({ id: 'study-50', name: 'مطالعه‌گر حرفه‌ای', icon: 'fa-graduation-cap', description: '۵۰ ساعت مطالعه در هفته' });
  }
  
  // مطالعه‌گر افسانه‌ای
  if (userStats.weeklyHours >= 100) {
    badges.push({ id: 'study-100', name: 'مطالعه‌گر افسانه‌ای', icon: 'fa-crown', description: '۱۰۰ ساعت مطالعه در هفته' });
  }
  
  // تسک مستر
  if (userStats.completedTasks >= 100) {
    badges.push({ id: 'task-master', name: 'تسک مستر', icon: 'fa-tasks', description: 'تکمیل ۱۰۰ تسک' });
  }
  
  // پرنده سحرخیز
  const earlyBirdTasks = tasks.filter(t => {
    if (!t.startTime || !t.completed) return false;
    const [hours] = t.startTime.split(':').map(Number);
    return hours < 7;
  });
  
  if (earlyBirdTasks.length >= 10) {
    badges.push({ id: 'early-bird', name: 'پرنده سحرخیز', icon: 'fa-sun', description: 'مطالعه قبل از ۷ صبح' });
  }
  
  // بررسی نشان‌های جدید
  badges.forEach(badge => {
    if (!userStats.badges.some(b => b.id === badge.id)) {
      userStats.badges.push(badge);
      showNotification('🎉 تبریک!', `نشان "${badge.name}" را دریافت کردید!`);
    }
  });
  
  saveAll();
}

function renderLeagueView() {
  updateUserStats();
  
  // به‌روزرسانی اطلاعات لیگ
  document.getElementById('league-name').textContent = getLeagueName(userStats.league);
  document.getElementById('league-icon').className = `fas ${getLeagueIcon(userStats.league)} league-icon`;
  document.getElementById('league-points').textContent = `امتیاز: ${userStats.points}`;
  document.getElementById('daily-hours').textContent = userStats.dailyHours.toFixed(1);
  document.getElementById('weekly-hours').textContent = userStats.weeklyHours.toFixed(1);
  document.getElementById('streak-days').textContent = userStats.streak;
  
  // محاسبه پیشرفت به لیگ بعدی
  const progress = calculateLeagueProgress();
  document.getElementById('league-progress-bar').style.width = `${progress}%`;
  document.getElementById('league-progress-bar').style.background = getLeagueColor(userStats.league);
  document.getElementById('league-next').textContent = `${progress}%`;
  
  // نمایش نشان‌ها
  renderBadges();
  
  // نمایش پیش‌بینی نمره
  renderGradePredictions();
  
  // نمایش دستاوردها
  renderAchievements();
}

function getLeagueName(league) {
  const names = {
    'legendary': 'افسانه‌ای',
    'professional': 'حرفه‌ای',
    'beginner': 'مبتدی',
    'training': 'آموزشی'
  };
  return names[league] || 'آموزشی';
}

function getLeagueIcon(league) {
  const icons = {
    'legendary': 'fa-crown',
    'professional': 'fa-medal',
    'beginner': 'fa-award',
    'training': 'fa-user-graduate'
  };
  return icons[league] || 'fa-user-graduate';
}

function getLeagueColor(league) {
  const colors = {
    'legendary': '#ffd700',
    'professional': '#c0c0c0',
    'beginner': '#cd7f32',
    'training': '#4f46e5'
  };
  return colors[league] || '#4f46e5';
}

function calculateLeagueProgress() {
  // محاسبه پیشرفت به لیگ بعدی بر اساس ساعات مطالعه
  const nextLeagueThreshold = getNextLeagueThreshold();
  if (!nextLeagueThreshold) return 100;
  
  const progress = (userStats.weeklyHours / nextLeagueThreshold) * 100;
  return Math.min(100, Math.round(progress));
}

function getNextLeagueThreshold() {
  // آستانه‌های لیگ‌ها
  const thresholds = {
    'training': 30,
    'beginner': 40,
    'professional': 50,
    'legendary': null // بالاترین لیگ
  };
  
  return thresholds[userStats.league];
}

function renderBadges() {
  const container = document.getElementById('badges-container');
  container.innerHTML = '';
  
  if (userStats.badges.length === 0) {
    container.innerHTML = '<div class="text-slate-400 text-center py-6">هنوز هیچ نشان‌ای دریافت نکرده‌اید</div>';
    return;
  }
  
  userStats.badges.forEach(badge => {
    const badgeEl = document.createElement('div');
    badgeEl.className = 'badge bg-gradient-to-r from-green-500 to-emerald-600 text-white';
    badgeEl.title = badge.description;
    badgeEl.style.animationDelay = `${Math.random() * 0.3}s`;
    
    badgeEl.innerHTML = `
      <i class="fas ${badge.icon} badge-icon"></i>
      <span>${badge.name}</span>
    `;
    
    container.appendChild(badgeEl);
  });
}

function renderAchievements() {
  const container = document.getElementById('league-rankings');
  container.innerHTML = '';
  
  const achievements = [
    {
      title: 'تسک‌های تکمیل شده',
      value: userStats.completedTasks,
      target: 100,
      icon: 'fa-check-circle',
      color: '#10b981'
    },
    {
      title: 'روزهای متوالی مطالعه',
      value: userStats.streak,
      target: 30,
      icon: 'fa-fire',
      color: '#f59e0b'
    },
    {
      title: 'ساعت مطالعه این هفته',
      value: userStats.weeklyHours,
      target: 50,
      icon: 'fa-clock',
      color: '#4f46e5'
    },
    {
      title: 'میانگین روزانه',
      value: userStats.dailyHours,
      target: 7,
      icon: 'fa-chart-line',
      color: '#8b5cf6'
    }
  ];
  
  achievements.forEach((achievement, index) => {
    const progress = Math.min(100, (achievement.value / achievement.target) * 100);
    
    const achievementEl = document.createElement('div');
    achievementEl.className = 'ranking-card hover-3d';
    achievementEl.style.animationDelay = `${index * 0.1}s`;
    
    achievementEl.innerHTML = `
      <div class="ranking-avatar" style="background: ${achievement.color}">
        <i class="fas ${achievement.icon}"></i>
      </div>
      <div class="ranking-info">
        <div class="ranking-name">${achievement.title}</div>
        <div class="ranking-stats">${achievement.value.toFixed(1)} از ${achievement.target}</div>
        <div class="league-progress mt-3">
          <div class="league-progress-bar" style="width: ${progress}%; background: ${achievement.color}"></div>
        </div>
      </div>
      <div class="ranking-position">${Math.round(progress)}%</div>
    `;
    
    container.appendChild(achievementEl);
  });
}

/* ---------------------------
   مدیریت تم
   --------------------------- */
function initTheme() {
  document.documentElement.setAttribute('data-theme', currentTheme);
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

function toggleTheme() {
  if (currentTheme === 'dark') {
    currentTheme = 'light';
  } else {
    currentTheme = 'dark';
  }
  
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('plannerTheme', currentTheme);
  
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

/* ---------------------------
   مدیریت یادآوری‌ها
   --------------------------- */
function setupReminders() {
  // پاک کردن تمام یادآوری‌های قبلی
  reminderTimeouts.forEach(timeout => clearTimeout(timeout));
  reminderTimeouts = [];

  const now = new Date();
  
  tasks.forEach(task => {
    if (task.completed || !task.startTime || !task.dueDate) return;
    
    // ترکیب تاریخ و زمان شروع
    const startDateTime = new Date(`${task.dueDate}T${task.startTime}`);
    
    // اگر زمان شروع در گذشته است، از آن صرف نظر کن
    if (startDateTime <= now) return;
    
    // تنظیم یادآوری اصلی
    const timeUntilStart = startDateTime - now;
    if (timeUntilStart > 0) {
      const timeout = setTimeout(() => {
        showNotification('یادآوری تسک', `زمان شروع تسک "${task.title}" فرا رسیده است.`);
        playNotificationSound();
      }, timeUntilStart);
      
      reminderTimeouts.push(timeout);
    }
    
    // تنظیم یادآوری زودتر از موعد (اگر تنظیم شده باشد)
    if (task.reminder && task.reminder !== 'none') {
      const reminderMinutes = parseInt(task.reminder);
      const reminderTime = startDateTime - (reminderMinutes * 60 * 1000);
      const timeUntilReminder = reminderTime - now;
      
      if (timeUntilReminder > 0) {
        const reminderTimeout = setTimeout(() => {
          showNotification('یادآوری تسک', `تسک "${task.title}" در ${reminderMinutes} دقیقه دیگر شروع می‌شود.`);
          playNotificationSound();
        }, timeUntilReminder);
        
        reminderTimeouts.push(reminderTimeout);
      }
    }
  });
}

/* ---------------------------
   مدیریت نوتیفیکیشن
   --------------------------- */
function showNotification(title, message) {
  const notification = document.getElementById('notification');
  const notificationTitle = document.getElementById('notification-title');
  const notificationMessage = document.getElementById('notification-message');
  
  notificationTitle.textContent = title;
  notificationMessage.textContent = message;
  
  notification.classList.add('show');
  
  // نمایش نوتیفیکیشن مرورگر
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body: message, icon: '/favicon.ico' });
  }
  
  // پخش صدا
  playNotificationSound();
  
  // بسته شدن خودکار پس از 5 ثانیه
  setTimeout(() => {
    hideNotification();
  }, 5000);
}

function hideNotification() {
  const notification = document.getElementById('notification');
  notification.classList.remove('show');
}

function playNotificationSound() {
  // ایجاد صدا با Web Audio API
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.value = 800;
    gainNode.gain.value = 0.1;
    
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
    oscillator.stop(audioContext.currentTime + 1);
  } catch (e) {
    console.log('صدا پخش نشد:', e);
  }
}

/* ---------------------------
   Helpers
   --------------------------- */
function getCategoryName(id){ 
  if (!id || id === 'general') return 'عمومی';
  const l = lists.find(x=>x.id===id); 
  return l ? l.name : 'عمومی'; 
}
function getCategoryIcon(id){ 
  
  return 'fa-list'; 
}
function getCategoryColor(id){ 
  const l = lists.find(x=>x.id===id); 
  return l ? l.color : '#6b7280'; 
}
function formatShort(dateStr){ 
  if(!dateStr) return 'بدون تاریخ'; 
  try { 
    return new Date(dateStr).toLocaleDateString('fa-IR'); 
  } catch(e){ 
    return dateStr; 
  } 
}

// تابع جدید برای فرمت کردن زمان برای نمایش
function formatTimeForDisplay(hours) {
  if (hours < 1) {
    const minutes = Math.round(hours * 60);
    return `${minutes} دقیقه`;
  } else if (hours === Math.floor(hours)) {
    return `${hours} ساعت`;
  } else {
    const wholeHours = Math.floor(hours);
    const minutes = Math.round((hours - wholeHours) * 60);
    if (wholeHours === 0) {
      return `${minutes} دقیقه`;
    } else {
      return `${wholeHours} ساعت و ${minutes} دقیقه`;
    }
  }
}

// تابع برای فرمت کردن زمان شروع
function formatStartTime(task) {
  if (!task.startTime) return '';
  
  const now = new Date();
  const today = todayISO();
  const taskDate = task.dueDate || today;
  
  if (taskDate === today) {
    const [hours, minutes] = task.startTime.split(':');
    const taskTime = new Date();
    taskTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    
    if (taskTime > now) {
      return `<span class="task-time-badge upcoming"><i class="fas fa-clock ml-1"></i>امروز ${task.startTime}</span>`;
    } else {
      return `<span class="task-time-badge past"><i class="fas fa-clock ml-1"></i>امروز ${task.startTime}</span>`;
    }
  } else {
    return `<span class="task-time-badge"><i class="fas fa-clock ml-1"></i>${formatShort(taskDate)} ${task.startTime}</span>`;
  }
}

/* ---------------------------
   تابع جدید برای تعیین دسته‌بندی زمانی بر اساس زمان پایان
   --------------------------- */
function getTimeCategory(endTime) {
  if (!endTime) return 'no-time';
  
  const [hours, minutes] = endTime.split(':').map(Number);
  const totalMinutes = hours * 60 + minutes;
  
  // دسته‌بندی‌های زمانی بر اساس زمان پایان
  if (totalMinutes < 600) { // قبل از 10:00
    return 'morning';
  } else if (totalMinutes < 840) { // قبل از 14:00
    return 'noon';
  } else if (totalMinutes < 1080) { // قبل از 18:00
    return 'afternoon';
  } else if (totalMinutes < 1320) { // قبل از 22:00
    return 'evening';
  } else { // قبل از 2:00 روز بعد
    return 'midnight';
  }
}

// تابع برای محاسبه زمان پایان بر اساس زمان شروع و مدت مطالعه
function calculateEndTime(startTime, studyTime) {
  if (!startTime || !studyTime) return '';
  
  const [hours, minutes] = startTime.split(':').map(Number);
  const totalMinutes = hours * 60 + minutes + (studyTime * 60);
  
  // محاسبه ساعت و دقیقه جدید
  let newHours = Math.floor(totalMinutes / 60) % 24;
  const newMinutes = totalMinutes % 60;
  
  // فرمت کردن به فرمت HH:MM
  return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
}

/* ---------------------------
   Improved startOfWeek function
   --------------------------- */
function startOfWeek(refDate, offsetWeeks = 0) {
  const d = new Date(refDate);
  // تنظیم به شروع هفته (شنبه)
  let day = d.getDay(); // 0=یکشنبه, 1=دوشنبه, ..., 6=شنبه
  // تبدیل به تقویم ایرانی: شنبه=0, یکشنبه=1, ..., جمعه=6
  let iranDay = (day) % 7;
  
  const start = new Date(d);
  start.setDate(d.getDate() - iranDay + (offsetWeeks * 7));
  start.setHours(0, 0, 0, 0);
  return start;
}

// تابع برای محاسبه تاریخ‌های هفته جاری
function getCurrentWeekDates(offsetWeeks = 0) {
  const start = startOfWeek(new Date(), offsetWeeks);
  const dates = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    dates.push(isoDate(date));
  }
  return dates;
}

/* ---------------------------
   Render sidebar lists (with 3-dot menu for edit/delete)
   --------------------------- */
function renderSidebarLists(){
  const studyEl = document.getElementById('study-lists');
  const personalEl = document.getElementById('personal-lists');
  studyEl.innerHTML = '';
  personalEl.innerHTML = '';

  // اضافه کردن دسته عمومی به سایدبار
  const generalTasksCount = tasks.filter(t => !t.completed && (!t.category || t.category === '')).length;
  const generalCompletedCount = tasks.filter(t => t.completed && (!t.category || t.category === '')).length;
  
  const generalEl = document.createElement('div');
  generalEl.className = 'list-item animate-scale-in';
  generalEl.style.display = 'flex'
  generalEl.dataset.category = 'general';
  generalEl.innerHTML = `
    <div class="list-item-content">
      <i class="fas fa-list ml-3" style="color:#6b7280"></i>
      <span>عمومی</span>
      <span class="list-count">${generalTasksCount}</span>
    </div>
    <div class="flex items-center gap-1">
      <span class="text-xs text-green-400 completed-count">${generalCompletedCount}</span>
    </div>
  `;
  
  generalEl.addEventListener('click', () => { setActiveView('category', 'general'); });
  studyEl.appendChild(generalEl);

  // لیست‌های ایجاد شده توسط کاربر
  lists.forEach((l, index) => {
    const tasksCount = tasks.filter(t => !t.completed && t.category === l.id).length;
    const completedCount = tasks.filter(t => t.completed && t.category === l.id).length;
    
    const el = document.createElement('div');
    el.className = 'list-item animate-scale-in flex';
    el.style.display = 'flex'
    el.style.animationDelay = `${index * 0.05}s`;
    el.dataset.category = l.id;

    // left content
    const left = document.createElement('div');
    left.className = 'list-item-content';
    left.innerHTML = `<i class="fas ${getCategoryIcon(l.id)} ml-3" style="color:${l.color}"></i><span>${l.name}</span><span class="list-count">${tasksCount}</span>`;

    // controls (three-dot)
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.className = 'list-controls';
    controls.style.zIndex = "1"
    controls.innerHTML = `
      <button class="list-menu-btn" title="بیشتر"><i class="fas fa-ellipsis-v"></i></button>
      <div class="list-menu z-50 mt-[-30px]">
        <button class="edit-list">ویرایش</button>
        <button class="delete-list text-red-400">حذف</button>
      </div>
    `;

    // completed count
    const completedDiv = document.createElement('div');
    completedDiv.className = 'flex items-center gap-1 ml-3';
    completedDiv.innerHTML = `<span class="text-xs text-green-400 completed-count">${completedCount}</span>`;

    el.appendChild(left);
    el.appendChild(completedDiv);
    el.appendChild(controls);

    // click on list -> set category view
    left.addEventListener('click', () => { setActiveView('category', l.id); });

    // edit
    controls.querySelector('.edit-list').addEventListener('click', (e) => {
      e.stopPropagation();
      openListModal(l.id);
    });

    // delete
    controls.querySelector('.delete-list').addEventListener('click', (e) => {
      e.stopPropagation();
      if(!confirm(`آیا از حذف لیست "${l.name}" و تمام تسک‌هایش مطمئنی؟`)) return;
      tasks = tasks.filter(t => t.category !== l.id);
      lists = lists.filter(x => x.id !== l.id);
      saveAll();
      renderSidebarLists();
      updateStats();
      updateSidebarCounts();
      if(currentView === 'category' && currentCategory === l.id) { setActiveView('inbox'); }
      renderAll();
      updateStats();
      updateSidebarCounts();
    });

    // append: decide whether study or personal
    if(['shopping','home'].includes(l.id)) personalEl.appendChild(el); 
    else studyEl.appendChild(el);
  });

  // If no lists, show helpful message
  if(lists.length === 0){
    personalEl.innerHTML = '<div class="muted text-slate-400 text-sm text-center py-4">هیچ لیست شخصی وجود ندارد</div>';
  }
}

/* ---------------------------
   Render tasks with time categories
   --------------------------- */
function renderTasks(){
  const taskList = document.getElementById('task-list');
  const completedListEl = document.getElementById('completed-tasks-list');
  taskList.innerHTML = '';
  if(completedListEl) completedListEl.innerHTML = '';

  let filtered = tasks.slice();
  const today = todayISO();

  if(currentView === 'today') filtered = filtered.filter(t => t.dueDate === today);
  else if(currentView === 'week'){
    const weekDates = getCurrentWeekDates(currentWeek);
    filtered = filtered.filter(t => t.dueDate && weekDates.includes(t.dueDate));
  } else if(currentView === 'important') filtered = filtered.filter(t => t.important);
  else if(currentView === 'category' && currentCategory) {
    if (currentCategory === 'general') {
      filtered = filtered.filter(t => !t.category || t.category === '');
    } else {
      filtered = filtered.filter(t => t.category === currentCategory);
    }
  }

  // search
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  if(q) filtered = filtered.filter(t => (t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q));

  const active = filtered.filter(t => !t.completed);
  const completed = filtered.filter(t => t.completed);

  // گروه‌بندی تسک‌ها بر اساس دسته‌بندی زمانی
  const timeCategories = {
    morning: { name: 'صبح', icon: 'fa-sun', tasks: [] },
    noon: { name: 'ظهر', icon: 'fa-cloud-sun', tasks: [] },
    afternoon: { name: 'غروب', icon: 'fa-sun', tasks: [] },
    evening: { name: 'شب', icon: 'fa-moon', tasks: [] },
    midnight: { name: 'نیمه‌شب', icon: 'fa-star', tasks: [] },
    'no-time': { name: 'بدون زمان', icon: 'fa-clock', tasks: [] }
  };

  // دسته‌بندی تسک‌های فعال
  active.forEach(task => {
    // اگر زمان پایان وجود دارد، از آن استفاده کن، در غیر این صورت از زمان شروع و مدت مطالعه محاسبه کن
    let endTime = task.endTime;
    if (!endTime && task.startTime && task.studyTime) {
      endTime = calculateEndTime(task.startTime, task.studyTime);
    }
    
    const timeCategory = getTimeCategory(endTime);
    timeCategories[timeCategory].tasks.push(task);
  });

  // نمایش تسک‌ها بر اساس دسته‌بندی زمانی
  if(active.length === 0) {
    taskList.innerHTML = '<div class="text-slate-400 py-8 text-center"><i class="fas fa-tasks text-4xl mb-4"></i><div>هیچ تسکی یافت نشد</div></div>';
  } else {
    // نمایش دسته‌بندی‌های زمانی به ترتیب مشخص
    const categoryOrder = ['morning', 'noon', 'afternoon', 'evening', 'midnight', 'no-time'];
    
    categoryOrder.forEach((categoryKey, index) => {
      const category = timeCategories[categoryKey];
      if (category.tasks.length > 0) {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'time-category expanded animate-fade-in';
        categoryEl.style.animationDelay = `${index * 0.1}s`;
        categoryEl.innerHTML = `
          <div class="time-category-header">
            <div class="time-category-title">
              <i class="fas ${category.icon} time-category-icon"></i>
              <span>${category.name}</span>
              <span class="time-category-count">${category.tasks.length}</span>
            </div>
          </div>
          <div class="time-category-content"></div>
        `;
        
        const contentEl = categoryEl.querySelector('.time-category-content');
        
        category.tasks.forEach((t, taskIndex) => {
          const el = document.createElement('div');
          el.className = 'task-item new-item';
          el.draggable = true;
          el.dataset.taskId = t.id;
          el.style.animationDelay = `${taskIndex * 0.05}s`;
          el.innerHTML = `
            <div class="flex items-center gap-4 left">
              <div class="task-checkbox ${t.completed ? 'checked' : ''}"></div>
              <div class="flex-1">
                <div class="task-title ${t.completed ? 'completed' : ''} font-medium mb-1">${t.title}</div>
                <div class="text-slate-400 text-xs flex items-center gap-3 flex-wrap">
                  ${formatShort(t.dueDate)} 
                  ${t.startTime ? '• ' + formatStartTime(t) : ''}
                  ${t.endTime ? `• پایان: ${t.endTime}` : ''}
                  • ${getCategoryName(t.category)} 
                  • ${formatTimeForDisplay(t.studyTime||0)}
                </div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <i class="fas fa-star ${t.important ? 'text-yellow-400 animate-pulse' : 'text-slate-400'} text-lg cursor-pointer star"></i>
              <i class="fas fa-pen text-sky-400 text-lg cursor-pointer edit"></i>
              <i class="fas fa-trash text-slate-400 text-lg cursor-pointer delete-task"></i>
            </div>
          `;
          // events
          el.querySelector('.task-checkbox').addEventListener('click', ()=> toggleTaskCompletion(t.id));
          el.querySelector('.star').addEventListener('click', ()=> toggleTaskImportance(t.id));
          el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('حذف؟')) deleteTask(t.id); });
          el.querySelector('.edit').addEventListener('click', ()=> openTaskModal(t.id));

          // drag
          el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); el.classList.add('dragging'); });
          el.addEventListener('dragend', () => el.classList.remove('dragging'));

          contentEl.appendChild(el);
        });
        
        // کلیک برای باز/بسته کردن دسته‌بندی
        categoryEl.querySelector('.time-category-header').addEventListener('click', () => {
          categoryEl.classList.toggle('expanded');
        });
        
        taskList.appendChild(categoryEl);
      }
    });
  }

  // completed
  document.getElementById('completed-count').textContent = completed.length;
  completed.forEach((t, index) => {
    const el = document.createElement('div');
    el.className = 'task-item animate-scale-in';
    el.style.animationDelay = `${index * 0.05}s`;
    el.innerHTML = `
      <div class="flex items-center gap-4 left">
        <div class="task-checkbox checked"></div>
        <div class="flex-1">
          <div class="task-title completed font-medium mb-1">${t.title}</div>
          <div class="text-slate-400 text-xs flex items-center gap-3 flex-wrap">
            ${formatShort(t.dueDate)} • ${getCategoryName(t.category)} • ${formatTimeForDisplay(t.studyTime||0)}
          </div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <i class="fas fa-undo text-sky-400 text-lg cursor-pointer undo"></i>
        <i class="fas fa-trash text-slate-400 text-lg cursor-pointer delete-task"></i>
      </div>
    `;
    el.querySelector('.undo').addEventListener('click', ()=> toggleTaskCompletion(t.id));
    el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('حذف؟')) deleteTask(t.id); });
    if(completedListEl) completedListEl.appendChild(el);
  });

  updateSidebarCounts();
}

/* ---------------------------
   Weekly planner + drag/drop
   --------------------------- */
function renderWeeklyPlanner(){
  const container = document.getElementById('week-days');
  container.innerHTML = '';
  const start = startOfWeek(new Date(), currentWeek);
  const days = ['شنبه','یکشنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنجشنبه','جمعه'];
  const today = todayISO();

  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const key = isoDate(d);
    const cell = document.createElement('div');
    cell.className = 'day-cell animate-scale-in' + (key === today ? ' today' : '');
    cell.style.animationDelay = `${i * 0.05}s`;
    cell.dataset.date = key;
    cell.innerHTML = `<div class="font-semibold mb-2">${days[i]}<br/><span class="text-slate-400 text-sm">${formatShort(key)}</span></div>`;

    // tasks for that date
    tasks.filter(t => t.dueDate === key && !t.completed).forEach(t => {
      const dt = document.createElement('div');
      dt.className = 'day-task new-item';
      dt.draggable = true;
      dt.dataset.taskId = t.id;
      dt.innerHTML = `<div style="flex:1">${t.title} ${t.startTime ? `<small class="text-xs text-slate-400">(${t.startTime})</small>` : ''}</div><div class="delete-task-btn"><i class="fas fa-times"></i></div>`;

      // delete button
      dt.querySelector('.delete-task-btn').addEventListener('click', (e) => { e.stopPropagation(); if(confirm('حذف؟')) deleteTask(t.id); });
      // drag
      dt.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); dt.classList.add('dragging'); });
      dt.addEventListener('dragend', () => dt.classList.remove('dragging'));
      cell.appendChild(dt);
    });

    // allow drop
    cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drop-active'); });
    cell.addEventListener('dragleave', () => cell.classList.remove('drop-active'));
    cell.addEventListener('drop', (e) => {
      e.preventDefault(); cell.classList.remove('drop-active');
      const id = e.dataTransfer.getData('text/plain'); if(!id) return;
      const t = tasks.find(x=>x.id===id); if(!t) return;
      t.dueDate = cell.dataset.date; saveAll(); renderTasks(); renderWeeklyPlanner(); renderCharts(); updateStats();
      setupReminders(); // تنظیم مجدد یادآوری‌ها
    });

    container.appendChild(cell);
  }

  // week title
  const end = new Date(start); end.setDate(start.getDate()+6);
  document.getElementById('current-week').textContent = `${formatShort(start.toISOString().split('T')[0])} — ${formatShort(end.toISOString().split('T')[0])}`;
}

/* ---------------------------
   Charts (use tasks, support fractional >1)
   --------------------------- */
let studyChart = null, progressChart = null;

function computeStudyByDateForCurrentWeek(){
  const weekDates = getCurrentWeekDates(currentWeek);
  const map = {};
  weekDates.forEach(date => { map[date] = 0; });
  
  tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate)).forEach(t => {
    const v = parseFloat(t.studyTime) || 0;
    map[t.dueDate] = (map[t.dueDate] || 0) + v;
  });
  
  return { dates: weekDates, data: weekDates.map(date => map[date] || 0) };
}

// تابع جدید برای محاسبه درصد زمان مطالعه هر درس در هفته جاری
function computeStudyTimeByCategoryForCurrentWeek(){
  const weekDates = getCurrentWeekDates(currentWeek);
  
  // محاسبه کل زمان مطالعه هفته جاری
  const totalStudyTime = tasks
    .filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  // محاسبه زمان مطالعه برای هر دسته‌بندی در هفته جاری
  const categoryStudy = {};
  
  // دسته عمومی در هفته جاری
  const generalTime = tasks
    .filter(t => t.completed && (!t.category || t.category === '') && t.dueDate && weekDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  if (generalTime > 0 || totalStudyTime === 0) {
    categoryStudy['عمومی'] = {
      time: generalTime,
      percentage: totalStudyTime > 0 ? (generalTime / totalStudyTime * 100) : 0
    };
  }
  
  // دسته‌های درسی در هفته جاری
  lists.forEach(list => {
    const categoryTime = tasks
      .filter(t => t.completed && t.category === list.id && t.dueDate && weekDates.includes(t.dueDate))
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
    
    if (categoryTime > 0) {
      categoryStudy[list.name] = {
        time: categoryTime,
        percentage: totalStudyTime > 0 ? (categoryTime / totalStudyTime * 100) : 0
      };
    }
  });
  
  return {
    categories: Object.keys(categoryStudy),
    percentages: Object.values(categoryStudy).map(item => Math.round(item.percentage)),
    times: Object.values(categoryStudy).map(item => item.time),
    totalStudyTime: totalStudyTime
  };
}

function renderCharts(){
  // نمودار ساعات مطالعه هفته جاری
  const weekData = computeStudyByDateForCurrentWeek();
  const labels = weekData.dates.map(date => formatShort(date));
  const data = weekData.data;
  const maxVal = Math.max(1, ...data);
  const suggestedMax = Math.ceil(maxVal + 0.5);

  const ctx1 = document.getElementById('studyTimeChart').getContext('2d');
  if(studyChart) studyChart.destroy();
  studyChart = new Chart(ctx1, {
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label:'ساعات مطالعه', 
        data, 
        backgroundColor:'rgba(79,70,229,0.8)',
        borderColor: 'rgba(79,70,229,1)',
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: 'rgba(79,70,229,1)'
      }] 
    },
    options:{ 
      responsive:true,
      animation: {
        duration: 1000,
        easing: 'easeOutQuart'
      },
      scales:{ 
        y:{ 
          beginAtZero:true, 
          max:suggestedMax, 
          ticks:{ stepSize:0.5 }, 
          title:{display:true,text:'ساعت'},
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        x: {
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: 'rgba(255,255,255,0.8)'
          }
        }
      }
    }
  });

  // نمودار پیشرفت درسی (درصد زمان مطالعه هر درس در هفته جاری)
  const categoryData = computeStudyTimeByCategoryForCurrentWeek();
  
  // اگر هیچ داده‌ای وجود ندارد، یک داده نمونه نمایش دهید
  const displayCategories = categoryData.categories.length > 0 ? categoryData.categories : ['هنوز داده‌ای وجود ندارد'];
  const displayPercentages = categoryData.percentages.length > 0 ? categoryData.percentages : [100];

  const ctx2 = document.getElementById('progressChart').getContext('2d');
  if(progressChart) progressChart.destroy();
  progressChart = new Chart(ctx2, {
    type:'line',
    data:{ 
      labels: displayCategories, 
      datasets:[{ 
        label:'درصد زمان مطالعه این هفته', 
        data: displayPercentages, 
        borderColor:'rgba(16,185,129,1)', 
        backgroundColor:'rgba(16,185,129,0.12)', 
        tension:0.4, 
        fill:true,
        pointBackgroundColor: 'rgba(16,185,129,1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8
      }] 
    },
    options:{ 
      responsive:true,
      animation: {
        duration: 1500,
        easing: 'easeOutQuart'
      },
      scales:{ 
        y:{ 
          min:0, 
          max:100, 
          title:{display:true,text:'درصد'},
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          },
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              if (categoryData.categories.length === 0) {
                return 'هنوز داده‌ای برای این هفته وجود ندارد';
              }
              const label = context.label || '';
              const value = context.raw || 0;
              const index = context.dataIndex;
              const hours = categoryData.times[index] || 0;
              return `${label}: ${value}% (${hours.toFixed(1)} ساعت)`;
            },
            afterLabel: function(context) {
              if (categoryData.categories.length > 0) {
                return `کل زمان هفته: ${categoryData.totalStudyTime.toFixed(1)} ساعت`;
              }
            }
          }
        },
        legend: {
          labels: {
            color: 'rgba(255,255,255,0.8)'
          }
        }
      }
    }
  });
}

/* ---------------------------
   Stats & sidebar counts
   --------------------------- */
function updateStats(){
  const weekDates = getCurrentWeekDates(currentWeek);
  const total = tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate))
                    .reduce((s,t)=> s + (parseFloat(t.studyTime)||0), 0);
  const done = tasks.filter(t=>t.completed).length;
  const prod = tasks.length ? Math.round(done / tasks.length * 100) : 0;
  document.getElementById('total-study-time').textContent = total.toFixed(1);
  document.getElementById('completed-tasks').textContent = done;
  document.getElementById('productivity-score').textContent = prod + '%';
}

function updateSidebarCounts(){
  const today = todayISO();
  const weekLater = new Date(); weekLater.setDate(weekLater.getDate()+7); const weekLaterStr = weekLater.toISOString().split('T')[0];
  document.getElementById('inbox-count').textContent = tasks.filter(t => !t.completed).length;
  document.getElementById('today-count').textContent = tasks.filter(t => t.dueDate === today && !t.completed).length;
  document.getElementById('week-count').textContent = tasks.filter(t => t.dueDate && t.dueDate >= today && t.dueDate <= weekLaterStr && !t.completed).length;
  document.getElementById('important-count').textContent = tasks.filter(t => t.important && !t.completed).length;

  // list counts
  lists.forEach(l => {
    const el = document.querySelector(`#study-lists [data-category="${l.id}"] .list-count`) || document.querySelector(`#personal-lists [data-category="${l.id}"] .list-count`);
    if(el) el.textContent = tasks.filter(t => t.category === l.id && !t.completed).length;
  });
}

/* ---------------------------
   Task actions
   --------------------------- */
function toggleTaskCompletion(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  t.completed = !t.completed;
  if(t.completed && !t.dueDate) t.dueDate = todayISO();
  saveAll(); 
  renderTasks(); 
  renderWeeklyPlanner(); 
  renderCharts(); 
  updateStats();
  setupReminders(); // تنظیم مجدد یادآوری‌ها
  
  // به‌روزرسانی آمار برای سیستم لیگ
  updateUserStats();
  if (currentView === 'league') {
    renderLeagueView();
  }
}
function toggleTaskImportance(id){ const t = tasks.find(x=>x.id===id); if(!t) return; t.important = !t.important; saveAll(); renderTasks(); updateSidebarCounts(); }
function deleteTask(id){ 
  const taskElement = document.querySelector(`[data-task-id="${id}"]`);
  if (taskElement) {
    taskElement.classList.add('removing-item');
    setTimeout(() => {
      tasks = tasks.filter(t=>t.id!==id); 
      saveAll(); 
      renderTasks(); 
      renderWeeklyPlanner(); 
      renderCharts(); 
      updateStats();
      setupReminders(); // تنظیم مجدد یادآوری‌ها
    }, 300);
  }
}

function openTaskModal(taskId=null){
  editingTaskId = taskId;
  populateCategorySelect();
  
  if(taskId){
    const t = tasks.find(x=>x.id===taskId); 
    if(!t) return;
    
    document.getElementById('taskModalTitle').textContent = 'ویرایش تسک';
    document.getElementById('taskTitleInput').value = t.title;
    document.getElementById('taskDescriptionInput').value = t.description || '';
    document.getElementById('taskDueDateInput').value = t.dueDate || '';
    document.getElementById('taskStartTimeInput').value = t.startTime || '';
    document.getElementById('taskEndTimeInput').value = t.endTime || '';
    document.getElementById('taskReminderInput').value = t.reminder || 'none';
    document.getElementById('taskTimeCategoryInput').value = t.timeCategory || '';
    
    // مدیریت زمان - اگر زمان بر اساس دقیقه ذخیره شده
    if (t.studyTime && t.studyTime < 1) {
      // اگر کمتر از 1 ساعت است، به دقیقه تبدیل کن
      document.getElementById('taskStudyTimeInput').value = Math.round(t.studyTime * 60);
      document.getElementById('taskTimeUnitInput').value = 'minutes';
    } else {
      document.getElementById('taskStudyTimeInput').value = t.studyTime || 1;
      document.getElementById('taskTimeUnitInput').value = 'hours';
    }
    
    document.getElementById('taskCategoryInput').value = t.category || '';
  } else {
    document.getElementById('taskModalTitle').textContent = 'ایجاد تسک جدید';
    document.getElementById('taskTitleInput').value = '';
    document.getElementById('taskDescriptionInput').value = '';
    // تنظیم تاریخ پیش‌فرض به امروز
    document.getElementById('taskDueDateInput').value = todayDate;
    document.getElementById('taskStartTimeInput').value = '';
    document.getElementById('taskEndTimeInput').value = '';
    document.getElementById('taskReminderInput').value = 'none';
    document.getElementById('taskTimeCategoryInput').value = '';
    document.getElementById('taskStudyTimeInput').value = 1;
    document.getElementById('taskTimeUnitInput').value = 'hours';
    document.getElementById('taskCategoryInput').value = lists[0] ? lists[0].id : '';
  }
  document.getElementById('taskModal').style.display = 'flex';
}

function saveTaskFromModal(){
  const title = document.getElementById('taskTitleInput').value.trim();
  if(!title){ alert('عنوان را وارد کنید'); return; }
  const desc = document.getElementById('taskDescriptionInput').value.trim();
  const dueDate = document.getElementById('taskDueDateInput').value || todayDate; // پیش‌فرض امروز
  const startTime = document.getElementById('taskStartTimeInput').value || null;
  const endTime = document.getElementById('taskEndTimeInput').value || null;
  const reminder = document.getElementById('taskReminderInput').value || 'none';
  const timeCategory = document.getElementById('taskTimeCategoryInput').value || '';
  
  // مدیریت زمان
  const timeValue = parseFloat(document.getElementById('taskStudyTimeInput').value) || 0;
  const timeUnit = document.getElementById('taskTimeUnitInput').value;
  let studyTime = timeValue;
  
  if (timeUnit === 'minutes') {
    studyTime = timeValue / 60; // تبدیل دقیقه به ساعت
  }
  
  const category = document.getElementById('taskCategoryInput').value || '';

  if(editingTaskId){
    const t = tasks.find(x=>x.id===editingTaskId); if(!t) return;
    t.title = title; 
    t.description = desc; 
    t.dueDate = dueDate; 
    t.startTime = startTime;
    t.endTime = endTime;
    t.reminder = reminder;
    t.timeCategory = timeCategory;
    t.studyTime = studyTime; 
    t.category = category;
    editingTaskId = null;
  } else {
    tasks.push({ 
      id: genId(), 
      title, 
      description: desc, 
      completed:false, 
      important:false, 
      category, 
      dueDate, 
      startTime,
      endTime,
      reminder,
      timeCategory,
      studyTime, 
      createdAt: new Date().toISOString() 
    });
  }
  saveAll(); 
  closeModal('taskModal'); 
  renderTasks(); 
  renderWeeklyPlanner(); 
  renderCharts(); 
  updateStats(); 
  updateSidebarCounts();
  setupReminders(); // تنظیم یادآوری‌های جدید
}

/* ---------------------------
   List actions (create & edit via modal)
   --------------------------- */
function openListModal(listId = null){
  editingListId = listId;
  document.getElementById('listModalTitle').textContent = listId ? 'ویرایش لیست' : 'ایجاد لیست جدید';
  if(listId){
    const l = lists.find(x=>x.id===listId);
    if(!l) return;
    document.getElementById('listNameInput').value = l.name;
    document.getElementById('listColorInput').value = l.color || '#4f46e5';
  } else {
    document.getElementById('listNameInput').value = '';
    document.getElementById('listColorInput').value = '#4f46e5';
  }
  document.getElementById('listModal').style.display = 'flex';
}

function updateCurrentListTitle() {
  const titleEl = document.getElementById('current-list-title');
  if (currentView === 'category' && currentCategory === 'general') {
    titleEl.textContent = 'عمومی';
  } else if (currentView === 'category' && currentCategory) {
    const list = lists.find(l => l.id === currentCategory);
    titleEl.textContent = list ? list.name : 'دسته‌بندی';
  } else if (currentView === 'league') {
    titleEl.textContent = 'لیگ مطالعاتی';
  } else {
    const viewTitles = {
      'inbox': 'صندوق ورودی',
      'today': 'امروز', 
      'week': 'هفته جاری',
      'important': 'مهم'
    };
    titleEl.textContent = viewTitles[currentView] || 'صندوق ورودی';
  }
}

function saveListFromModal(){
  const name = document.getElementById('listNameInput').value.trim();
  const color = document.getElementById('listColorInput').value || '#4f46e5';
  if(!name){ alert('نام لیست را وارد کنید'); return; }
  if(editingListId){
    const l = lists.find(x=>x.id===editingListId); if(!l) return;
    l.name = name; l.color = color; editingListId = null;
  } else {
    lists.push({ id: genId(), name, color });
  }
  saveAll(); closeModal('listModal'); renderSidebarLists(); populateCategorySelect(); renderTasks(); renderCharts(); updateSidebarCounts();
}

/* ---------------------------
   UI helpers & wiring
   --------------------------- */
function populateCategorySelect(){
  const sel = document.getElementById('taskCategoryInput');
  sel.innerHTML = '';
  
  // add an empty/general option
  const opt0 = document.createElement('option'); 
  opt0.value = ''; 
  opt0.textContent = '🎯 عمومی (بدون دسته)'; 
  sel.appendChild(opt0);
  
  if (lists.length === 0) {
    const optInfo = document.createElement('option');
    optInfo.value = '';
    optInfo.textContent = '📝 ابتدا یک لیست درسی ایجاد کنید';
    optInfo.disabled = true;
    sel.appendChild(optInfo);
  } else {
    // جدا کردن لیست‌های درسی و شخصی
    const studyLists = lists.filter(l => !['shopping','home'].includes(l.id));
    const personalLists = lists.filter(l => ['shopping','home'].includes(l.id));
    
    if (studyLists.length > 0) {
      const optgroupStudy = document.createElement('optgroup');
      optgroupStudy.style.color = "black"
      optgroupStudy.label = '📚 لیست‌های درسی';
      studyLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        
        // آیکون‌های مختلف برای دسته‌های مختلف
        
        
        const icon =  '📁';
        o.textContent = `${icon} ${l.name}`;
        
        
        optgroupStudy.appendChild(o);
      });
      sel.appendChild(optgroupStudy);
    }
    
    if (personalLists.length > 0) {
      const optgroupPersonal = document.createElement('optgroup');
      optgroupPersonal.label = '🏠 لیست‌های شخصی';
      personalLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        
        const icons = {
          'shopping': '🛒',
          'home': '🏠'
        };
        
        const icon = icons[l.id] || '📁';
        o.textContent = `${icon} ${l.name}`;
        o.style.color = l.color;
        
        optgroupPersonal.appendChild(o);
      });
      sel.appendChild(optgroupPersonal);
    }
  }
}

function setActiveView(view, category=''){
  currentView = view;
  if(view === 'category'){
    currentView = 'category';
    currentCategory = category;
  } else { 
    currentCategory = ''; 
  }
  
  // update active classes
  document.querySelectorAll('.list-item').forEach(x => x.classList.remove('active'));
  
  // mark sidebar view items
  if(view && view !== 'category'){
    const el = document.querySelector(`.list-item[data-view="${view}"]`);
    if(el) el.classList.add('active');
  } else if(view === 'category' && category){
    const el = document.querySelector(`.list-item[data-category="${category}"]`);
    if(el) el.classList.add('active');
  }
  
  // نمایش یا پنهان کردن بخش‌های مختلف
  if (view === 'league') {
    document.getElementById('tasks-view').style.display = 'none';
    document.getElementById('league-view').style.display = 'block';
    renderLeagueView();
  } else {
    document.getElementById('tasks-view').style.display = 'block';
    document.getElementById('league-view').style.display = 'none';
    renderTasks();
  }
  
  // به‌روزرسانی عنوان
  updateCurrentListTitle();
}

function renderAll() {
  renderSidebarLists();
  renderTasks();
  renderWeeklyPlanner();
  renderCharts();
  updateStats();
  updateSidebarCounts();
  setupReminders(); // تنظیم یادآوری‌ها
}

/* ---------------------------
   گزارش هفتگی
   --------------------------- */
function generateWeeklyReport() {
  const weekDates = getCurrentWeekDates(currentWeek);
  const completedTasks = tasks.filter(t => t.completed && t.dueDate && weekDates.includes(t.dueDate));
  
  // مرتب کردن تسک‌ها بر اساس تاریخ (از قدیمی به جدید)
  completedTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  
  // به‌روزرسانی اطلاعات هفته
  const start = startOfWeek(new Date(), currentWeek);
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  document.getElementById('report-week-range').textContent = 
    `هفته: ${formatShort(start.toISOString().split('T')[0])} تا ${formatShort(end.toISOString().split('T')[0])}`;
  
  const now = new Date();
  document.getElementById('report-generation-date').textContent = 
    `تاریخ تولید: ${now.toLocaleDateString('fa-IR')} - ${now.toLocaleTimeString('fa-IR')}`;
  
  document.getElementById('report-footer-date').textContent = now.toLocaleDateString('fa-IR');

  // محاسبه آمار
  const totalTasks = completedTasks.length;
  const totalTime = completedTasks.reduce((sum, task) => sum + (task.studyTime || 0), 0);
  const avgTime = totalTasks > 0 ? (totalTime / 7).toFixed(1) : 0;

  document.getElementById('report-total-tasks').textContent = totalTasks;
  document.getElementById('report-total-time').textContent = totalTime.toFixed(1) + ' ساعت';
  document.getElementById('report-avg-time').textContent = avgTime + ' ساعت';

  // پر کردن جدول تسک‌ها
  const tasksTable = document.getElementById('report-tasks-table');
  tasksTable.innerHTML = '';
  
  if (completedTasks.length === 0) {
    tasksTable.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
          <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
          هیچ تسک تکمیل‌شده‌ای در این هفته وجود ندارد
        </td>
      </tr>
    `;
  } else {
    // گروه‌بندی تسک‌ها بر اساس تاریخ
    const tasksByDate = {};
    completedTasks.forEach(task => {
      if (!tasksByDate[task.dueDate]) {
        tasksByDate[task.dueDate] = [];
      }
      tasksByDate[task.dueDate].push(task);
    });

    // مرتب کردن تاریخ‌ها
    const sortedDates = Object.keys(tasksByDate).sort((a, b) => new Date(a) - new Date(b));
    
    let rowIndex = 1;
    
    sortedDates.forEach(date => {
      const dateTasks = tasksByDate[date];
      
      // اضافه کردن سطر تاریخ
      const dateRow = document.createElement('tr');
      dateRow.style.background = '#e8f4fd';
      dateRow.innerHTML = `
        <td colspan="7" style="font-weight: bold; padding: 15px 12px; color: #4f46e5; font-size: 16px;">
          📅 ${formatShort(date)} - ${dateTasks.length} تسک
        </td>
      `;
      tasksTable.appendChild(dateRow);
      
      // اضافه کردن تسک‌های این تاریخ
      dateTasks.forEach((task, taskIndex) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${rowIndex}</td>
          <td>${task.title}</td>
          <td>${getCategoryName(task.category)}</td>
          <td>${formatShort(task.dueDate)}</td>
          <td>${formatTimeForDisplay(task.studyTime || 0)}</td>
          <td>${task.important ? '⭐ مهم' : 'عادی'}</td>
          <td>${task.description || '-'}</td>
        `;
        tasksTable.appendChild(row);
        rowIndex++;
      });
    });
  }

  // توزیع زمانی روزهای هفته
  const timeDistribution = {};
  weekDates.forEach(date => {
    timeDistribution[date] = 0;
  });
  
  completedTasks.forEach(task => {
    timeDistribution[task.dueDate] += task.studyTime || 0;
  });

  const distributionContainer = document.querySelector('.print-summary:last-child div');
  if (distributionContainer) {
    distributionContainer.innerHTML = '';
    
    const days = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'];
    
    weekDates.forEach((date, index) => {
      const dayDiv = document.createElement('div');
      dayDiv.style.textAlign = 'center';
      dayDiv.style.padding = '12px';
      dayDiv.style.background = '#f8f9fa';
      dayDiv.style.borderRadius = '8px';
      dayDiv.style.border = '1px solid #e9ecef';
      
      dayDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 6px; color: #4f46e5;">${days[index]}</div>
        <div style="color: #10b981; font-size: 14px; font-weight: bold;">${timeDistribution[date].toFixed(1)} ساعت</div>
      `;
      
      distributionContainer.appendChild(dayDiv);
    });
  }

  // نمایش گزارش و پرینت
  document.getElementById('printReport').style.display = 'block';
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      document.getElementById('printReport').style.display = 'none';
    }, 100);
  }, 500);
}

/* ---------------------------
   Event listeners init
   --------------------------- */

// در DOMContentLoaded اضافه کنید:

// دکمه تنظیمات پیش‌بینی
document.getElementById('predictionSettingsBtn')?.addEventListener('click', openPredictionSettingsModal);

// ذخیره تنظیمات پیش‌بینی
document.getElementById('savePredictionSettingsBtn')?.addEventListener('click', savePredictionSettings);

// لغو تنظیمات پیش‌بینی
document.getElementById('cancelPredictionSettingsBtn')?.addEventListener('click', () => {
  closeModal('predictionSettingsModal');
});

// بستن مودال تنظیمات با کلیک خارج
document.getElementById('predictionSettingsModal')?.addEventListener('click', (e) => {
  if (e.target === document.getElementById('predictionSettingsModal')) {
    closeModal('predictionSettingsModal');
  }
});


document.addEventListener('DOMContentLoaded', () => {
  // initial rendering
  initTheme();
  renderAll();

  // درخواست مجوز نوتیفیکیشن
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }

  // close notification
  document.getElementById('notification-close').addEventListener('click', hideNotification);

  // add list button
  document.getElementById('addListBtn').addEventListener('click', () => openListModal(null));
  document.getElementById('saveListBtn').addEventListener('click', () => {saveListFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelListBtn').addEventListener('click', () => { editingListId = null; closeModal('listModal'); });
  document.getElementById('listModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('listModal')) closeModal('listModal'); });

  // open task modal
  document.getElementById('openTaskModal').addEventListener('click', () => openTaskModal(null));
  document.getElementById('saveTaskBtn').addEventListener('click',() =>{ saveTaskFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelTaskBtn').addEventListener('click', () => { editingTaskId = null; closeModal('taskModal'); });
  document.getElementById('taskModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('taskModal')) { editingTaskId=null; closeModal('taskModal'); } });

  // quick add
  document.getElementById('new-task-input').addEventListener('keyup', function(e){
    if(e.key === 'Enter' && this.value.trim() !== ''){
      const title = this.value.trim();
      // تشخیص خودکار دسته‌بندی
      const detectedCategory = detectCategoryFromTitle(title);
      showCategoryDetection(detectedCategory);
      
      // default: no category
      const category = detectedCategory || '';
      tasks.push({ 
        id: genId(), 
        title, 
        description:'', 
        completed:false, 
        important:false, 
        category, 
        dueDate: todayDate, // تاریخ پیش‌فرض امروز
        startTime: null,
        endTime: null,
        reminder: 'none',
        timeCategory: '',
        studyTime:1, 
        createdAt:new Date().toISOString() 
      });
      saveAll();
      this.value = '';
      document.getElementById('auto-category-detection').style.display = 'none';
      renderTasks(); 
      renderWeeklyPlanner(); 
      renderCharts(); 
      updateStats(); 
      updateSidebarCounts();
      setupReminders();
    }
  });

  // تشخیص خودکار دسته‌بندی هنگام تایپ در input
  document.getElementById('new-task-input').addEventListener('input', function() {
    const title = this.value.trim();
    if (title.length > 2) {
      const detectedCategory = detectCategoryFromTitle(title);
      showCategoryDetection(detectedCategory);
    } else {
      document.getElementById('auto-category-detection').style.display = 'none';
    }
  });

  // search
  document.getElementById('searchInput').addEventListener('input', () => renderTasks());

  // view buttons
  document.getElementById('view-inbox').addEventListener('click', ()=> setActiveView('inbox'));
  document.getElementById('view-today').addEventListener('click', ()=> setActiveView('today'));
  document.getElementById('view-week').addEventListener('click', ()=> setActiveView('week'));
  document.getElementById('view-important').addEventListener('click', ()=> setActiveView('important'));
  document.getElementById('view-league').addEventListener('click', ()=> setActiveView('league'));

  // week nav
  document.getElementById('prev-week').addEventListener('click', ()=> { currentWeek--; renderWeeklyPlanner(); renderCharts(); updateStats(); });
  document.getElementById('next-week').addEventListener('click', ()=> { currentWeek++; renderWeeklyPlanner(); renderCharts(); updateStats(); });

  // event listener برای تغییر واحد زمان
  document.getElementById('taskTimeUnitInput').addEventListener('change', function() {
    const timeInput = document.getElementById('taskStudyTimeInput');
    const currentValue = parseFloat(timeInput.value) || 0;
    
    if (this.value === 'minutes') {
      timeInput.step = '5';
      timeInput.min = '0';
      timeInput.placeholder = 'دقیقه';
    } else {
      timeInput.step = '0.5';
      timeInput.min = '0';
      timeInput.placeholder = 'ساعت';
    }
  });

  // event listener برای محاسبه خودکار زمان پایان
  document.getElementById('taskStartTimeInput').addEventListener('change', function() {
    const startTime = this.value;
    const studyTime = parseFloat(document.getElementById('taskStudyTimeInput').value) || 0;
    const timeUnit = document.getElementById('taskTimeUnitInput').value;
    
    if (startTime && studyTime > 0) {
      let studyTimeHours = studyTime;
      if (timeUnit === 'minutes') {
        studyTimeHours = studyTime / 60;
      }
      
      const endTime = calculateEndTime(startTime, studyTimeHours);
      document.getElementById('taskEndTimeInput').value = endTime;
      
      // محاسبه خودکار دسته‌بندی زمانی
      const timeCategory = getTimeCategory(endTime);
      document.getElementById('taskTimeCategoryInput').value = timeCategory;
    }
  });

  // event listener برای تغییر زمان مطالعه
  document.getElementById('taskStudyTimeInput').addEventListener('change', function() {
    const startTime = document.getElementById('taskStartTimeInput').value;
    const studyTime = parseFloat(this.value) || 0;
    const timeUnit = document.getElementById('taskTimeUnitInput').value;
    
    if (startTime && studyTime > 0) {
      let studyTimeHours = studyTime;
      if (timeUnit === 'minutes') {
        studyTimeHours = studyTime / 60;
      }
      
      const endTime = calculateEndTime(startTime, studyTimeHours);
      document.getElementById('taskEndTimeInput').value = endTime;
      
      // محاسبه خودکار دسته‌بندی زمانی
      const timeCategory = getTimeCategory(endTime);
      document.getElementById('taskTimeCategoryInput').value = timeCategory;
    }
  });

  // تغییر تم
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // گزارش هفتگی
  const printReportBtn = document.getElementById('printReportBtn');
  if (printReportBtn) {
    printReportBtn.addEventListener('click', generateWeeklyReport);
  }

  // تشخیص خودکار دسته‌بندی در مودال
  document.getElementById('taskTitleInput').addEventListener('input', function() {
    const title = this.value.trim();
    if (title.length > 2) {
      const detectedCategory = detectCategoryFromTitle(title);
      if (detectedCategory) {
        const select = document.getElementById('taskCategoryInput');
        if (select) {
          select.value = detectedCategory;
          showNotification('تشخیص خودکار', `دسته‌بندی "${getCategoryName(detectedCategory)}" تشخیص داده شد.`);
        }
      }
    }
  });
});

/* ---------------------------
   Utilities
   --------------------------- */
function closeModal(id){ 
  const modal = document.getElementById(id);
  modal.style.opacity = '0';
  modal.style.transform = 'scale(0.95)';
  setTimeout(() => {
    modal.style.display = 'none';
    modal.style.opacity = '1';
    modal.style.transform = 'scale(1)';
  }, 300);
}
</script>
</body>
</html>
