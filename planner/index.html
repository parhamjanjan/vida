<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù¾Ù„Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ - Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§</title>

<!-- Tailwind + FontAwesome + Chart.js + Persian Date -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
  
  :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #1e293b;
    --bg-color: #0f172a;
    --text-color: #e2e8f0;
    --sidebar-bg: rgba(30,41,59,0.9);
    --card-bg: rgba(30,41,59,0.5);
    --border-color: rgba(255,255,255,0.04);
    --input-bg: rgba(30,41,59,0.8);
  }

  [data-theme="light"] {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --green: #10b981;
    --card: #f8fafc;
    --bg-color: #f1f5f9;
    --text-color: #1e293b;
    --sidebar-bg: rgba(255,255,255,0.9);
    --card-bg: rgba(255,255,255,0.7);
    --border-color: rgba(0,0,0,0.08);
    --input-bg: rgba(255,255,255,0.9);
  }

  /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØºÛŒÛŒØ± ØªÙ… */
  body {
    background: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.5s ease, color 0.5s ease;
  }

  * {
    box-sizing: border-box;
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    font-family: 'Vazirmatn', sans-serif;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ dropdown */
  .form-input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØªØ¹Ø¯Ø§Ø¯ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ */
  .completed-count {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 2px 6px;
    border-radius: 999px;
    font-size: 0.7rem;
    margin-right: 8px;
  }

  .list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.9rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    background: var(--card-bg);
  }

  .list-item-content {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex: 1;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ options Ø¯Ø± dropdown */
  .form-input option {
    background: var(--input-bg);
    color: var(--text-color);
    padding: 10px;
    border: none;
  }

  /* ÙˆÙ‚ØªÛŒ dropdown Ø¨Ø§Ø² Ø§Ø³Øª */
  .form-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ input Ø²Ù…Ø§Ù† */
  .time-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .flex-1 {
    flex: 1;
  }

  .w-24 {
    width: 6rem;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ */
  .charts-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 16px;
  }

  .chart-card {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
  }

  .chart-wrapper {
    position: relative;
    height: 250px;
    width: 100%;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØµÙØ­Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ */
  .print-report {
    display: none;
  }

  .print-page {
    background: white;
    color: black;
    padding: 20mm;
    min-height: 297mm;
    width: 210mm;
    margin: 0 auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  .print-header {
    text-align: center;
    border-bottom: 2px solid #4f46e5;
    padding-bottom: 15px;
    margin-bottom: 20px;
  }

  .print-header h1 {
    color: #4f46e5;
    font-size: 24px;
    margin-bottom: 10px;
  }

  .print-meta {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
  }

  .print-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
  }

  .print-table th {
    background: #4f46e5;
    color: white;
    padding: 12px 8px;
    text-align: right;
    border: 1px solid #ddd;
  }

  .print-table td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: right;
  }

  .print-table tr:nth-child(even) {
    background: #f8f9fa;
  }

  .print-summary {
    margin-top: 30px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-right: 4px solid #4f46e5;
  }

  .print-summary h3 {
    color: #4f46e5;
    margin-bottom: 10px;
  }

  .print-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    color: #666;
    font-size: 12px;
  }

  .no-print {
    display: block;
  }

  @media print {
    body * {
      visibility: hidden;
    }
    .print-report, .print-report * {
      visibility: visible;
    }
    .print-report {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      background: white;
    }
    .no-print {
      display: none !important;
    }
    .print-page {
      box-shadow: none;
      margin: 0;
      padding: 15mm;
    }
  }

  body {
    margin: 0;
  }
  
  nav {
    height: 72px;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    padding: 0 16px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }
  
  .planner {
    display: flex;
    gap: 16px;
    padding: 18px 0;
  }
  
  /* Sidebar full-height */
  .sidebar {
    width: 300px;
    background: var(--sidebar-bg);
    border-radius: 12px;
    padding: 18px;
    border: 1px solid var(--border-color);
    height: calc(100vh - 72px);
    overflow: auto;
    position: relative;
  }
  
  .main {
    flex: 1;
    overflow: auto;
    padding-bottom: 40px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .add-task-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border-color);
    padding: .7rem 0;
    color: inherit;
    outline: none;
  }

  .list-item.active {
    background: rgba(79,70,229,.12);
    border-right: 3px solid var(--primary);
  }
  
  .list-count {
    background: var(--card-bg);
    padding: .15rem .5rem;
    border-radius: 999px;
    font-size: .8rem;
    margin-right: .5rem;
  }

  /* menu (three-dot) */
  .list-controls {
    position: relative;
  }
  
  .list-menu-btn {
    background: transparent;
    border: none;
    color: var(--text-color);
    opacity: 0.7;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
  }
  
  .list-menu {
    position: absolute;
    top: 36px;
    left: 0;
    background: var(--card);
    border: 1px solid var(--border-color);
    padding: 6px;
    border-radius: 8px;
    display: none;
    min-width: 140px;
    z-index: 80;
  }
  
  .list-menu button {
    display: block;
    width: 100%;
    text-align: right;
    padding: 8px;
    border-radius: 6px;
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
  }
  
  .list-item:hover .list-menu-btn {
    opacity: 1;
  }
  
  .list-item:hover .list-menu {
    display: block;
  }

  /* month view */
  .monthly-planner {
    background: var(--card-bg);
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 12px;
  }
  
  .calendar-header {
    text-align: center;
    padding: 8px;
    font-weight: bold;
    color: var(--primary);
    border-bottom: 1px solid var(--border-color);
  }
  
  .calendar-cell {
    min-height: 100px;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 6px;
    border: 1px dashed var(--border-color);
    position: relative;
    font-size: 0.9rem;
  }
  
  .calendar-cell.today {
    background: rgba(79,70,229,0.12);
    border-color: var(--primary);
  }
  
  .calendar-day {
    font-weight: bold;
    margin-bottom: 4px;
    color: var(--text-color);
    opacity: 0.8;
  }
  
  .day-task {
    background: var(--card-bg);
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
  }
  
  .day-task .delete-task-btn {
    color: #ef4444;
    cursor: pointer;
    margin-left: 4px;
  }

  /* task list */
  .task-list {
    background: var(--card-bg);
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
  }
  
  .task-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .task-checkbox {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .task-checkbox.checked {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }
  
  .task-title.completed {
    text-decoration: line-through;
    opacity: 0.75;
  }

  /* modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  
  .modal .modal-content {
    background: var(--card);
    padding: 16px;
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    border: 1px solid var(--border-color);
    max-height: 90vh;
    overflow-y: auto;
  }

  .drop-active {
    background: rgba(79,70,229,0.12);
    border-color: var(--primary);
  }

  /* Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± ØªÙ… */
  .theme-toggle {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 8px;
    border-radius: 50%;
    transition: transform 0.3s ease;
  }

  .theme-toggle:hover {
    transform: rotate(30deg);
  }

  /* Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    color: var(--text-color);
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 350px;
    transform: translateX(400px);
    transition: transform 0.3s ease;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification-icon {
    font-size: 1.5rem;
    color: var(--primary);
  }

  .notification-close {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 1.2rem;
  }

  /* Ù†Ø´Ø§Ù†Ú¯Ø± Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ ØªØ³Ú© */
  .task-time-badge {
    background: rgba(79, 70, 229, 0.2);
    color: var(--primary);
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.7rem;
    margin-right: 8px;
  }

  .task-time-badge.past {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
  }

  .task-time-badge.upcoming {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ */
  .time-category {
    margin-bottom: 20px;
  }

  .time-category-header {
    display: flex;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
  }

  .time-category-title {
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .time-category-count {
    background: var(--card-bg);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
  }

  .time-category-content {
    display: none;
  }

  .time-category.expanded .time-category-content {
    display: block;
  }

  .time-category.expanded .time-category-header {
    border-bottom: none;
  }

  .time-category-icon {
    transition: transform 0.3s ease;
  }

  .time-category.expanded .time-category-icon {
    transform: rotate(90deg);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯ */
  .league-section {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
  }

  .league-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .league-title {
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .league-icon {
    font-size: 1.5rem;
  }

  .league-info {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }

  .league-stat {
    text-align: center;
    flex: 1;
  }

  .league-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .league-stat-label {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.7;
  }

  .league-progress {
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 16px;
  }

  .league-progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .league-rankings {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }

  .ranking-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .ranking-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
  }

  .ranking-info {
    flex: 1;
  }

  .ranking-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .ranking-stats {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.7;
  }

  .ranking-position {
    font-weight: 700;
    font-size: 1.2rem;
  }

  .badges-container {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .badge-icon {
    font-size: 1rem;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÚ¯â€ŒÙ‡Ø§ */
  .league-legendary {
    background: linear-gradient(135deg, #ffd700, #ff8c00);
    color: #000;
  }

  .league-professional {
    background: linear-gradient(135deg, #c0c0c0, #808080);
    color: #fff;
  }

  .league-beginner {
    background: linear-gradient(135deg, #cd7f32, #8b4513);
    color: #fff;
  }

  .league-training {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    color: #fff;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ø±ØµØ¯ Ø¯Ø±ÙˆØ³ */
  .subject-prediction {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
  }

  .subject-prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .subject-progress {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .subject-name {
    width: 80px;
    font-size: 0.9rem;
  }

  .subject-bar {
    flex: 1;
    height: 12px;
    background: var(--border-color);
    border-radius: 6px;
    overflow: hidden;
  }

  .subject-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
  }

  .subject-percent {
    width: 40px;
    text-align: left;
    font-weight: 600;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†ÙˆØ¹ ØªØ³Ú© */
  .task-type-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    margin-right: 6px;
  }

  .task-type-test { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .task-type-lesson { background: rgba(16, 185, 129, 0.2); color: #10b981; }
  .task-type-class { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
  .task-type-exam { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
  .task-type-other { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª */
  .test-results {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  .test-result-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø±Ø§Øª Ø¢Ø²Ù…ÙˆÙ† */
  .exam-scores {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  .exam-score-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  /* Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  @media (max-width: 768px) {
    .planner {
      flex-direction: column;
    }
    
    .sidebar {
      width: 100%;
      height: auto;
    }
    
    .calendar-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .charts-container {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .chart-wrapper {
      height: 220px;
    }
    
    .chart-card {
      padding: 12px;
      margin-bottom: 0;
    }

    .time-input-group {
      flex-direction: column;
      gap: 4px;
    }
    
    .time-input-group .form-input:last-child {
      width: 100%;
    }

    .print-page {
      padding: 10mm;
      width: 100%;
    }

    .print-table {
      font-size: 12px;
    }

    .print-table th,
    .print-table td {
      padding: 6px 4px;
    }

    .league-rankings {
      grid-template-columns: 1fr;
    }

    .league-info {
      flex-direction: column;
      gap: 8px;
    }
  }

  /* Ù…ÙˆØ¨Ø§ÛŒÙ„ Ú©ÙˆÚ†Ú© */
  @media (max-width: 480px) {
    .charts-container {
      gap: 8px;
    }
    
    .chart-card {
      padding: 10px;
    }
    
    .chart-wrapper {
      height: 200px;
    }
    
    .chart-title {
      font-size: 14px;
    }
    
    .calendar-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
</head>
<body>
<nav>
  <div class="container flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-emerald-400 flex items-center justify-center">
        <i class="fas fa-graduation-cap text-white"></i>
      </div>
      <div style="-webkit-background-clip:text;background:linear-gradient(135deg,var(--primary),var(--green));color:white;" class="font-bold text-lg">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§</div>
    </div>
    <div class="flex items-center gap-4 no-print">
      <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      <button id="printReportBtn" class="btn-primary">
        <i class="fas fa-print ml-2"></i>
        Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="planner">
    <!-- Sidebar -->
    <div class="sidebar h-full" id="sidebar">
      <div class="mb-8">
        <button class="btn-primary w-full mb-4" id="addListBtn">
            <i class="fas fa-plus ml-2"></i>
            Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯
        </button>
        <input type="text" class="add-task-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªØ³Ú©â€ŒÙ‡Ø§..." id="searchInput">
      </div>
      
      <div class="mb-6">
        <div class="list-item active" data-view="inbox" id="view-inbox">
            <div class="list-item-content">
                <i class="fas fa-inbox ml-3"></i>
                <span>ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ</span>
                <span class="list-count" id="inbox-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="today" id="view-today">
            <div class="list-item-content">
                <i class="fas fa-calendar-day ml-3" style="color: #10b981;"></i>
                <span>Ø§Ù…Ø±ÙˆØ²</span>
                <span class="list-count" id="today-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="month" id="view-month">
            <div class="list-item-content">
                <i class="fas fa-calendar-alt ml-3" style="color: #f59e0b;"></i>
                <span>Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</span>
                <span class="list-count" id="month-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="important" id="view-important">
            <div class="list-item-content">
                <i class="fas fa-star ml-3" style="color: #ef4444;"></i>
                <span>Ù…Ù‡Ù…</span>
                <span class="list-count" id="important-count">0</span>
            </div>
        </div>
        <div class="list-item" data-view="league" id="view-league">
            <div class="list-item-content">
                <i class="fas fa-trophy ml-3" style="color: #f59e0b;"></i>
                <span>Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ</span>
            </div>
        </div>
      </div>
      
      <div class="mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-slate-400">Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ</h3>
        </div>
        <div id="study-lists"><!-- JS fills here --></div>
      </div>
      
      <div>
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-slate-400">Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ</h3>
        </div>
        <div id="personal-lists"><!-- JS fills here --></div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- stats -->
      <div class="stats-grid mb-4" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
        <div class="stat-card">
          <div class="text-2xl font-bold" id="total-study-time">0</div>
          <div class="text-sm text-slate-400">Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
        </div>
        <div class="stat-card">
          <div class="text-2xl font-bold" id="completed-tasks">0</div>
          <div class="text-sm text-slate-400">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
        </div>
        <div class="stat-card">
          <div class="text-2xl font-bold" id="productivity-score">0%</div>
          <div class="text-sm text-slate-400">Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ</div>
        </div>
      </div>

      <!-- monthly planner -->
      <div class="monthly-planner mb-4">
        <div class="flex justify-between items-center">
          <button id="prev-month" class="btn-primary"><i class="fas fa-chevron-right ml-2"></i> Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
          <h3 class="section-title" id="current-month">Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h3>
          <button id="next-month" class="btn-primary">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ <i class="fas fa-chevron-left mr-2"></i></button>
        </div>

        <div class="calendar-grid" id="calendar-grid">
          <!-- Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ -->
          <div class="calendar-header">Ø´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">ÛŒÚ©Ø´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">Ø¯ÙˆØ´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡</div>
          <div class="calendar-header">Ø¬Ù…Ø¹Ù‡</div>
          <!-- Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        </div>
      </div>

      <!-- Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ -->
      <div id="league-view" style="display: none;">
        <div class="league-section">
          <div class="league-header">
            <div class="league-title">
              <i class="fas fa-trophy league-icon" id="league-icon"></i>
              <span id="league-name">Ù„ÛŒÚ¯ Ø¢Ù…ÙˆØ²Ø´ÛŒ</span>
            </div>
            <div class="flex items-center gap-2">
              <span id="league-points">Ø§Ù…ØªÛŒØ§Ø²: 0</span>
            </div>
          </div>

          <div class="league-info">
            <div class="league-stat">
              <div class="league-stat-value" id="daily-hours">0</div>
              <div class="league-stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø³Ø§Ø¹Øª)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="weekly-hours">0</div>
              <div class="league-stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù‡ÙØªÚ¯ÛŒ (Ø³Ø§Ø¹Øª)</div>
            </div>
            <div class="league-stat">
              <div class="league-stat-value" id="streak-days">0</div>
              <div class="league-stat-label">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ</div>
            </div>
          </div>

          <div class="league-progress">
            <div class="league-progress-bar" id="league-progress-bar" style="width: 0%;"></div>
          </div>

          <div class="flex justify-between items-center mb-3">
            <div class="text-sm">Ù¾ÛŒØ´Ø±ÙØª Ø¨Ù‡ Ù„ÛŒÚ¯ Ø¨Ø¹Ø¯ÛŒ</div>
            <div class="text-sm" id="league-next">0%</div>
          </div>

          <div class="badges-container" id="badges-container">
            <!-- Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
          </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ø±ØµØ¯ Ø¯Ø±ÙˆØ³ Ø¢Ø²Ù…ÙˆÙ† -->
        <div class="league-section">
          <div class="subject-prediction-header">
            <h3 class="section-title"><i class="fas fa-chart-line ml-2"></i> Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ø±ØµØ¯ Ø¯Ø±ÙˆØ³ Ø¢Ø²Ù…ÙˆÙ†</h3>
            <div class="text-sm text-slate-400">Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
          </div>
          <div id="subject-predictions">
            <!-- Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ø±ØµØ¯ Ø¯Ø±ÙˆØ³ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
          </div>
        </div>

        <div class="league-section">
          <h3 class="section-title mb-4">Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø´Ù…Ø§</h3>
          <div class="league-rankings flex" id="league-rankings">
            <!-- Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
          </div>
        </div>
      </div>

      <!-- charts -->
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title mb-2"><i class="fas fa-chart-line ml-2"></i> Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</div>
          <div class="chart-wrapper">
            <canvas id="studyTimeChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title mb-2"><i class="fas fa-tasks ml-2"></i> Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ÛŒ</div>
          <div class="chart-wrapper">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- tasks -->
      <div id="tasks-view">
        <div class="section-title mb-4">
          <i class="fas fa-inbox ml-2"></i>
          <span id="current-list-title" class="text-lg font-bold">ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ</span>
        </div>

        <div class="mb-4 flex gap-3">
          <input type="text" id="new-task-input" class="add-task-input" placeholder="Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ³Ú© (Enter)..." />
          <button id="openTaskModal" class="btn-primary">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>

        <div class="task-list" id="task-list"></div>

        <div class="mt-6" id="completed-section">
          <div class="section-title">
            <i class="fas fa-check-circle text-green-500"></i>
            <span>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ (<span id="completed-count">0</span>)</span>
          </div>
          <div id="completed-tasks-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
<div class="notification" id="notification">
  <div class="notification-icon">
    <i class="fas fa-bell"></i>
  </div>
  <div class="notification-content">
    <div class="notification-title font-bold" id="notification-title">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</div>
    <div class="notification-message text-sm" id="notification-message">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!</div>
  </div>
  <button class="notification-close" id="notification-close">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- ØµÙØ­Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ -->
<div class="print-report" id="printReport">
  <div class="print-page">
    <div class="print-header">
      <h1>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h1>
      <div class="print-meta">
        <div id="report-month-range">Ù…Ø§Ù‡: -</div>
        <div id="report-generation-date">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: -</div>
      </div>
    </div>

    <div class="print-summary">
      <h3>Ø®Ù„Ø§ØµÙ‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #4f46e5;" id="report-total-tasks">0</div>
          <div style="font-size: 12px; color: #666;">ØªØ¹Ø¯Ø§Ø¯ ØªØ³Ú©â€ŒÙ‡Ø§</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #10b981;" id="report-total-time">0 Ø³Ø§Ø¹Øª</div>
          <div style="font-size: 12px; color: #666;">Ù…Ø¬Ù…ÙˆØ¹ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #f59e0b;" id="report-avg-time">0 Ø³Ø§Ø¹Øª</div>
          <div style="font-size: 12px; color: #666;">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</div>
        </div>
      </div>
    </div>

    <table class="print-table">
      <thead>
        <tr>
          <th>Ø±Ø¯ÛŒÙ</th>
          <th>Ø¹Ù†ÙˆØ§Ù† ØªØ³Ú©</th>
          <th>Ù†ÙˆØ¹</th>
          <th>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
          <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…</th>
          <th>Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
          <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="report-tasks-table">
        <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </tbody>
    </table>

    <div class="print-summary">
      <h3>ØªÙˆØ²ÛŒØ¹ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</h3>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; font-size: 12px;">
        <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆØ²ÛŒØ¹ Ø²Ù…Ø§Ù†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </div>
    </div>

    <div class="print-footer">
      <p>Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆØ³Ø· Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆÛŒØ¯Ø§ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
      <p>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: <span id="report-footer-date">-</span></p>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="listModal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4" id="listModalTitle">Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯</h2>
    <div class="mb-3">
      <label class="block mb-1">Ù†Ø§Ù… Ù„ÛŒØ³Øª</label>
      <input id="listNameInput" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø±ÛŒØ§Ø¶ÛŒØ§Øª">
    </div>
    <div class="mb-3">
      <label class="block mb-1">Ø±Ù†Ú¯</label>
      <input id="listColorInput" type="color" class="form-input" value="#4f46e5">
    </div>
    <div class="flex justify-end gap-2">
      <button id="saveListBtn" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="cancelListBtn" class="btn-primary" style="background:transparent;border:1px solid var(--border-color)">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<div class="modal" id="taskModal">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-3" id="taskModalTitle">Ø§ÛŒØ¬Ø§Ø¯ ØªØ³Ú© Ø¬Ø¯ÛŒØ¯</h2>
    <div class="mb-2"><label class="block mb-1">Ø¹Ù†ÙˆØ§Ù†</label><input id="taskTitleInput" class="form-input"></div>
    <div class="mb-2"><label class="block mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="taskDescriptionInput" class="form-input" rows="3"></textarea></div>
    
    <div class="mb-2">
      <label class="block mb-1">Ù†ÙˆØ¹ ØªØ³Ú©</label>
      <select id="taskTypeInput" class="form-input">
        <option value="lesson">Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡</option>
        <option value="test">ØªØ³Øª</option>
        <option value="class">Ú©Ù„Ø§Ø³</option>
        <option value="exam">Ø¢Ø²Ù…ÙˆÙ†</option>
        <option value="other">Ø³Ø§ÛŒØ±</option>
      </select>
    </div>

    <!-- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¹ ØªØ³Øª) -->
    <div id="testResultsSection" style="display: none;">
      <div class="mb-2">
        <label class="block mb-1">Ù†ØªØ§ÛŒØ¬ ØªØ³Øª</label>
        <div class="grid grid-cols-3 gap-2">
          <div><label class="block mb-1 text-xs">ØªØ¹Ø¯Ø§Ø¯ ØµØ­ÛŒØ­</label><input type="number" id="testCorrectInput" class="form-input" min="0" placeholder="0"></div>
          <div><label class="block mb-1 text-xs">ØªØ¹Ø¯Ø§Ø¯ ØºÙ„Ø·</label><input type="number" id="testWrongInput" class="form-input" min="0" placeholder="0"></div>
          <div><label class="block mb-1 text-xs">ØªØ¹Ø¯Ø§Ø¯ Ù†Ø²Ø¯Ù‡</label><input type="number" id="testBlankInput" class="form-input" min="0" placeholder="0"></div>
        </div>
      </div>
    </div>

    <!-- Ø¨Ø®Ø´ Ù†Ù…Ø±Ø§Øª Ø¢Ø²Ù…ÙˆÙ† (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†) -->
    <div id="examScoresSection" style="display: none;">
      <div class="mb-2">
        <label class="block mb-1">Ù†Ù…Ø±Ø§Øª Ø¯Ø±ÙˆØ³</label>
        <div class="grid grid-cols-2 gap-2">
          <div><label class="block mb-1 text-xs">ÙÛŒØ²ÛŒÚ©</label><input type="number" id="examPhysicsInput" class="form-input" min="0" max="100" placeholder="0-100"></div>
          <div><label class="block mb-1 text-xs">Ø´ÛŒÙ…ÛŒ</label><input type="number" id="examChemistryInput" class="form-input" min="0" max="100" placeholder="0-100"></div>
          <div><label class="block mb-1 text-xs">Ø²ÛŒØ³Øª</label><input type="number" id="examBiologyInput" class="form-input" min="0" max="100" placeholder="0-100"></div>
          <div><label class="block mb-1 text-xs">Ø±ÛŒØ§Ø¶ÛŒ</label><input type="number" id="examMathInput" class="form-input" min="0" max="100" placeholder="0-100"></div>
          <div><label class="block mb-1 text-xs">Ø²Ù…ÛŒÙ† Ø´Ù†Ø§Ø³ÛŒ</label><input type="number" id="examGeologyInput" class="form-input" min="0" max="100" placeholder="0-100"></div>
        </div>
      </div>
    </div>

    <div class="mb-2 grid grid-cols-2 gap-2">
      <div>
        <label class="block mb-1">ØªØ§Ø±ÛŒØ®</label>
        <input id="taskDueDateInput" type="text" class="form-input datepicker" value="">
      </div>
      <div>
        <label class="block mb-1">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡</label>
        <div class="time-input-group">
          <input id="taskStudyTimeInput" type="number" class="form-input flex-1" min="0" step="0.5" value="1" placeholder="Ø³Ø§Ø¹Øª">
          <span class="text-slate-400">Ø³Ø§Ø¹Øª</span>
        </div>
      </div>
    </div>
    
    <div class="mb-2 grid grid-cols-2 gap-2">
      <div>
        <label class="block mb-1">Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹</label>
        <input id="taskStartTimeInput" type="time" class="form-input">
      </div>
      <div>
        <label class="block mb-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†ÛŒ</label>
        <select id="taskTimeCategoryInput" class="form-input">
          <option value="morning">ØµØ¨Ø­ (6-10)</option>
          <option value="late-morning">Ø§ÙˆØ§Ø®Ø± ØµØ¨Ø­ (10-12)</option>
          <option value="noon">Ø¸Ù‡Ø± (12-14)</option>
          <option value="afternoon">Ø¨Ø¹Ø¯Ø§Ø²Ø¸Ù‡Ø± (14-18)</option>
          <option value="evening">Ø¹ØµØ± (18-22)</option>
          <option value="night">Ø´Ø¨ (22-24)</option>
        </select>
      </div>
    </div>
    
    <div class="mb-2 grid grid-cols-2 gap-2">
      <div>
        <label class="block mb-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
        <select id="taskCategoryInput" class="form-input"></select>
      </div>
      <div>
        <label class="block mb-1">Ø§ÙˆÙ„ÙˆÛŒØª</label>
        <select id="taskPriorityInput" class="form-input">
          <option value="low">Ú©Ù…</option>
          <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
          <option value="high">Ø²ÛŒØ§Ø¯</option>
        </select>
      </div>
    </div>
    
    <div class="flex justify-end gap-2">
      <button id="saveTaskBtn" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="cancelTaskBtn" class="btn-primary" style="background:transparent;border:1px solid var(--border-color)">Ù„ØºÙˆ</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Data & persistence
   --------------------------- */
let tasks = JSON.parse(localStorage.getItem('plannerTasks') || '[]');
let lists = JSON.parse(localStorage.getItem('plannerLists') || '[]');

// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯
let userStats = JSON.parse(localStorage.getItem('plannerUserStats') || '{}');

// Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
if (lists.length === 0) {
  lists = [
    { id: 'math', name: 'Ø±ÛŒØ§Ø¶ÛŒØ§Øª', color: '#4f46e5' },
    { id: 'science', name: 'Ø¹Ù„ÙˆÙ…', color: '#10b981' },
    { id: 'english', name: 'Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', color: '#f59e0b' },
    { id: 'history', name: 'ØªØ§Ø±ÛŒØ®', color: '#ef4444' },
    { id: 'shopping', name: 'Ø®Ø±ÛŒØ¯', color: '#8b5cf6' },
    { id: 'home', name: 'Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø®Ø§Ù†Ù‡', color: '#06b6d4' }
  ];
  localStorage.setItem('plannerLists', JSON.stringify(lists));
}

// Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±
if (Object.keys(userStats).length === 0) {
  userStats = {
    dailyHours: 0,
    monthlyHours: 0,
    streak: 0,
    league: 'training',
    points: 0,
    lastStudyDate: null,
    completedTasks: 0,
    badges: [],
    studyHistory: {},
    subjectStats: {
      math: { hours: 0, tests: 0, score: 0 },
      physics: { hours: 0, tests: 0, score: 0 },
      chemistry: { hours: 0, tests: 0, score: 0 },
      biology: { hours: 0, tests: 0, score: 0 },
      geology: { hours: 0, tests: 0, score: 0 }
    }
  };
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats));
}

let currentMonth = 0; // offset Ù…Ø§Ù‡ Ø§Ø² Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
let currentView = 'inbox';
let currentCategory = '';
let editingListId = null;
let editingTaskId = null;

// Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…
let currentTheme = localStorage.getItem('plannerTheme') || 'dark';

// Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§
let reminderTimeouts = [];

function saveAll(){ 
  localStorage.setItem('plannerTasks', JSON.stringify(tasks)); 
  localStorage.setItem('plannerLists', JSON.stringify(lists)); 
  localStorage.setItem('plannerUserStats', JSON.stringify(userStats)); 
}

function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

/* ---------------------------
   ØªÙˆØ§Ø¨Ø¹ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
   --------------------------- */
function getTodayJalali() {
  const today = new Date();
  const pDate = new persianDate(today);
  return pDate.format('YYYY-MM-DD');
}

function formatJalaliDate(dateStr) {
  if(!dateStr) return 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
  const pDate = new persianDate(dateStr);
  return pDate.format('jDD jMMMM jYYYY');
}

function formatShortJalali(dateStr) {
  if(!dateStr) return 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
  const pDate = new persianDate(dateStr);
  return pDate.format('jDD/jMM');
}

function getCurrentMonthDates(offsetMonths = 0) {
  const today = new Date();
  const pDate = new persianDate(today);
  pDate.addMonth(offsetMonths);
  
  const year = pDate.year();
  const month = pDate.month();
  
  const firstDay = new persianDate([year, month, 1]);
  const lastDay = new persianDate([year, month, pDate.daysInMonth()]);
  
  const dates = [];
  let current = new persianDate(firstDay);
  
  while (current <= lastDay) {
    dates.push(current.format('YYYY-MM-DD'));
    current.addDay(1);
  }
  
  return dates;
}

function getMonthName(offsetMonths = 0) {
  const pDate = new persianDate();
  pDate.addMonth(offsetMonths);
  const monthNames = [
    'ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±',
    'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'
  ];
  return `${monthNames[pDate.month() - 1]} ${pDate.year()}`;
}

/* ---------------------------
   Ø³ÛŒØ³ØªÙ… Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ
   --------------------------- */
function updateUserStats() {
  const today = getTodayJalali();
  const monthDates = getCurrentMonthDates(currentMonth);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
  const monthlyHours = tasks
    .filter(t => t.completed && t.dueDate && monthDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡
  const daysInMonth = monthDates.length;
  const dailyHours = monthlyHours / daysInMonth;
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªÙ…Ø±Ø§Ø±
  const streak = calculateStudyStreak();
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²
  let points = Math.round(monthlyHours * 10);
  
  // ØªØ¹ÛŒÛŒÙ† Ù„ÛŒÚ¯
  let league = 'training';
  if (monthlyHours >= 120) {
    league = 'legendary';
  } else if (monthlyHours >= 80) {
    league = 'professional';
  } else if (monthlyHours >= 40) {
    league = 'beginner';
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ø¯Ø±ÙˆØ³
  updateSubjectStats();
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±
  userStats.dailyHours = dailyHours;
  userStats.monthlyHours = monthlyHours;
  userStats.streak = streak;
  userStats.league = league;
  userStats.points = points;
  userStats.lastStudyDate = today;
  userStats.completedTasks = tasks.filter(t => t.completed).length;
  
  // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡
  if (!userStats.studyHistory) userStats.studyHistory = {};
  userStats.studyHistory[today] = monthlyHours;
  
  // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§
  checkBadges();
  
  saveAll();
}

function updateSubjectStats() {
  // Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø± Ø¯Ø±ÙˆØ³
  const subjects = ['math', 'physics', 'chemistry', 'biology', 'geology'];
  subjects.forEach(subject => {
    if (!userStats.subjectStats[subject]) {
      userStats.subjectStats[subject] = { hours: 0, tests: 0, score: 0 };
    }
  });
  
  const monthDates = getCurrentMonthDates(currentMonth);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø³
  tasks.forEach(task => {
    if (task.completed && task.dueDate && monthDates.includes(task.dueDate)) {
      const subject = detectSubjectFromTitle(task.title);
      if (subject && userStats.subjectStats[subject]) {
        userStats.subjectStats[subject].hours += (task.studyTime || 0);
        
        if (task.type === 'test') {
          userStats.subjectStats[subject].tests += 1;
        }
        
        if (task.type === 'exam') {
          // Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†ØŒ Ù†Ù…Ø±Ù‡ Ø±Ø§ Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
          const examScore = calculateExamScore(task);
          userStats.subjectStats[subject].score = examScore[subject] || 0;
        }
      }
    }
  });
}

function detectSubjectFromTitle(title) {
  const titleLower = title.toLowerCase();
  const subjectKeywords = {
    'Ø±ÛŒØ§Ø¶ÛŒ': 'math',
    'Ø­Ø³Ø§Ø¨': 'math',
    'Ø¬Ø¨Ø±': 'math',
    'Ù‡Ù†Ø¯Ø³Ù‡': 'math',
    'ÙÛŒØ²ÛŒÚ©': 'physics',
    'Ø´ÛŒÙ…ÛŒ': 'chemistry',
    'Ø²ÛŒØ³Øª': 'biology',
    'Ø²Ù…ÛŒÙ†': 'geology',
    'Ø²Ù…ÛŒÙ† Ø´Ù†Ø§Ø³ÛŒ': 'geology'
  };
  
  for (const [keyword, subject] of Object.entries(subjectKeywords)) {
    if (titleLower.includes(keyword)) {
      return subject;
    }
  }
  
  return null;
}

function calculateStudyStreak() {
  const dates = [];
  for (let i = 0; i < 30; i++) {
    const pDate = new persianDate();
    pDate.subtractDay(i);
    dates.push(pDate.format('YYYY-MM-DD'));
  }
  
  const dailyStudy = {};
  dates.forEach(date => {
    dailyStudy[date] = tasks
      .filter(t => t.completed && t.dueDate === date)
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  });
  
  let streak = 0;
  const today = getTodayJalali();
  
  for (let i = 0; i < dates.length; i++) {
    const date = dates[i];
    const studyHours = dailyStudy[date] || 0;
    
    if (date === today && studyHours === 0) {
      continue;
    }
    
    if (studyHours >= 4) {
      streak++;
    } else {
      break;
    }
  }
  
  return streak;
}

function checkBadges() {
  const badges = [];
  
  if (userStats.streak >= 7) {
    badges.push({ id: 'streak-7', name: 'Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù‡ÙØªÚ¯ÛŒ', icon: 'fa-fire', description: 'Û· Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ø³Ø§Ø¹Øª Ø¯Ø± Ø±ÙˆØ²' });
  }
  
  if (userStats.streak >= 30) {
    badges.push({ id: 'streak-30', name: 'Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡', icon: 'fa-calendar', description: 'Û³Û° Ø±ÙˆØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ø³Ø§Ø¹Øª Ø¯Ø± Ø±ÙˆØ²' });
  }
  
  if (userStats.monthlyHours >= 120) {
    badges.push({ id: 'study-120', name: 'Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', icon: 'fa-graduation-cap', description: 'Û±Û²Û° Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ù…Ø§Ù‡' });
  }
  
  if (userStats.monthlyHours >= 200) {
    badges.push({ id: 'study-200', name: 'Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒÚ¯Ø± Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ', icon: 'fa-crown', description: 'Û²Û°Û° Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ù…Ø§Ù‡' });
  }
  
  if (userStats.completedTasks >= 100) {
    badges.push({ id: 'task-master', name: 'ØªØ³Ú© Ù…Ø³ØªØ±', icon: 'fa-tasks', description: 'ØªÚ©Ù…ÛŒÙ„ Û±Û°Û° ØªØ³Ú©' });
  }
  
  const earlyBirdTasks = tasks.filter(t => {
    if (!t.startTime || !t.completed) return false;
    const [hours] = t.startTime.split(':').map(Number);
    return hours < 7;
  });
  
  if (earlyBirdTasks.length >= 10) {
    badges.push({ id: 'early-bird', name: 'Ù¾Ø±Ù†Ø¯Ù‡ Ø³Ø­Ø±Ø®ÛŒØ²', icon: 'fa-sun', description: 'Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Û· ØµØ¨Ø­' });
  }
  
  badges.forEach(badge => {
    if (!userStats.badges.some(b => b.id === badge.id)) {
      userStats.badges.push(badge);
      showNotification('ğŸ‰ ØªØ¨Ø±ÛŒÚ©!', `Ù†Ø´Ø§Ù† "${badge.name}" Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!`);
    }
  });
  
  saveAll();
}

/* ---------------------------
   Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ø±ØµØ¯ Ø¯Ø±ÙˆØ³
   --------------------------- */
function calculateSubjectPredictions() {
  const predictions = {};
  const subjects = ['math', 'physics', 'chemistry', 'biology', 'geology'];
  
  subjects.forEach(subject => {
    const stats = userStats.subjectStats[subject] || { hours: 0, tests: 0, score: 0 };
    
    // ÙØ±Ù…ÙˆÙ„ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ: Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ùˆ ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§
    let prediction = 0;
    
    if (stats.hours > 0) {
      // 60% Ø§Ø² Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ + 40% Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§
      const hourScore = Math.min(60, (stats.hours / 40) * 60);
      const testScore = stats.tests > 0 ? Math.min(40, (stats.tests / 20) * 40) : 0;
      const examScore = stats.score || 0;
      
      prediction = hourScore + testScore;
      
      // Ø§Ú¯Ø± Ù†Ù…Ø±Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ ØªØ£Ø«ÛŒØ± Ø¨Ø¯Ù‡
      if (examScore > 0) {
        prediction = (prediction * 0.7) + (examScore * 0.3);
      }
      
      prediction = Math.min(100, Math.max(0, prediction));
    }
    
    predictions[subject] = Math.round(prediction);
  });
  
  return predictions;
}

function renderSubjectPredictions() {
  const container = document.getElementById('subject-predictions');
  container.innerHTML = '';
  
  const predictions = calculateSubjectPredictions();
  const subjectNames = {
    math: 'Ø±ÛŒØ§Ø¶ÛŒ',
    physics: 'ÙÛŒØ²ÛŒÚ©',
    chemistry: 'Ø´ÛŒÙ…ÛŒ',
    biology: 'Ø²ÛŒØ³Øª',
    geology: 'Ø²Ù…ÛŒÙ†'
  };
  
  const subjectColors = {
    math: '#4f46e5',
    physics: '#ef4444',
    chemistry: '#10b981',
    biology: '#f59e0b',
    geology: '#8b5cf6'
  };
  
  Object.entries(predictions).forEach(([subject, percent]) => {
    const subjectEl = document.createElement('div');
    subjectEl.className = 'subject-progress';
    
    subjectEl.innerHTML = `
      <div class="subject-name">${subjectNames[subject]}</div>
      <div class="subject-bar">
        <div class="subject-fill" style="width: ${percent}%; background: ${subjectColors[subject]}"></div>
      </div>
      <div class="subject-percent">${percent}%</div>
    `;
    
    container.appendChild(subjectEl);
  });
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Ú©â€ŒÙ‡Ø§
   --------------------------- */
function detectCategoryFromTitle(title) {
  const titleLower = title.toLowerCase();
  
  // Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø³ØªÙ‡
  const keywords = {
    'math': ['Ø±ÛŒØ§Ø¶ÛŒ', 'Ø­Ø³Ø§Ø¨', 'Ø¬Ø¨Ø±', 'Ù‡Ù†Ø¯Ø³Ù‡', 'Ù…Ø«Ù„Ø«Ø§Øª'],
    'science': ['Ø¹Ù„Ù…', 'ØªØ¬Ø±Ø¨Ù‡', 'Ø¢Ø²Ù…Ø§ÛŒØ´', 'ÙÛŒØ²ÛŒÚ©', 'Ø´ÛŒÙ…ÛŒ', 'Ø²ÛŒØ³Øª'],
    'english': ['Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', 'Ø²Ø¨Ø§Ù†', 'ÙˆØ§Ú˜Ù‡', 'Ú¯Ø±Ø§Ù…Ø±', 'Ù…Ú©Ø§Ù„Ù…Ù‡'],
    'history': ['ØªØ§Ø±ÛŒØ®', 'ØªØ§Ø±ÛŒØ®ÛŒ', 'Ú¯Ø°Ø´ØªÙ‡', 'Ø¯ÙˆØ±Ø§Ù†'],
    'shopping': ['Ø®Ø±ÛŒØ¯', 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡', 'Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øª', 'Ø¨Ø§Ø²Ø§Ø±'],
    'home': ['Ø®Ø§Ù†Ù‡', 'Ù…Ù†Ø²Ù„', 'Ù†Ø¸Ø§ÙØª', 'ØªÙ…ÛŒØ²', 'Ù„Ø¨Ø§Ø³']
  };
  
  for (const [categoryId, words] of Object.entries(keywords)) {
    for (const word of words) {
      if (titleLower.includes(word)) {
        return categoryId;
      }
    }
  }
  
  return ''; // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ú©Ø¯Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø´ØªØŒ Ø¯Ø³ØªÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ
}

function calculateExamScore(task) {
  const scores = {};
  
  if (task.examScores) {
    scores.math = task.examScores.math || 0;
    scores.physics = task.examScores.physics || 0;
    scores.chemistry = task.examScores.chemistry || 0;
    scores.biology = task.examScores.biology || 0;
    scores.geology = task.examScores.geology || 0;
  }
  
  return scores;
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…
   --------------------------- */
function initTheme() {
  document.documentElement.setAttribute('data-theme', currentTheme);
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

function toggleTheme() {
  if (currentTheme === 'dark') {
    currentTheme = 'light';
  } else {
    currentTheme = 'dark';
  }
  
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('plannerTheme', currentTheme);
  
  const themeToggle = document.getElementById('themeToggle');
  if (currentTheme === 'dark') {
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

/* ---------------------------
   Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
   --------------------------- */
function showNotification(title, message) {
  const notification = document.getElementById('notification');
  const notificationTitle = document.getElementById('notification-title');
  const notificationMessage = document.getElementById('notification-message');
  
  notificationTitle.textContent = title;
  notificationMessage.textContent = message;
  
  notification.classList.add('show');
  
  setTimeout(() => {
    hideNotification();
  }, 5000);
}

function hideNotification() {
  const notification = document.getElementById('notification');
  notification.classList.remove('show');
}

/* ---------------------------
   Helper Functions
   --------------------------- */
function getCategoryName(id){ 
  if (!id || id === 'general') return 'Ø¹Ù…ÙˆÙ…ÛŒ';
  const l = lists.find(x=>x.id===id); 
  return l ? l.name : 'Ø¹Ù…ÙˆÙ…ÛŒ'; 
}

function getCategoryIcon(id){ 
  const map = { 
    math:'fa-calculator', 
    science:'fa-flask', 
    english:'fa-language', 
    history:'fa-history', 
    shopping:'fa-shopping-cart', 
    home:'fa-home' 
  }; 
  return map[id] || 'fa-list'; 
}

function getCategoryColor(id){ 
  const l = lists.find(x=>x.id===id); 
  return l ? l.color : '#6b7280'; 
}

function formatTimeForDisplay(hours) {
  if (hours < 1) {
    const minutes = Math.round(hours * 60);
    return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
  } else if (hours === Math.floor(hours)) {
    return `${hours} Ø³Ø§Ø¹Øª`;
  } else {
    const wholeHours = Math.floor(hours);
    const minutes = Math.round((hours - wholeHours) * 60);
    if (wholeHours === 0) {
      return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
    } else {
      return `${wholeHours} Ø³Ø§Ø¹Øª Ùˆ ${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡`;
    }
  }
}

function getTaskTypeBadge(type) {
  const types = {
    'test': { name: 'ØªØ³Øª', class: 'task-type-test' },
    'lesson': { name: 'Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡', class: 'task-type-lesson' },
    'class': { name: 'Ú©Ù„Ø§Ø³', class: 'task-type-class' },
    'exam': { name: 'Ø¢Ø²Ù…ÙˆÙ†', class: 'task-type-exam' },
    'other': { name: 'Ø³Ø§ÛŒØ±', class: 'task-type-other' }
  };
  
  return types[type] || types['other'];
}

/* ---------------------------
   Render Calendar
   --------------------------- */
function renderCalendar() {
  const container = document.getElementById('calendar-grid');
  
  // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
  const weekDays = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
  
  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ù‚Ø¨Ù„ÛŒ
  container.innerHTML = '';
  
  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
  weekDays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-header';
    header.textContent = day;
    container.appendChild(header);
  });
  
  // ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
  const dates = getCurrentMonthDates(currentMonth);
  const today = getTodayJalali();
  
  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ…
  dates.forEach(date => {
    const pDate = new persianDate(date);
    const dayNumber = pDate.date();
    const isToday = date === today;
    
    const cell = document.createElement('div');
    cell.className = 'calendar-cell' + (isToday ? ' today' : '');
    cell.dataset.date = date;
    
    cell.innerHTML = `<div class="calendar-day">${dayNumber}</div>`;
    
    // ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ²
    const dayTasks = tasks.filter(t => t.dueDate === date && !t.completed);
    
    dayTasks.forEach(task => {
      const taskEl = document.createElement('div');
      taskEl.className = 'day-task';
      taskEl.draggable = true;
      taskEl.dataset.taskId = task.id;
      
      const taskType = getTaskTypeBadge(task.type);
      taskEl.innerHTML = `
        <div style="flex:1; font-size: 0.7rem;">
          <span class="${taskType.class}" style="font-size: 0.6rem; padding: 1px 4px;">${taskType.name}</span>
          ${task.title}
        </div>
        <div class="delete-task-btn"><i class="fas fa-times"></i></div>
      `;
      
      taskEl.querySelector('.delete-task-btn').addEventListener('click', (e) => { 
        e.stopPropagation(); 
        if(confirm('Ø­Ø°ÙØŸ')) deleteTask(task.id); 
      });
      
      taskEl.addEventListener('dragstart', (e) => { 
        e.dataTransfer.setData('text/plain', task.id); 
        taskEl.classList.add('dragging'); 
      });
      
      taskEl.addEventListener('dragend', () => taskEl.classList.remove('dragging'));
      
      cell.appendChild(taskEl);
    });
    
    // allow drop
    cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drop-active'); });
    cell.addEventListener('dragleave', () => cell.classList.remove('drop-active'));
    cell.addEventListener('drop', (e) => {
      e.preventDefault(); 
      cell.classList.remove('drop-active');
      const id = e.dataTransfer.getData('text/plain'); 
      if(!id) return;
      const t = tasks.find(x=>x.id===id); 
      if(!t) return;
      t.dueDate = cell.dataset.date; 
      saveAll(); 
      renderTasks(); 
      renderCalendar(); 
      renderCharts(); 
      updateStats();
    });
    
    container.appendChild(cell);
  });
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù‡
  document.getElementById('current-month').textContent = getMonthName(currentMonth);
}

/* ---------------------------
   Render Tasks with Sorting by Time
   --------------------------- */
function renderTasks() {
  const taskList = document.getElementById('task-list');
  const completedListEl = document.getElementById('completed-tasks-list');
  taskList.innerHTML = '';
  if(completedListEl) completedListEl.innerHTML = '';

  let filtered = tasks.slice();
  const today = getTodayJalali();

  if(currentView === 'today') filtered = filtered.filter(t => t.dueDate === today);
  else if(currentView === 'month') {
    const monthDates = getCurrentMonthDates(currentMonth);
    filtered = filtered.filter(t => t.dueDate && monthDates.includes(t.dueDate));
  } else if(currentView === 'important') filtered = filtered.filter(t => t.important);
  else if(currentView === 'category' && currentCategory) {
    if (currentCategory === 'general') {
      filtered = filtered.filter(t => !t.category || t.category === '');
    } else {
      filtered = filtered.filter(t => t.category === currentCategory);
    }
  }

  // Ø¬Ø³ØªØ¬Ùˆ
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  if(q) filtered = filtered.filter(t => (t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q));

  const active = filtered.filter(t => !t.completed);
  const completed = filtered.filter(t => t.completed);

  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
  active.sort((a, b) => {
    if (a.startTime && b.startTime) {
      return a.startTime.localeCompare(b.startTime);
    } else if (a.startTime) {
      return -1;
    } else if (b.startTime) {
      return 1;
    }
    
    // Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ù†Ø¯Ø§Ø±Ù†Ø¯ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÙˆÙ„ÙˆÛŒØª Ù…Ø±ØªØ¨ Ú©Ù†
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    return priorityOrder[a.priority || 'medium'] - priorityOrder[b.priority || 'medium'];
  });

  // Ù†Ù…Ø§ÛŒØ´ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
  if(active.length === 0) {
    taskList.innerHTML = '<div class="text-slate-400 py-4 text-center">Ù‡ÛŒÚ† ØªØ³Ú©ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
  } else {
    active.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task-item';
      el.draggable = true;
      el.dataset.taskId = t.id;
      
      const taskType = getTaskTypeBadge(t.type);
      
      let extraInfo = '';
      if (t.type === 'test' && t.testResults) {
        extraInfo = `
          <div class="test-results">
            <div class="test-result-row">
              <span>ØµØ­ÛŒØ­: ${t.testResults.correct || 0}</span>
              <span>ØºÙ„Ø·: ${t.testResults.wrong || 0}</span>
              <span>Ù†Ø²Ø¯Ù‡: ${t.testResults.blank || 0}</span>
            </div>
          </div>
        `;
      } else if (t.type === 'exam' && t.examScores) {
        extraInfo = `
          <div class="exam-scores">
            ${Object.entries(t.examScores).map(([subject, score]) => `
              <div class="exam-score-row">
                <span>${subject}:</span>
                <span>${score}%</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      el.innerHTML = `
        <div class="flex items-center gap-3 left">
          <div class="task-checkbox ${t.completed ? 'checked' : ''}"></div>
          <div style="flex: 1;">
            <div class="task-title ${t.completed ? 'completed' : ''}">
              <span class="${taskType.class} task-type-badge">${taskType.name}</span>
              ${t.title}
            </div>
            <div class="text-slate-400 text-xs mt-1 flex flex-wrap items-center gap-2">
              ${formatShortJalali(t.dueDate)} 
              ${t.startTime ? 'â€¢ ' + t.startTime : ''}
              ${t.timeCategory ? 'â€¢ ' + t.timeCategory : ''}
              â€¢ ${getCategoryName(t.category)} 
              â€¢ ${formatTimeForDisplay(t.studyTime||0)}
              ${t.priority === 'high' ? 'â€¢ â­ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§' : t.priority === 'low' ? 'â€¢ ğŸ“ Ø§ÙˆÙ„ÙˆÛŒØª Ú©Ù…' : ''}
            </div>
            ${extraInfo}
          </div>
        </div>
        <div class="flex items-center gap-3">
          <i class="fas fa-star ${t.important ? 'text-yellow-400' : 'text-slate-400'} ml-3 cursor-pointer star"></i>
          <i class="fas fa-pen text-sky-400 cursor-pointer edit"></i>
          <i class="fas fa-trash text-slate-400 cursor-pointer delete-task"></i>
        </div>
      `;
      
      // events
      el.querySelector('.task-checkbox').addEventListener('click', ()=> toggleTaskCompletion(t.id));
      el.querySelector('.star').addEventListener('click', ()=> toggleTaskImportance(t.id));
      el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('Ø­Ø°ÙØŸ')) deleteTask(t.id); });
      el.querySelector('.edit').addEventListener('click', ()=> openTaskModal(t.id));

      // drag
      el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); el.classList.add('dragging'); });
      el.addEventListener('dragend', () => el.classList.remove('dragging'));

      taskList.appendChild(el);
    });
  }

  // Ù†Ù…Ø§ÛŒØ´ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
  document.getElementById('completed-count').textContent = completed.length;
  completed.forEach(t => {
    const el = document.createElement('div');
    el.className = 'task-item';
    
    const taskType = getTaskTypeBadge(t.type);
    
    el.innerHTML = `
      <div class="flex items-center gap-3 left">
        <div class="task-checkbox checked"></div>
        <div>
          <div class="task-title completed">
            <span class="${taskType.class} task-type-badge">${taskType.name}</span>
            ${t.title}
          </div>
          <div class="text-slate-400 text-xs mt-1">${formatShortJalali(t.dueDate)} Â· ${getCategoryName(t.category)} Â· ${formatTimeForDisplay(t.studyTime||0)}</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fas fa-undo text-sky-400 cursor-pointer undo"></i>
        <i class="fas fa-trash text-slate-400 cursor-pointer delete-task"></i>
      </div>
    `;
    el.querySelector('.undo').addEventListener('click', ()=> toggleTaskCompletion(t.id));
    el.querySelector('.delete-task').addEventListener('click', ()=> { if(confirm('Ø­Ø°ÙØŸ')) deleteTask(t.id); });
    if(completedListEl) completedListEl.appendChild(el);
  });

  updateSidebarCounts();
}

/* ---------------------------
   Charts
   --------------------------- */
let studyChart = null, progressChart = null;

function computeStudyByDateForCurrentMonth() {
  const monthDates = getCurrentMonthDates(currentMonth);
  const map = {};
  monthDates.forEach(date => { map[date] = 0; });
  
  tasks.filter(t => t.completed && t.dueDate && monthDates.includes(t.dueDate)).forEach(t => {
    const v = parseFloat(t.studyTime) || 0;
    map[t.dueDate] = (map[t.dueDate] || 0) + v;
  });
  
  // ÙÙ‚Ø· 10 ØªØ§Ø±ÛŒØ® Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù†Ù…ÙˆØ¯Ø§Ø±
  const displayDates = monthDates.slice(0, 10);
  return { dates: displayDates, data: displayDates.map(date => map[date] || 0) };
}

function computeStudyTimeByCategoryForCurrentMonth() {
  const monthDates = getCurrentMonthDates(currentMonth);
  
  const totalStudyTime = tasks
    .filter(t => t.completed && t.dueDate && monthDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  const categoryStudy = {};
  
  // Ø¯Ø³ØªÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ
  const generalTime = tasks
    .filter(t => t.completed && (!t.category || t.category === '') && t.dueDate && monthDates.includes(t.dueDate))
    .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
  
  if (generalTime > 0 || totalStudyTime === 0) {
    categoryStudy['Ø¹Ù…ÙˆÙ…ÛŒ'] = {
      time: generalTime,
      percentage: totalStudyTime > 0 ? (generalTime / totalStudyTime * 100) : 0
    };
  }
  
  // Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ
  lists.forEach(list => {
    const categoryTime = tasks
      .filter(t => t.completed && t.category === list.id && t.dueDate && monthDates.includes(t.dueDate))
      .reduce((sum, task) => sum + (parseFloat(task.studyTime) || 0), 0);
    
    if (categoryTime > 0) {
      categoryStudy[list.name] = {
        time: categoryTime,
        percentage: totalStudyTime > 0 ? (categoryTime / totalStudyTime * 100) : 0
      };
    }
  });
  
  return {
    categories: Object.keys(categoryStudy),
    percentages: Object.values(categoryStudy).map(item => Math.round(item.percentage)),
    times: Object.values(categoryStudy).map(item => item.time),
    totalStudyTime: totalStudyTime
  };
}

function renderCharts() {
  // Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
  const monthData = computeStudyByDateForCurrentMonth();
  const labels = monthData.dates.map(date => formatShortJalali(date));
  const data = monthData.data;
  const maxVal = Math.max(1, ...data);
  const suggestedMax = Math.ceil(maxVal + 0.5);

  const ctx1 = document.getElementById('studyTimeChart').getContext('2d');
  if(studyChart) studyChart.destroy();
  studyChart = new Chart(ctx1, {
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label:'Ø³Ø§Ø¹Ø§Øª Ù…Ø·Ø§Ù„Ø¹Ù‡', 
        data, 
        backgroundColor:'rgba(79,70,229,0.8)',
        borderColor: 'rgba(79,70,229,1)',
        borderWidth: 1
      }] 
    },
    options:{ 
      responsive:true, 
      scales:{ 
        y:{ 
          beginAtZero:true, 
          max:suggestedMax, 
          ticks:{ stepSize:0.5 }, 
          title:{display:true,text:'Ø³Ø§Ø¹Øª'} 
        } 
      } 
    }
  });

  // Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ÛŒ
  const categoryData = computeStudyTimeByCategoryForCurrentMonth();
  
  const displayCategories = categoryData.categories.length > 0 ? categoryData.categories : ['Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'];
  const displayPercentages = categoryData.percentages.length > 0 ? categoryData.percentages : [100];

  const ctx2 = document.getElementById('progressChart').getContext('2d');
  if(progressChart) progressChart.destroy();
  progressChart = new Chart(ctx2, {
    type:'doughnut',
    data:{ 
      labels: displayCategories, 
      datasets:[{ 
        label:'Ø¯Ø±ØµØ¯ Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡', 
        data: displayPercentages, 
        backgroundColor: [
          'rgba(79,70,229,0.8)',
          'rgba(16,185,129,0.8)',
          'rgba(245,158,11,0.8)',
          'rgba(239,68,68,0.8)',
          'rgba(139,92,246,0.8)',
          'rgba(6,182,212,0.8)'
        ],
        borderWidth: 1
      }] 
    },
    options:{ 
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          rtl: true
        }
      }
    }
  });
}

/* ---------------------------
   Stats & Sidebar
   --------------------------- */
function updateStats() {
  const monthDates = getCurrentMonthDates(currentMonth);
  const total = tasks.filter(t => t.completed && t.dueDate && monthDates.includes(t.dueDate))
                    .reduce((s,t)=> s + (parseFloat(t.studyTime)||0), 0);
  const done = tasks.filter(t=>t.completed).length;
  const prod = tasks.length ? Math.round(done / tasks.length * 100) : 0;
  document.getElementById('total-study-time').textContent = total.toFixed(1);
  document.getElementById('completed-tasks').textContent = done;
  document.getElementById('productivity-score').textContent = prod + '%';
}

function updateSidebarCounts() {
  const today = getTodayJalali();
  const monthDates = getCurrentMonthDates(currentMonth);
  
  document.getElementById('inbox-count').textContent = tasks.filter(t => !t.completed).length;
  document.getElementById('today-count').textContent = tasks.filter(t => t.dueDate === today && !t.completed).length;
  document.getElementById('month-count').textContent = tasks.filter(t => t.dueDate && monthDates.includes(t.dueDate) && !t.completed).length;
  document.getElementById('important-count').textContent = tasks.filter(t => t.important && !t.completed).length;

  // list counts
  lists.forEach(l => {
    const el = document.querySelector(`#study-lists [data-category="${l.id}"] .list-count`) || document.querySelector(`#personal-lists [data-category="${l.id}"] .list-count`);
    if(el) el.textContent = tasks.filter(t => t.category === l.id && !t.completed).length;
  });
}

/* ---------------------------
   Task Actions
   --------------------------- */
function toggleTaskCompletion(id) {
  const t = tasks.find(x=>x.id===id); 
  if(!t) return;
  
  t.completed = !t.completed;
  if(t.completed && !t.dueDate) t.dueDate = getTodayJalali();
  
  saveAll(); 
  renderTasks(); 
  renderCalendar(); 
  renderCharts(); 
  updateStats();
  
  updateUserStats();
  if (currentView === 'league') {
    renderLeagueView();
  }
}

function toggleTaskImportance(id) { 
  const t = tasks.find(x=>x.id===id); 
  if(!t) return; 
  t.important = !t.important; 
  saveAll(); 
  renderTasks(); 
  updateSidebarCounts(); 
}

function deleteTask(id) { 
  tasks = tasks.filter(t=>t.id!==id); 
  saveAll(); 
  renderTasks(); 
  renderCalendar(); 
  renderCharts(); 
  updateStats();
}

/* ---------------------------
   Task Modal
   --------------------------- */
function openTaskModal(taskId=null) {
  editingTaskId = taskId;
  populateCategorySelect();
  
  // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ²
  const today = getTodayJalali();
  const todayInput = new persianDate(today).format('YYYY/MM/DD');
  
  // Ù†Ù…Ø§ÛŒØ´/Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù†ÙˆØ¹ ØªØ³Ú©
  const taskTypeInput = document.getElementById('taskTypeInput');
  const testResultsSection = document.getElementById('testResultsSection');
  const examScoresSection = document.getElementById('examScoresSection');
  
  taskTypeInput.addEventListener('change', function() {
    if (this.value === 'test') {
      testResultsSection.style.display = 'block';
      examScoresSection.style.display = 'none';
    } else if (this.value === 'exam') {
      testResultsSection.style.display = 'none';
      examScoresSection.style.display = 'block';
    } else {
      testResultsSection.style.display = 'none';
      examScoresSection.style.display = 'none';
    }
  });
  
  if(taskId) {
    const t = tasks.find(x=>x.id===taskId); 
    if(!t) return;
    
    document.getElementById('taskModalTitle').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ³Ú©';
    document.getElementById('taskTitleInput').value = t.title;
    document.getElementById('taskDescriptionInput').value = t.description || '';
    document.getElementById('taskDueDateInput').value = t.dueDate ? new persianDate(t.dueDate).format('YYYY/MM/DD') : todayInput;
    document.getElementById('taskStartTimeInput').value = t.startTime || '';
    document.getElementById('taskStudyTimeInput').value = t.studyTime || 1;
    document.getElementById('taskTimeCategoryInput').value = t.timeCategory || 'morning';
    document.getElementById('taskCategoryInput').value = t.category || '';
    document.getElementById('taskPriorityInput').value = t.priority || 'medium';
    document.getElementById('taskTypeInput').value = t.type || 'lesson';
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ ØªØ³Ú©
    if (t.type === 'test' && t.testResults) {
      testResultsSection.style.display = 'block';
      document.getElementById('testCorrectInput').value = t.testResults.correct || 0;
      document.getElementById('testWrongInput').value = t.testResults.wrong || 0;
      document.getElementById('testBlankInput').value = t.testResults.blank || 0;
    } else if (t.type === 'exam' && t.examScores) {
      examScoresSection.style.display = 'block';
      document.getElementById('examPhysicsInput').value = t.examScores.physics || 0;
      document.getElementById('examChemistryInput').value = t.examScores.chemistry || 0;
      document.getElementById('examBiologyInput').value = t.examScores.biology || 0;
      document.getElementById('examMathInput').value = t.examScores.math || 0;
      document.getElementById('examGeologyInput').value = t.examScores.geology || 0;
    }
  } else {
    document.getElementById('taskModalTitle').textContent = 'Ø§ÛŒØ¬Ø§Ø¯ ØªØ³Ú© Ø¬Ø¯ÛŒØ¯';
    document.getElementById('taskTitleInput').value = '';
    document.getElementById('taskDescriptionInput').value = '';
    document.getElementById('taskDueDateInput').value = todayInput;
    document.getElementById('taskStartTimeInput').value = '';
    document.getElementById('taskStudyTimeInput').value = 1;
    document.getElementById('taskTimeCategoryInput').value = 'morning';
    document.getElementById('taskCategoryInput').value = '';
    document.getElementById('taskPriorityInput').value = 'medium';
    document.getElementById('taskTypeInput').value = 'lesson';
    
    // Ø±ÛŒØ³Øª Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ùˆ Ø¢Ø²Ù…ÙˆÙ†
    testResultsSection.style.display = 'none';
    examScoresSection.style.display = 'none';
    document.getElementById('testCorrectInput').value = 0;
    document.getElementById('testWrongInput').value = 0;
    document.getElementById('testBlankInput').value = 0;
    document.getElementById('examPhysicsInput').value = 0;
    document.getElementById('examChemistryInput').value = 0;
    document.getElementById('examBiologyInput').value = 0;
    document.getElementById('examMathInput').value = 0;
    document.getElementById('examGeologyInput').value = 0;
  }
  
  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ datepicker
  $('.datepicker').pDatepicker({
    format: 'YYYY/MM/DD',
    initialValue: false,
    autoClose: true
  });
  
  document.getElementById('taskModal').style.display = 'flex';
}

function saveTaskFromModal() {
  const title = document.getElementById('taskTitleInput').value.trim();
  if(!title){ alert('Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  
  const desc = document.getElementById('taskDescriptionInput').value.trim();
  const dueDate = document.getElementById('taskDueDateInput').value || getTodayJalali();
  const startTime = document.getElementById('taskStartTimeInput').value || '';
  const studyTime = parseFloat(document.getElementById('taskStudyTimeInput').value) || 0;
  const timeCategory = document.getElementById('taskTimeCategoryInput').value || 'morning';
  const category = document.getElementById('taskCategoryInput').value || '';
  const priority = document.getElementById('taskPriorityInput').value || 'medium';
  const type = document.getElementById('taskTypeInput').value || 'lesson';
  
  // ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ø² Ø¹Ù†ÙˆØ§Ù†
  let autoCategory = category;
  if (!autoCategory) {
    autoCategory = detectCategoryFromTitle(title);
  }
  
  // ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø±Ø³ Ø§Ø² Ø¹Ù†ÙˆØ§Ù†
  const subject = detectSubjectFromTitle(title);
  
  // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª ÛŒØ§ Ø¢Ø²Ù…ÙˆÙ†
  let testResults = null;
  let examScores = null;
  
  if (type === 'test') {
    testResults = {
      correct: parseInt(document.getElementById('testCorrectInput').value) || 0,
      wrong: parseInt(document.getElementById('testWrongInput').value) || 0,
      blank: parseInt(document.getElementById('testBlankInput').value) || 0
    };
  } else if (type === 'exam') {
    examScores = {
      physics: parseInt(document.getElementById('examPhysicsInput').value) || 0,
      chemistry: parseInt(document.getElementById('examChemistryInput').value) || 0,
      biology: parseInt(document.getElementById('examBiologyInput').value) || 0,
      math: parseInt(document.getElementById('examMathInput').value) || 0,
      geology: parseInt(document.getElementById('examGeologyInput').value) || 0
    };
  }
  
  if(editingTaskId) {
    const t = tasks.find(x=>x.id===editingTaskId); 
    if(!t) return;
    
    t.title = title; 
    t.description = desc; 
    t.dueDate = dueDate; 
    t.startTime = startTime;
    t.studyTime = studyTime; 
    t.timeCategory = timeCategory;
    t.category = autoCategory;
    t.priority = priority;
    t.type = type;
    t.testResults = testResults;
    t.examScores = examScores;
    t.subject = subject;
    
    editingTaskId = null;
  } else {
    tasks.push({ 
      id: genId(), 
      title, 
      description: desc, 
      completed: false, 
      important: false, 
      category: autoCategory, 
      dueDate, 
      startTime,
      studyTime, 
      timeCategory,
      priority,
      type,
      testResults,
      examScores,
      subject,
      createdAt: new Date().toISOString() 
    });
  }
  
  saveAll(); 
  closeModal('taskModal'); 
  renderTasks(); 
  renderCalendar(); 
  renderCharts(); 
  updateStats(); 
  updateSidebarCounts();
}

/* ---------------------------
   Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ
   --------------------------- */
function renderLeagueView() {
  updateUserStats();
  
  document.getElementById('league-name').textContent = getLeagueName(userStats.league);
  document.getElementById('league-icon').className = `fas ${getLeagueIcon(userStats.league)} league-icon`;
  document.getElementById('league-points').textContent = `Ø§Ù…ØªÛŒØ§Ø²: ${userStats.points}`;
  document.getElementById('daily-hours').textContent = userStats.dailyHours.toFixed(1);
  document.getElementById('weekly-hours').textContent = userStats.monthlyHours.toFixed(1);
  document.getElementById('streak-days').textContent = userStats.streak;
  
  const progress = calculateLeagueProgress();
  document.getElementById('league-progress-bar').style.width = `${progress}%`;
  document.getElementById('league-progress-bar').style.background = getLeagueColor(userStats.league);
  document.getElementById('league-next').textContent = `${progress}%`;
  
  renderBadges();
  renderSubjectPredictions();
  renderAchievements();
}

function getLeagueName(league) {
  const names = {
    'legendary': 'Ø§ÙØ³Ø§Ù†Ù‡â€ŒØ§ÛŒ',
    'professional': 'Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ',
    'beginner': 'Ù…Ø¨ØªØ¯ÛŒ',
    'training': 'Ø¢Ù…ÙˆØ²Ø´ÛŒ'
  };
  return names[league] || 'Ø¢Ù…ÙˆØ²Ø´ÛŒ';
}

function getLeagueIcon(league) {
  const icons = {
    'legendary': 'fa-crown',
    'professional': 'fa-medal',
    'beginner': 'fa-award',
    'training': 'fa-user-graduate'
  };
  return icons[league] || 'fa-user-graduate';
}

function getLeagueColor(league) {
  const colors = {
    'legendary': '#ffd700',
    'professional': '#c0c0c0',
    'beginner': '#cd7f32',
    'training': '#4f46e5'
  };
  return colors[league] || '#4f46e5';
}

function calculateLeagueProgress() {
  const nextLeagueThreshold = getNextLeagueThreshold();
  if (!nextLeagueThreshold) return 100;
  
  const progress = (userStats.monthlyHours / nextLeagueThreshold) * 100;
  return Math.min(100, Math.round(progress));
}

function getNextLeagueThreshold() {
  const thresholds = {
    'training': 40,
    'beginner': 80,
    'professional': 120,
    'legendary': null
  };
  
  return thresholds[userStats.league];
}

function renderBadges() {
  const container = document.getElementById('badges-container');
  container.innerHTML = '';
  
  if (userStats.badges.length === 0) {
    container.innerHTML = '<div class="text-slate-400 text-center py-4">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù†Ø´Ø§Ù†â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</div>';
    return;
  }
  
  userStats.badges.forEach(badge => {
    const badgeEl = document.createElement('div');
    badgeEl.className = 'badge bg-green-500 text-white';
    badgeEl.title = badge.description;
    
    badgeEl.innerHTML = `
      <i class="fas ${badge.icon} badge-icon"></i>
      <span>${badge.name}</span>
    `;
    
    container.appendChild(badgeEl);
  });
}

function renderAchievements() {
  const container = document.getElementById('league-rankings');
  container.innerHTML = '';
  
  const achievements = [
    {
      title: 'ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
      value: userStats.completedTasks,
      target: 100,
      icon: 'fa-check-circle',
      color: '#10b981'
    },
    {
      title: 'Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡',
      value: userStats.streak,
      target: 30,
      icon: 'fa-fire',
      color: '#f59e0b'
    },
    {
      title: 'Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡',
      value: userStats.monthlyHours,
      target: 120,
      icon: 'fa-clock',
      color: '#4f46e5'
    },
    {
      title: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡',
      value: userStats.dailyHours,
      target: 4,
      icon: 'fa-chart-line',
      color: '#8b5cf6'
    }
  ];
  
  achievements.forEach(achievement => {
    const progress = Math.min(100, (achievement.value / achievement.target) * 100);
    
    const achievementEl = document.createElement('div');
    achievementEl.className = 'ranking-card';
    
    achievementEl.innerHTML = `
      <div class="ranking-avatar" style="background: ${achievement.color}">
        <i class="fas ${achievement.icon}"></i>
      </div>
      <div class="ranking-info">
        <div class="ranking-name">${achievement.title}</div>
        <div class="ranking-stats">${achievement.value.toFixed(1)} Ø§Ø² ${achievement.target}</div>
        <div class="league-progress mt-2">
          <div class="league-progress-bar" style="width: ${progress}%; background: ${achievement.color}"></div>
        </div>
      </div>
      <div class="ranking-position">${Math.round(progress)}%</div>
    `;
    
    container.appendChild(achievementEl);
  });
}

/* ---------------------------
   Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡
   --------------------------- */
function generateMonthlyReport() {
  const monthDates = getCurrentMonthDates(currentMonth);
  const completedTasks = tasks.filter(t => t.completed && t.dueDate && monthDates.includes(t.dueDate));
  
  completedTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  
  const monthName = getMonthName(currentMonth);
  document.getElementById('report-month-range').textContent = `Ù…Ø§Ù‡: ${monthName}`;
  
  const now = new persianDate();
  document.getElementById('report-generation-date').textContent = 
    `ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: ${now.format('jDD jMMMM jYYYY')}`;
  
  document.getElementById('report-footer-date').textContent = now.format('jDD jMMMM jYYYY');

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±
  const totalTasks = completedTasks.length;
  const totalTime = completedTasks.reduce((sum, task) => sum + (task.studyTime || 0), 0);
  const avgTime = totalTasks > 0 ? (totalTime / monthDates.length).toFixed(1) : 0;

  document.getElementById('report-total-tasks').textContent = totalTasks;
  document.getElementById('report-total-time').textContent = totalTime.toFixed(1) + ' Ø³Ø§Ø¹Øª';
  document.getElementById('report-avg-time').textContent = avgTime + ' Ø³Ø§Ø¹Øª';

  // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ ØªØ³Ú©â€ŒÙ‡Ø§
  const tasksTable = document.getElementById('report-tasks-table');
  tasksTable.innerHTML = '';
  
  if (completedTasks.length === 0) {
    tasksTable.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
          Ù‡ÛŒÚ† ØªØ³Ú© ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
        </td>
      </tr>
    `;
  } else {
    let rowIndex = 1;
    
    completedTasks.forEach(task => {
      const taskType = getTaskTypeBadge(task.type);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rowIndex}</td>
        <td>${task.title}</td>
        <td>${taskType.name}</td>
        <td>${getCategoryName(task.category)}</td>
        <td>${formatJalaliDate(task.dueDate)}</td>
        <td>${formatTimeForDisplay(task.studyTime || 0)}</td>
        <td>${task.description || '-'}</td>
      `;
      tasksTable.appendChild(row);
      rowIndex++;
    });
  }

  // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ùˆ Ù¾Ø±ÛŒÙ†Øª
  document.getElementById('printReport').style.display = 'block';
  setTimeout(() => {
    window.print();
    setTimeout(() => {
      document.getElementById('printReport').style.display = 'none';
    }, 100);
  }, 500);
}

/* ---------------------------
   UI Functions
   --------------------------- */
function renderSidebarLists() {
  const studyEl = document.getElementById('study-lists');
  const personalEl = document.getElementById('personal-lists');
  studyEl.innerHTML = '';
  personalEl.innerHTML = '';

  // Ø¯Ø³ØªÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ
  const generalTasksCount = tasks.filter(t => !t.completed && (!t.category || t.category === '')).length;
  const generalCompletedCount = tasks.filter(t => t.completed && (!t.category || t.category === '')).length;
  
  const generalEl = document.createElement('div');
  generalEl.className = 'list-item';
  generalEl.dataset.category = 'general';
  generalEl.innerHTML = `
    <div class="list-item-content">
      <i class="fas fa-list ml-3" style="color:#6b7280"></i>
      <span>Ø¹Ù…ÙˆÙ…ÛŒ</span>
      <span class="list-count">${generalTasksCount}</span>
    </div>
    <div class="flex items-center gap-1">
      <span class="text-xs text-green-400">${generalCompletedCount}</span>
    </div>
  `;
  
  generalEl.addEventListener('click', () => { setActiveView('category', 'general'); });
  studyEl.appendChild(generalEl);

  // Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  lists.forEach(l => {
    const tasksCount = tasks.filter(t => !t.completed && t.category === l.id).length;
    const completedCount = tasks.filter(t => t.completed && t.category === l.id).length;
    
    const el = document.createElement('div');
    el.className = 'list-item';
    el.dataset.category = l.id;

    const left = document.createElement('div');
    left.className = 'list-item-content';
    left.innerHTML = `<i class="fas ${getCategoryIcon(l.id)} ml-3" style="color:${l.color}"></i><span>${l.name}</span><span class="list-count">${tasksCount}</span>`;

    const controls = document.createElement('div');
    controls.className = 'list-controls';
    controls.innerHTML = `
      <button class="list-menu-btn" title="Ø¨ÛŒØ´ØªØ±"><i class="fas fa-ellipsis-v"></i></button>
      <div class="list-menu" style="margin-top:-30px;">
        <button class="edit-list">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="delete-list text-red-400">Ø­Ø°Ù</button>
      </div>
    `;

    const completedDiv = document.createElement('div');
    completedDiv.className = 'flex items-center gap-1 ml-3';
    completedDiv.innerHTML = `<span class="text-xs text-green-400">${completedCount}</span>`;

    el.appendChild(left);
    el.appendChild(completedDiv);
    el.appendChild(controls);

    left.addEventListener('click', () => { setActiveView('category', l.id); });

    controls.querySelector('.edit-list').addEventListener('click', (e) => {
      e.stopPropagation();
      openListModal(l.id);
    });

    controls.querySelector('.delete-list').addEventListener('click', (e) => {
      e.stopPropagation();
      if(!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù„ÛŒØ³Øª "${l.name}" Ùˆ ØªÙ…Ø§Ù… ØªØ³Ú©â€ŒÙ‡Ø§ÛŒØ´ Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ`)) return;
      tasks = tasks.filter(t => t.category !== l.id);
      lists = lists.filter(x => x.id !== l.id);
      saveAll();
      renderSidebarLists();
      updateStats();
      updateSidebarCounts();
      if(currentView === 'category' && currentCategory === l.id) { setActiveView('inbox'); }
      renderAll();
    });

    if(['shopping','home'].includes(l.id)) personalEl.appendChild(el); 
    else studyEl.appendChild(el);
  });
}

function populateCategorySelect() {
  const sel = document.getElementById('taskCategoryInput');
  sel.innerHTML = '';
  
  const opt0 = document.createElement('option'); 
  opt0.value = ''; 
  opt0.textContent = 'ğŸ¯ Ø¹Ù…ÙˆÙ…ÛŒ (Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡)'; 
  sel.appendChild(opt0);
  
  if (lists.length === 0) {
    const optInfo = document.createElement('option');
    optInfo.value = '';
    optInfo.textContent = 'ğŸ“ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù„ÛŒØ³Øª Ø¯Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯';
    optInfo.disabled = true;
    sel.appendChild(optInfo);
  } else {
    const studyLists = lists.filter(l => !['shopping','home'].includes(l.id));
    const personalLists = lists.filter(l => ['shopping','home'].includes(l.id));
    
    if (studyLists.length > 0) {
      const optgroupStudy = document.createElement('optgroup');
      optgroupStudy.label = 'ğŸ“š Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ';
      studyLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        o.textContent = l.name;
        optgroupStudy.appendChild(o);
      });
      sel.appendChild(optgroupStudy);
    }
    
    if (personalLists.length > 0) {
      const optgroupPersonal = document.createElement('optgroup');
      optgroupPersonal.label = 'ğŸ  Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ';
      personalLists.forEach(l => {
        const o = document.createElement('option');
        o.value = l.id;
        o.textContent = l.name;
        optgroupPersonal.appendChild(o);
      });
      sel.appendChild(optgroupPersonal);
    }
  }
}

function setActiveView(view, category='') {
  currentView = view;
  if(view === 'category'){
    currentView = 'category';
    currentCategory = category;
  } else { 
    currentCategory = ''; 
  }
  
  document.querySelectorAll('.list-item').forEach(x => x.classList.remove('active'));
  
  if(view && view !== 'category'){
    const el = document.querySelector(`.list-item[data-view="${view}"]`);
    if(el) el.classList.add('active');
  } else if(view === 'category' && category){
    const el = document.querySelector(`.list-item[data-category="${category}"]`);
    if(el) el.classList.add('active');
  }
  
  if (view === 'league') {
    document.getElementById('tasks-view').style.display = 'none';
    document.getElementById('league-view').style.display = 'block';
    renderLeagueView();
  } else {
    document.getElementById('tasks-view').style.display = 'block';
    document.getElementById('league-view').style.display = 'none';
    renderTasks();
  }
  
  updateCurrentListTitle();
}

function updateCurrentListTitle() {
  const titleEl = document.getElementById('current-list-title');
  if (currentView === 'category' && currentCategory === 'general') {
    titleEl.textContent = 'Ø¹Ù…ÙˆÙ…ÛŒ';
  } else if (currentView === 'category' && currentCategory) {
    const list = lists.find(l => l.id === currentCategory);
    titleEl.textContent = list ? list.name : 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ';
  } else if (currentView === 'league') {
    titleEl.textContent = 'Ù„ÛŒÚ¯ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ';
  } else {
    const viewTitles = {
      'inbox': 'ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ',
      'today': 'Ø§Ù…Ø±ÙˆØ²', 
      'month': 'Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ',
      'important': 'Ù…Ù‡Ù…'
    };
    titleEl.textContent = viewTitles[currentView] || 'ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ';
  }
}

function renderAll() {
  renderSidebarLists();
  renderTasks();
  renderCalendar();
  renderCharts();
  updateStats();
  updateSidebarCounts();
}

/* ---------------------------
   Event Listeners
   --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  renderAll();

  // close notification
  document.getElementById('notification-close').addEventListener('click', hideNotification);

  // add list button
  document.getElementById('addListBtn').addEventListener('click', () => openListModal(null));
  document.getElementById('saveListBtn').addEventListener('click', () => {saveListFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelListBtn').addEventListener('click', () => { editingListId = null; closeModal('listModal'); });
  document.getElementById('listModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('listModal')) closeModal('listModal'); });

  // open task modal
  document.getElementById('openTaskModal').addEventListener('click', () => openTaskModal(null));
  document.getElementById('saveTaskBtn').addEventListener('click',() =>{ saveTaskFromModal();updateStats();updateSidebarCounts();});
  document.getElementById('cancelTaskBtn').addEventListener('click', () => { editingTaskId = null; closeModal('taskModal'); });
  document.getElementById('taskModal').addEventListener('click', (e)=> { if(e.target === document.getElementById('taskModal')) { editingTaskId=null; closeModal('taskModal'); } });

  // quick add
  document.getElementById('new-task-input').addEventListener('keypress', function(e){
    if(e.key === 'Enter' && this.value.trim() !== ''){
      const title = this.value.trim();
      const autoCategory = detectCategoryFromTitle(title);
      
      tasks.push({ 
        id: genId(), 
        title, 
        description:'', 
        completed:false, 
        important:false, 
        category: autoCategory, 
        dueDate: getTodayJalali(), 
        startTime: null,
        studyTime:1, 
        timeCategory: 'morning',
        priority: 'medium',
        type: 'lesson',
        createdAt:new Date().toISOString() 
      });
      
      saveAll();
      this.value = '';
      renderTasks(); 
      renderCalendar(); 
      renderCharts(); 
      updateStats(); 
      updateSidebarCounts();
    }
  });

  // search
  document.getElementById('searchInput').addEventListener('input', () => renderTasks());

  // view buttons
  document.getElementById('view-inbox').addEventListener('click', ()=> setActiveView('inbox'));
  document.getElementById('view-today').addEventListener('click', ()=> setActiveView('today'));
  document.getElementById('view-month').addEventListener('click', ()=> setActiveView('month'));
  document.getElementById('view-important').addEventListener('click', ()=> setActiveView('important'));
  document.getElementById('view-league').addEventListener('click', ()=> setActiveView('league'));

  // month nav
  document.getElementById('prev-month').addEventListener('click', ()=> { currentMonth--; renderCalendar(); renderCharts(); updateStats(); });
  document.getElementById('next-month').addEventListener('click', ()=> { currentMonth++; renderCalendar(); renderCharts(); updateStats(); });

  // ØªØºÛŒÛŒØ± ØªÙ…
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡
  document.getElementById('printReportBtn').addEventListener('click', generateMonthlyReport);
});

/* ---------------------------
   Utility Functions
   --------------------------- */
function closeModal(id){ document.getElementById(id).style.display = 'none'; }

function openListModal(listId = null){
  editingListId = listId;
  document.getElementById('listModalTitle').textContent = listId ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ³Øª' : 'Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ³Øª Ø¬Ø¯ÛŒØ¯';
  if(listId){
    const l = lists.find(x=>x.id===listId);
    if(!l) return;
    document.getElementById('listNameInput').value = l.name;
    document.getElementById('listColorInput').value = l.color || '#4f46e5';
  } else {
    document.getElementById('listNameInput').value = '';
    document.getElementById('listColorInput').value = '#4f46e5';
  }
  document.getElementById('listModal').style.display = 'flex';
}

function saveListFromModal(){
  const name = document.getElementById('listNameInput').value.trim();
  const color = document.getElementById('listColorInput').value || '#4f46e5';
  if(!name){ alert('Ù†Ø§Ù… Ù„ÛŒØ³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  if(editingListId){
    const l = lists.find(x=>x.id===editingListId); if(!l) return;
    l.name = name; l.color = color; editingListId = null;
  } else {
    lists.push({ id: genId(), name, color });
  }
  saveAll(); closeModal('listModal'); renderSidebarLists(); populateCategorySelect(); renderTasks(); renderCharts(); updateSidebarCounts();
}
</script>
</body>
</html>
