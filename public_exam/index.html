<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>آزمون خود ارزیابی پیشرفته</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --danger-color: #ef4444;
      --dark-bg: #0f172a;
      --card-bg: #1e293b;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-success: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
    }
    
    .floating-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      position: relative;
    }
    
    .floating-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 0;
    }
    
    .floating-card:hover::before {
      opacity: 1;
    }
    
    .floating-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.3),
          0 0 80px rgba(99, 102, 241, 0.1);
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
    }
    
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(1deg); }
      100% { transform: translateY(0px) rotate(0deg); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    
    .bounce-in {
      animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .gradient-text {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .input-field {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      width: 100%;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
      background: rgba(255, 255, 255, 0.08);
    }
    
    /* حذف فلش‌های input عددی */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    /* طراحی مربع‌های نرم برای گزینه‌ها */
    .option-container {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .option-input {
      display: none;
    }
    
    .option-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      background-color: rgba(255, 255, 255, 0.05);
      position: relative;
    }
    
    .option-number {
      color: #9ca3af;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    /* حالت انتخاب عادی */
    .option-box.selected {
      border-color: var(--primary-color);
      background-color: rgba(99, 102, 241, 0.2);
    }
    
    .option-box.selected .option-number {
      color: white;
      font-weight: bold;
    }
    
    /* حالت‌های مختلف پس از تصحیح */
    .option-box.correct {
      border-color: var(--secondary-color);
      background-color: rgba(16, 185, 129, 0.3);
      transform: scale(1.05);
    }
    
    .option-box.correct .option-number {
      color: white;
      font-weight: bold;
    }
    
    .option-box.wrong {
      border-color: var(--danger-color);
      background-color: rgba(239, 68, 68, 0.3);
    }
    
    .option-box.wrong .option-number {
      color: white;
      font-weight: bold;
    }
    
    .option-box.blank {
      border-color: var(--primary-color);
      background-color: rgba(99, 102, 241, 0.1);
    }
    
    /* انیمیشن کلیک */
    @keyframes clickAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    
    .option-box:active {
      animation: clickAnimation 0.3s ease;
    }
    
    /* تایمر ثابت */
    #timer {
      position: sticky;
      top: 20px;
      z-index: 50;
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }
    
    /* کارت نتیجه سوال */
    .question-result {
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
      display: none;
      font-size: 0.875rem;
    }
    
    .question-result.correct {
      background-color: rgba(16, 185, 129, 0.1);
      border-right: 4px solid var(--secondary-color);
    }
    
    .question-result.wrong {
      background-color: rgba(239, 68, 68, 0.1);
      border-right: 4px solid var(--danger-color);
    }
    
    .question-result.blank {
      background-color: rgba(156, 163, 175, 0.1);
      border-right: 4px solid #9ca3af;
    }
    
    /* انیمیشن‌ها */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    
    /* دکمه بازگشت به بالا */
    .back-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 99;
    }
    
    .back-to-top.visible {
      opacity: 1;
    }
    
    /* کارت‌های آزمون */
    .exam-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    /* بخش تنظیمات */
    #setup {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* نتایج */
    #results {
      margin-top: 2rem;
    }
    
    /* کارت تحلیل درس */
    .subject-analysis {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* نوار پیشرفت */
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      transition: width 0.6s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    /* راهنمای نمره دهی */
    .grading-guide {
      border-right: 4px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(30, 41, 59, 0.5);
    }
    
    /* انیمیشن نوسان */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .animate-pulse {
      animation: pulse 2s infinite;
    }
    
    /* شکل‌های شناور در پس‌زمینه */
    .floating-shapes {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .floating-shape {
      position: absolute;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      opacity: 0.1;
      animation: float-shape 15s infinite linear;
    }
    
    @keyframes float-shape {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(20px, 40px) rotate(90deg); }
      50% { transform: translate(40px, 20px) rotate(180deg); }
      75% { transform: translate(20px, 0px) rotate(270deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    .shape-1 {
      width: 120px;
      height: 120px;
      background: var(--gradient-primary);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .shape-2 {
      width: 80px;
      height: 80px;
      background: var(--gradient-secondary);
      top: 70%;
      left: 80%;
      animation-delay: -5s;
    }
    
    .shape-3 {
      width: 100px;
      height: 100px;
      background: var(--gradient-accent);
      top: 40%;
      left: 70%;
      animation-delay: -10s;
    }
    
    .shape-4 {
      width: 90px;
      height: 90px;
      background: var(--gradient-success);
      top: 80%;
      left: 20%;
      animation-delay: -7s;
    }
    
    /* استایل‌های جدید برای پیام تأیید */
    .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--gradient-success);
      color: white;
      padding: 1rem 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .success-message.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .success-message i {
      margin-left: 0.5rem;
      font-size: 1.2rem;
    }
    
    /* استایل‌های واکنش‌گرا */
    @media (max-width: 768px) {
      .exam-card {
        padding: 1rem;
      }
      
      .option-box {
        width: 35px;
        height: 35px;
      }
      
      .btn-primary {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
      
      .input-field {
        padding: 0.75rem;
      }
      
      #timer {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .option-box {
        width: 30px;
        height: 30px;
      }
      
      .option-number {
        font-size: 0.8rem;
      }
      
      .exam-card h3 {
        font-size: 1.1rem;
      }
    }
    
    /* استایل‌های پرینت */
    @media print {
      body {
        background: white !important;
        color: black !important;
        font-family: 'Vazirmatn', sans-serif;
      }
      
      .no-print {
        display: none !important;
      }
      
      .print-container {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
      }
      
      .print-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #333;
      }
      
      .print-header h1 {
        color: #333 !important;
        font-size: 24px;
        margin-bottom: 0.5rem;
      }
      
      .print-header p {
        color: #666 !important;
        font-size: 14px;
      }
      
      .print-section {
        margin-bottom: 1.5rem;
        page-break-inside: avoid;
      }
      
      .print-section h2 {
        color: #333 !important;
        font-size: 18px;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ddd;
      }
      
      .print-card {
        background: white !important;
        border: 1px solid #ddd !important;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      
      .print-table th,
      .print-table td {
        border: 1px solid #ddd;
        padding: 0.5rem;
        text-align: center;
      }
      
      .print-table th {
        background-color: #f5f5f5;
        font-weight: bold;
      }
      
      .print-progress {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin: 0.5rem 0;
      }
      
      .print-progress-fill {
        height: 100%;
        background-color: #4caf50;
      }
      
      .print-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
      }
      
      .print-summary-item {
        text-align: center;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      
      .print-summary-item .value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      
      .print-summary-item .label {
        font-size: 14px;
        color: #666;
      }
      
      .page-break {
        page-break-before: always;
      }
      
      .floating-shapes,
      .back-to-top,
      #setup,
      #timer,
      #exam,
      #answerKeys,
      .btn-primary {
        display: none !important;
      }
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <!-- شکل‌های شناور در پس‌زمینه -->
  <div class="floating-shapes">
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
    <div class="floating-shape shape-4"></div>
  </div>

  <!-- دکمه بازگشت به بالا -->
  <div id="backToTop" class="back-to-top">
    <i class="fas fa-arrow-up"></i>
  </div>

  <div class="max-w-4xl w-full mx-auto relative z-10">
    <div class="text-center mb-8 animate-fade-in">
      <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
        <i class="fas fa-file-alt ml-2"></i>آزمون خود ارزیابی پیشرفته
      </h1>
      <p class="text-gray-400">طراحی شده برای ارزیابی جامع دروس مختلف</p>
    </div>

    <!-- Setup -->
    <div id="setup" class="glass-effect space-y-4">
      <h2 class="text-2xl font-bold mb-4 text-green-400 flex items-center">
        <i class="fas fa-cog ml-2"></i>تنظیمات آزمون
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-300 mb-1">زیست‌شناسی:</label>
          <input type="number" id="bioCount" min="0" value="0" 
                 class="input-field">
        </div>
        
        <div>
          <label class="block text-gray-300 mb-1">فیزیک:</label>
          <input type="number" id="physCount" min="0" value="0" 
                 class="input-field">
        </div>
        
        <div>
          <label class="block text-gray-300 mb-1">شیمی:</label>
          <input type="number" id="chemCount" min="0" value="0" 
                 class="input-field">
        </div>
        
        <div>
          <label class="block text-gray-300 mb-1">ریاضی:</label>
          <input type="number" id="mathCount" min="0" value="0" 
                 class="input-field">
        </div>
                
        <div>
          <label class="block text-gray-300 mb-1">زمین‌شناسی:</label>
          <input type="number" id="geoCount" min="0" value="0" 
                 class="input-field">
        </div>
        <div>
          <label class="block text-gray-300 mb-1">مدت آزمون (دقیقه):</label>
          <input type="number" id="examTime" min="1" value="30" 
                 class="input-field">
        </div>
      </div>
      <button onclick="generateExam()" 
              class="btn-primary mt-4 w-full">
        <i class="fas fa-play ml-2"></i> شروع آزمون
      </button>
    </div>

    <!-- Timer -->
    <div id="timer" class="hidden">
      <i class="fas fa-clock text-green-400 ml-2"></i>
      <span id="time-display">00:00</span>
    </div>

    <!-- Exam -->
    <div id="exam" class="space-y-6"></div>

    <!-- Answer Key -->
    <div id="answerKeys" class="hidden glass-effect p-6 mt-8">
      <h2 class="text-2xl font-bold mb-4 text-green-300 flex items-center">
        <i class="fas fa-key ml-2"></i> کلید پاسخ‌ها
      </h2>
      <div id="keyInputs" class="space-y-6"></div>
      <button onclick="gradeExam()" 
              class="btn-primary mt-6 w-full">
        <i class="fas fa-check-circle ml-2"></i> تصحیح آزمون
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="mt-8 space-y-6"></div>
    
    <!-- دکمه پرینت -->
    <div id="printSection" class="hidden mt-8 text-center">
      <button onclick="printResults()" class="btn-primary no-print">
        <i class="fas fa-print ml-2"></i> پرینت کارنامه
      </button>
    </div>
  </div>

  <!-- بخش پرینت -->
  <div id="printContent" class="print-container" style="display: none;"></div>

  <script>
    const subjects = [
      { name: "زیست‌شناسی", id: "bioCount", icon: "fas fa-dna", color: "from-green-400 to-emerald-500" },
      { name: "فیزیک", id: "physCount", icon: "fas fa-atom", color: "from-blue-400 to-cyan-500" },
      { name: "شیمی", id: "chemCount", icon: "fas fa-flask", color: "from-purple-400 to-pink-500" },
      { name: "ریاضی", id: "mathCount", icon: "fas fa-square-root-alt", color: "from-yellow-400 to-orange-500" },
      { name: "زمین‌شناسی", id: "geoCount", icon: "fas fa-mountain", color: "from-orange-400 to-red-500" },
    ];

    let examStructure = [];
    let timerInterval;
    let timeLeft = 0;
    let selectedOptions = {};
    let globalQuestionCounter = 1; // شمارنده سراسری سوالات

    function generateExam() {
  clearInterval(timerInterval);
  examStructure = [];
  selectedOptions = {};
  globalQuestionCounter = 1; // بازنشانی شمارنده
  const examDiv = document.getElementById('exam');
  examDiv.innerHTML = '';
  const keyInputsDiv = document.getElementById('keyInputs');
  keyInputsDiv.innerHTML = '';

  subjects.forEach(subject => {
    const count = parseInt(document.getElementById(subject.id).value);
    if (count > 0) {
      const startQuestion = globalQuestionCounter; // ذخیره شماره شروع قبل از افزایش
      
      examStructure.push({ 
        subject: subject.name, 
        count: count, 
        icon: subject.icon,
        color: subject.color,
        startQuestion: startQuestion // استفاده از شماره شروع ذخیره شده
      });
      
      // ایجاد کارت سوالات
      examDiv.innerHTML += `
        <div class="exam-card floating-card">
          <h3 class="text-green-300 text-xl font-bold mb-4 flex items-center">
            <i class="${subject.icon} ml-2"></i> ${subject.name}
          </h3>
          <div class="space-y-4" id="questions-${subject.name.replace(/\s+/g, '-')}">
            ${[...Array(count)].map((_, i) => {
              const questionNum = globalQuestionCounter++;
              return `
              <div class="question-item">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between bg-gray-700/30 p-4 rounded-lg gap-3">
                  <span class="text-gray-300">سوال ${questionNum}:</span>
                  <div class="flex items-center gap-3">
                    ${[1,2,3,4].map(num => `
                      <label class="option-container">
                        <input type="radio" class="option-input" name="${subject.name}-q${questionNum}" 
                               onclick="handleOptionClick('${subject.name}', ${questionNum}, ${num})">
                        <div class="option-box" data-question="${subject.name}-q${questionNum}" data-option="${num}">
                          <span class="option-number">${num}</span>
                        </div>
                      </label>
                    `).join('')}
                  </div>
                </div>
                <div class="question-result" id="result-${subject.name}-q${questionNum}"></div>
              </div>
            `}).join('')}
          </div>
        </div>`;

      // ایجاد قسمت کلید پاسخ‌ها - استفاده از startQuestion ذخیره شده
      keyInputsDiv.innerHTML += `
        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/50">
          <h4 class="text-green-400 font-bold mb-3 flex items-center">
            <i class="${subject.icon} ml-2"></i> ${subject.name}
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            ${[...Array(count)].map((_, i) => {
              const questionNum = startQuestion + i; // استفاده از startQuestion
              return `
              <div class="flex items-center">
                <label class="text-gray-300 mr-2">${questionNum}:</label>
                <input type="number" min="1" max="4" id="key-${subject.name}-q${questionNum}" 
                       class="input-field w-16 px-3 py-1 rounded-lg focus:outline-none text-center">
              </div>
            `}).join('')}
          </div>
        </div>`;
    }
  });

  document.getElementById('answerKeys').classList.remove('hidden');
  document.getElementById('results').innerHTML = '';
  document.getElementById('printSection').classList.add('hidden');
  startTimer();
  setupBackToTopButton();
  
  // اسکرول به بخش آزمون
  document.getElementById('exam').scrollIntoView({ behavior: 'smooth' });
}

    function handleOptionClick(subject, questionNum, optionNum) {
      const questionId = `${subject}-q${questionNum}`;
      
      // Reset all options for this question
      document.querySelectorAll(`.option-box[data-question="${questionId}"]`).forEach(box => {
        box.classList.remove('selected');
        box.querySelector('.option-number').classList.remove('text-white', 'font-bold');
      });
      
      // Toggle selection
      if (selectedOptions[questionId] === optionNum) {
        delete selectedOptions[questionId];
      } else {
        selectedOptions[questionId] = optionNum;
        const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${optionNum}"]`);
        if (selectedBox) {
          selectedBox.classList.add('selected');
          selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
      }
    }

    function startTimer() {
      const timeInMinutes = parseInt(document.getElementById('examTime').value);
      timeLeft = timeInMinutes * 60;
      const timerDiv = document.getElementById('timer');
      timerDiv.classList.remove('hidden');
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          showNotification("⏰ زمان آزمون به پایان رسید!");
          gradeExam();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById('time-display').innerText = 
        `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      
      if (timeLeft <= 60) {
        document.getElementById('timer').style.borderColor = 'rgba(239, 68, 68, 0.5)';
        document.getElementById('timer').style.color = '#ef4444';
      } else {
        document.getElementById('timer').style.borderColor = 'rgba(99, 102, 241, 0.3)';
        document.getElementById('timer').style.color = '#10b981';
      }
    }

    function gradeExam() {
      clearInterval(timerInterval);
  let totalCorrect = 0;
  let totalWrong = 0;
  let totalBlank = 0;
  let totalQuestions = 0;
  let resultsHTML = '';
  let subjectResults = [];

  // راهنمای نمره دهی
  resultsHTML += `
    <div class="grading-guide p-4 rounded-lg mb-6 animate-fade-in">
      <h3 class="text-lg font-bold mb-3 text-green-400 flex items-center">
        <i class="fas fa-info-circle ml-2"></i> راهنمای نمره دهی
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div class="flex items-center">
          <div class="w-3 h-3 rounded-full bg-green-500 ml-2"></div>
          <span>هر پاسخ صحیح: +1 نمره</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 rounded-full bg-red-500 ml-2"></div>
          <span>هر پاسخ غلط: -0.33 نمره</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 rounded-full bg-gray-500 ml-2"></div>
          <span>سوال نزده: 0 نمره</span>
        </div>
      </div>
    </div>`;

  // تحلیل درس به درس
  examStructure.forEach(subject => {
    let correct = 0;
    let wrong = 0;
    let blank = 0;

    for (let i = 0; i < subject.count; i++) {
      const questionNum = subject.startQuestion + i; // استفاده از startQuestion ذخیره شده
      const questionId = `${subject.subject}-q${questionNum}`;
      const selectedOption = selectedOptions[questionId];
      const correctAnswer = document.getElementById(`key-${questionId}`).value;
      const resultDiv = document.getElementById(`result-${questionId}`);

      // Reset all options for this question
      document.querySelectorAll(`.option-box[data-question="${questionId}"]`).forEach(box => {
        box.classList.remove('selected', 'correct', 'wrong', 'blank');
        box.querySelector('.option-number').className = 'option-number';
      });

      if (!selectedOption) {
        // سوال نزده
        blank++;
        const correctBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${correctAnswer}"]`);
        if (correctBox) {
          correctBox.classList.add('blank');
          correctBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
        resultDiv.className = 'question-result blank';
        resultDiv.innerHTML = `
          <div class="flex items-center text-gray-300">
            <i class="fas fa-circle ml-2"></i>
            <span>سوال نزده - پاسخ صحیح: گزینه ${correctAnswer}</span>
          </div>`;
        resultDiv.style.display = 'block';
      } else if (selectedOption == correctAnswer) {
        // سوال صحیح
        correct++;
        const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${selectedOption}"]`);
        if (selectedBox) {
          selectedBox.classList.add('correct');
          selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
        resultDiv.className = 'question-result correct';
        resultDiv.innerHTML = `
          <div class="flex items-center text-green-400">
            <i class="fas fa-check-circle ml-2"></i>
            <span>پاسخ صحیح</span>
          </div>`;
        resultDiv.style.display = 'block';
      } else {
        // سوال غلط
        wrong++;
        const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${selectedOption}"]`);
        const correctBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${correctAnswer}"]`);
        
        if (selectedBox) {
          selectedBox.classList.add('wrong');
          selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
        if (correctBox) {
          correctBox.classList.add('correct');
          correctBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
        
        resultDiv.className = 'question-result wrong';
        resultDiv.innerHTML = `
          <div class="flex items-center text-red-400">
            <i class="fas fa-times-circle ml-2"></i>
            <span>پاسخ شما: گزینه ${selectedOption} - پاسخ صحیح: گزینه ${correctAnswer}</span>
          </div>`;
        resultDiv.style.display = 'block';
      }
    }

        const rawScore = correct;
        const correctedScore = Math.max(0, correct - (wrong / 3));
        
        const rawPercentage = (correct / subject.count) * 100;
        const correctedPercentage = (correctedScore / subject.count) * 100;
        
        const wrongPercentage = (wrong / subject.count) * 100;
        const blankPercentage = (blank / subject.count) * 100;

        // ذخیره نتایج برای پرینت
        subjectResults.push({
          name: subject.subject,
          count: subject.count,
          correct: correct,
          wrong: wrong,
          blank: blank,
          rawPercentage: rawPercentage,
          correctedPercentage: correctedPercentage,
          correctedScore: correctedScore
        });

        resultsHTML += `
          <div class="subject-analysis p-5 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold flex items-center">
                <i class="${subject.icon} ml-2 text-${subject.color.split('-')[1]}-400"></i>
                <span>${subject.subject}</span>
              </h3>
              <span class="text-sm bg-gray-700 px-3 py-1 rounded-full">${subject.count} سوال</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-400">درصد خام:</span>
                  <span class="font-bold ${rawPercentage >= 70 ? 'text-green-400' : rawPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                    ${Math.round(rawPercentage)}%
                  </span>
                </div>
                <div class="progress-bar mb-4">
                  <div class="progress-fill bg-gradient-to-r ${subject.color}" style="width: ${rawPercentage}%"></div>
                </div>
                
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-400">درصد با نمره منفی:</span>
                  <span class="font-bold ${correctedPercentage >= 70 ? 'text-green-400' : correctedPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                    ${Math.round(correctedPercentage)}%
                  </span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill bg-gradient-to-r ${subject.color}" style="width: ${correctedPercentage}%"></div>
                </div>
              </div>
              
              <div>
                <div class="bg-gray-800/50 p-4 rounded-lg">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-green-400 flex items-center">
                      <i class="fas fa-check-circle ml-1"></i> صحیح:
                    </span>
                    <span>${correct} (${Math.round(rawPercentage)}%)</span>
                  </div>
                  
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-red-400 flex items-center">
                      <i class="fas fa-times-circle ml-1"></i> غلط:
                    </span>
                    <span>${wrong} (${Math.round(wrongPercentage)}%)</span>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <span class="text-gray-400 flex items-center">
                      <i class="fas fa-circle ml-1"></i> نزده:
                    </span>
                    <span>${blank} (${Math.round(blankPercentage)}%)</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
              <div class="text-sm text-gray-400 mb-1">نمره نهایی این درس</div>
              <div class="text-2xl font-bold ${correctedPercentage >= 70 ? 'text-green-400' : correctedPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'} animate-pulse">
                ${correctedScore.toFixed(2)} از ${subject.count}
              </div>
            </div>
          </div>`;
        
        totalCorrect += correct;
        totalWrong += wrong;
        totalBlank += blank;
        totalQuestions += subject.count;
      });

      // نتایج کلی
      const totalRawPercentage = (totalCorrect / totalQuestions) * 100;
      const totalCorrectedScore = Math.max(0, totalCorrect - (totalWrong / 3));
      const totalCorrectedPercentage = (totalCorrectedScore / totalQuestions) * 100;
      const totalWrongPercentage = (totalWrong / totalQuestions) * 100;
      const totalBlankPercentage = (totalBlank / totalQuestions) * 100;

      resultsHTML += `
        <div class="glass-effect p-6 border border-green-500/30 animate-fade-in">
          <h4 class="text-2xl font-bold mb-4 text-center text-green-400 flex items-center justify-center">
            <i class="fas fa-trophy ml-2"></i> نتیجه کلی آزمون
          </h4>
          
          <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-6">
            <div class="text-center">
              <div class="text-5xl font-bold text-green-400 mb-1">${Math.round(totalCorrectedPercentage)}%</div>
              <div class="text-gray-400">نمره نهایی با احتساب نمره منفی</div>
            </div>
            
            <div class="w-full md:w-1/2">
              <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden flex mb-2">
                <div class="bg-green-500 h-full" style="width:${totalRawPercentage}%"></div>
                <div class="bg-gray-500 h-full" style="width:${totalBlankPercentage}%"></div>
                <div class="bg-red-500 h-full" style="width:${totalWrongPercentage}%"></div>
              </div>
              
              <div class="flex justify-between text-sm">
                <span class="text-green-400">${totalCorrect} صحیح</span>
                <span class="text-gray-400">${totalBlank} نزده</span>
                <span class="text-red-400">${totalWrong} غلط</span>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mt-4">
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-green-400 font-bold text-xl">${totalQuestions}</div>
              <div class="text-gray-400 text-sm">کل سوالات</div>
            </div>
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-blue-400 font-bold text-xl">${Math.round(totalRawPercentage)}%</div>
              <div class="text-gray-400 text-sm">درصد صحیح</div>
            </div>
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-yellow-400 font-bold text-xl">${Math.round(totalCorrectedPercentage)}%</div>
              <div class="text-gray-400 text-sm">درصد با نمره منفی</div>
            </div>
          </div>
          
          <div class="mt-6 bg-gray-700/50 p-4 rounded-lg text-center">
            <div class="text-lg text-gray-300 mb-2">نمره نهایی شما</div>
            <div class="text-4xl font-bold text-green-400">
              ${totalCorrectedScore.toFixed(2)} از ${totalQuestions}
            </div>
          </div>
        </div>`;

      document.getElementById('results').innerHTML = resultsHTML;
      document.getElementById('printSection').classList.remove('hidden');
      
      // ذخیره داده‌ها برای پرینت
      window.printData = {
        subjectResults: subjectResults,
        totalQuestions: totalQuestions,
        totalCorrect: totalCorrect,
        totalWrong: totalWrong,
        totalBlank: totalBlank,
        totalRawPercentage: totalRawPercentage,
        totalCorrectedPercentage: totalCorrectedPercentage,
        totalCorrectedScore: totalCorrectedScore
      };
      
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    function printResults() {
      const printData = window.printData;
      if (!printData) return;
      
      const printContent = document.getElementById('printContent');
      let printHTML = `
        <div class="print-header">
          <h1>کارنامه آزمون خود ارزیابی</h1>
          <p>تاریخ: ${new Date().toLocaleDateString('fa-IR')}</p>
        </div>
        
        <div class="print-section">
          <h2>نتایج کلی</h2>
          <div class="print-card">
            <div class="print-summary">
              <div class="print-summary-item">
                <div class="value">${printData.totalQuestions}</div>
                <div class="label">کل سوالات</div>
              </div>
              <div class="print-summary-item">
                <div class="value">${Math.round(printData.totalRawPercentage)}%</div>
                <div class="label">درصد صحیح</div>
              </div>
              <div class="print-summary-item">
                <div class="value">${Math.round(printData.totalCorrectedPercentage)}%</div>
                <div class="label">درصد با نمره منفی</div>
              </div>
            </div>
            
            <div style="margin-top: 1rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>صحیح: ${printData.totalCorrect} (${Math.round(printData.totalCorrect / printData.totalQuestions * 100)}%)</span>
                <span>نزده: ${printData.totalBlank} (${Math.round(printData.totalBlank / printData.totalQuestions * 100)}%)</span>
                <span>غلط: ${printData.totalWrong} (${Math.round(printData.totalWrong / printData.totalQuestions * 100)}%)</span>
              </div>
              <div class="print-progress">
                <div class="print-progress-fill" style="width: ${printData.totalCorrectedPercentage}%"></div>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
              <div style="font-size: 14px; color: #666;">نمره نهایی</div>
              <div style="font-size: 24px; font-weight: bold;">${printData.totalCorrectedScore.toFixed(2)} از ${printData.totalQuestions}</div>
            </div>
          </div>
        </div>
        
        <div class="print-section">
          <h2>تحلیل درسی</h2>
          <table class="print-table">
            <thead>
              <tr>
                <th>درس</th>
                <th>تعداد سوال</th>
                <th>صحیح</th>
                <th>غلط</th>
                <th>نزده</th>
                <th>درصد خام</th>
                <th>درصد با نمره منفی</th>
                <th>نمره نهایی</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      printData.subjectResults.forEach(subject => {
        printHTML += `
          <tr>
            <td>${subject.name}</td>
            <td>${subject.count}</td>
            <td>${subject.correct}</td>
            <td>${subject.wrong}</td>
            <td>${subject.blank}</td>
            <td>${Math.round(subject.rawPercentage)}%</td>
            <td>${Math.round(subject.correctedPercentage)}%</td>
            <td>${subject.correctedScore.toFixed(2)}</td>
          </tr>
        `;
      });
      
      printHTML += `
            </tbody>
          </table>
        </div>
        
        <div class="print-section">
          <h2>راهنمای نمره دهی</h2>
          <div class="print-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div style="text-align: center;">
                <div style="font-weight: bold; color: #4caf50;">هر پاسخ صحیح</div>
                <div>+1 نمره</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: bold; color: #f44336;">هر پاسخ غلط</div>
                <div>-0.33 نمره</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: bold; color: #9e9e9e;">سوال نزده</div>
                <div>0 نمره</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      printContent.innerHTML = printHTML;
      
      // نمایش محتوای پرینت و پرینت گرفتن
      printContent.style.display = 'block';
      window.print();
      printContent.style.display = 'none';
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg border-l-4 border-green-500 flex items-center z-50';
      notification.innerHTML = `
        <i class="fas fa-info-circle ml-2 text-green-400"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function setupBackToTopButton() {
      const backToTopButton = document.getElementById('backToTop');
      
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('visible');
        } else {
          backToTopButton.classList.remove('visible');
        }
      });
      
      backToTopButton.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupBackToTopButton();
    });
  </script>

</body>
</html>
