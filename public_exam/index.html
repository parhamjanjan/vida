<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>آزمون خود ارزیابی پیشرفته | ویدا</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary-color: #4f46e5;
      --primary-dark: #4338ca;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --dark-bg: #0f172a;
      --card-bg: #1e293b;
      --gradient-primary: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      --gradient-secondary: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* ناوبری */
    .nav-gradient {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-link {
      position: relative;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 0;
      height: 2px;
      background: var(--gradient-primary);
      transition: width 0.3s ease;
    }
    
    .nav-link:hover::after {
      width: 100%;
    }
    
    /* کارت‌های مدرن */
    .modern-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      position: relative;
    }
    
    .modern-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 0;
    }
    
    .modern-card:hover::before {
      opacity: 1;
    }
    
    .modern-card:hover {
      transform: translateY(-10px);
      box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.3),
          0 0 80px rgba(79, 70, 229, 0.1);
    }
    
    /* دکمه‌ها */
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }
    
    .btn-secondary {
      background: var(--gradient-secondary);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-accent {
      background: var(--gradient-accent);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-purple {
      background: var(--gradient-purple);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-gray {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    /* انیمیشن‌ها */
    @keyframes floating {
      0% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(1deg); }
      100% { transform: translateY(0px) rotate(0deg); }
    }
    
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .bounce-in {
      animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    /* متن گرادینت */
    .gradient-text {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* فیلدهای ورودی */
    .input-modern {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      width: 100%;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Vazirmatn', sans-serif;
    }
    
    .input-modern:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);
      background: rgba(255, 255, 255, 0.08);
    }
    
    /* حذف فلش‌های input عددی */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    /* طراحی مربع‌های نرم برای گزینه‌ها */
    .option-modern {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .option-input {
      display: none;
    }
    
    .option-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      background-color: rgba(255, 255, 255, 0.05);
      position: relative;
    }
    
    .option-number {
      color: #9ca3af;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    /* حالت انتخاب */
    .option-box.selected {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.2);
      transform: scale(1.05);
    }
    
    .option-box.selected .option-number {
      color: white;
      font-weight: bold;
    }
    
    /* حالت‌های مختلف پس از تصحیح */
    .option-box.correct {
      border-color: var(--secondary-color);
      background-color: rgba(16, 185, 129, 0.3);
      transform: scale(1.05);
    }
    
    .option-box.correct .option-number {
      color: white;
      font-weight: bold;
    }
    
    .option-box.wrong {
      border-color: #ef4444;
      background-color: rgba(239, 68, 68, 0.3);
    }
    
    .option-box.wrong .option-number {
      color: white;
      font-weight: bold;
    }
    
    .option-box.blank {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.1);
    }
    
    /* تایمر مدرن */
    .timer-modern {
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid rgba(79, 70, 229, 0.3);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .timer-modern.warning {
      border-color: rgba(239, 68, 68, 0.5);
      animation: pulse 1s infinite;
    }
    
    /* کارت نتیجه */
    .result-card {
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      display: none;
    }
    
    .result-card.correct {
      background-color: rgba(16, 185, 129, 0.1);
      border-right: 4px solid var(--secondary-color);
    }
    
    .result-card.wrong {
      background-color: rgba(239, 68, 68, 0.1);
      border-right: 4px solid #ef4444;
    }
    
    .result-card.blank {
      background-color: rgba(156, 163, 175, 0.1);
      border-right: 4px solid #9ca3af;
    }
    
    /* انیمیشن‌های ورود */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    
    /* نوار پیشرفت */
    .progress-modern {
      height: 8px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      transition: width 0.6s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    /* کارت تاریخچه */
    .history-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .history-card:hover {
      transform: translateY(-5px);
      border-color: rgba(79, 70, 229, 0.3);
    }
    
    /* شکل‌های شناور */
    .floating-shapes {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .floating-shape {
      position: absolute;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      opacity: 0.1;
      animation: float-shape 15s infinite linear;
    }
    
    @keyframes float-shape {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(20px, 40px) rotate(90deg); }
      50% { transform: translate(40px, 20px) rotate(180deg); }
      75% { transform: translate(20px, 0px) rotate(270deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    .shape-1 {
      width: 120px;
      height: 120px;
      background: var(--gradient-primary);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .shape-2 {
      width: 80px;
      height: 80px;
      background: var(--gradient-secondary);
      top: 70%;
      left: 80%;
      animation-delay: -5s;
    }
    
    .shape-3 {
      width: 100px;
      height: 100px;
      background: var(--gradient-accent);
      top: 40%;
      left: 70%;
      animation-delay: -10s;
    }
    
    /* تب‌ها */
    .tab-container {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 1.5rem;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    
    .tab:hover {
      color: var(--primary-color);
    }
    
    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* تنظیمات آزمون - حالت فعال */
    .setup-active {
      border: 2px solid rgba(79, 70, 229, 0.5);
      box-shadow: 0 0 20px rgba(79, 70, 229, 0.2);
    }
    
    /* واکنش‌گرا */
    @media (max-width: 768px) {
      .option-box {
        width: 35px;
        height: 35px;
      }
      
      .btn-primary, .btn-secondary, .btn-accent, .btn-purple, .btn-gray {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
      
      .input-modern {
        padding: 0.75rem;
      }
      
      .timer-modern {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .option-box {
        width: 30px;
        height: 30px;
      }
      
      .option-number {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <!-- شکل‌های شناور در پس‌زمینه -->
  <div class="floating-shapes">
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
  </div>

  <!-- ناوبری -->
  <nav class="nav-gradient py-4 px-6 fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-emerald-400 flex items-center justify-center ml-3">
          <i class="fas fa-graduation-cap text-white"></i>
        </div>
        <span class="text-xl font-bold gradient-text">ویدا | آزمون خودارزیابی</span>
      </div>
      
      <div class="flex space-x-2 space-x-reverse">
        <button onclick="showTab('exam')" class="nav-link text-slate-200 font-medium">آزمون جدید</button>
        <button onclick="showTab('history')" class="nav-link text-slate-400 hover:text-slate-200 font-medium">تاریخچه</button>
        <button onclick="showTab('analysis')" class="nav-link text-slate-400 hover:text-slate-200 font-medium">تحلیل</button>
      </div>
    </div>
  </nav>

  <div class="max-w-4xl w-full mx-auto relative z-10 mt-20">
    <!-- تب‌ها -->
    <div class="tab-container">
      <button onclick="showTab('exam')" class="tab active" id="tab-exam">
        <i class="fas fa-play-circle ml-2"></i> آزمون جدید
      </button>
      <button onclick="showTab('history')" class="tab" id="tab-history">
        <i class="fas fa-history ml-2"></i> تاریخچه آزمون‌ها
      </button>
      <button onclick="showTab('analysis')" class="tab" id="tab-analysis">
        <i class="fas fa-chart-line ml-2"></i> تحلیل پیشرفت
      </button>
    </div>

    <!-- محتوای تب‌ها -->
    <div class="tab-content active" id="content-exam">
      <!-- سرتیتر -->
      <div class="text-center mb-8 animate-fade-in">
        <h1 class="text-4xl font-bold mb-2 gradient-text">
          <i class="fas fa-brain ml-2"></i>آزمون خود ارزیابی پیشرفته
        </h1>
        <p class="text-gray-400">طراحی شده برای ارزیابی جامع و ذخیره‌سازی نتایج</p>
      </div>

      <!-- Setup -->
      <div id="setup" class="modern-card p-6 space-y-4 mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-green-400 flex items-center">
            <i class="fas fa-cog ml-2"></i>تنظیمات آزمون
          </h2>
          <span id="setupStatus" class="text-sm px-3 py-1 rounded-full bg-gray-700 text-gray-300">
            آماده برای شروع
          </span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="setupInputs">
          <div>
            <label class="block text-gray-300 mb-1">زیست‌شناسی:</label>
            <input type="number" id="bioCount" min="0" value="0" class="input-modern setup-input">
          </div>
          
          <div>
            <label class="block text-gray-300 mb-1">فیزیک:</label>
            <input type="number" id="physCount" min="0" value="0" class="input-modern setup-input">
          </div>
          
          <div>
            <label class="block text-gray-300 mb-1">شیمی:</label>
            <input type="number" id="chemCount" min="0" value="0" class="input-modern setup-input">
          </div>
          
          <div>
            <label class="block text-gray-300 mb-1">ریاضی:</label>
            <input type="number" id="mathCount" min="0" value="0" class="input-modern setup-input">
          </div>
                  
          <div>
            <label class="block text-gray-300 mb-1">زمین‌شناسی:</label>
            <input type="number" id="geoCount" min="0" value="0" class="input-modern setup-input">
          </div>
          <div>
            <label class="block text-gray-300 mb-1">مدت آزمون (دقیقه):</label>
            <input type="number" id="examTime" min="1" value="30" class="input-modern setup-input">
          </div>
        </div>
        
        <div class="flex gap-3 mt-4">
          <button onclick="generateExam()" id="startBtn" class="btn-primary flex-1 pulse">
            <i class="fas fa-play ml-2"></i> شروع آزمون جدید
          </button>
          <button onclick="resetExam()" id="resetBtn" class="btn-gray flex-1" style="display: none;">
            <i class="fas fa-redo ml-2"></i> شروع مجدد
          </button>
          <button onclick="editSettings()" id="editBtn" class="btn-accent flex-1" style="display: none;">
            <i class="fas fa-edit ml-2"></i> ویرایش تنظیمات
          </button>
        </div>
      </div>

      <!-- Timer -->
      <div id="timer" class="timer-modern hidden mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-clock text-green-400 text-xl"></i>
            <span id="time-display" class="text-xl font-bold">00:00</span>
            <span class="text-gray-400">زمان باقیمانده</span>
          </div>
          <button onclick="pauseTimer()" id="pauseBtn" class="btn-gray text-sm px-3 py-1">
            <i class="fas fa-pause ml-1"></i> توقف
          </button>
        </div>
      </div>

      <!-- Exam -->
      <div id="exam" class="space-y-6"></div>

      <!-- Answer Key -->
      <div id="answerKeys" class="hidden modern-card p-6 mt-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-green-300 flex items-center">
            <i class="fas fa-key ml-2"></i> کلید پاسخ‌ها
          </h2>
          <button onclick="autoFillKeys()" class="btn-purple text-sm px-3 py-1">
            <i class="fas fa-magic ml-1"></i> پر کردن تصادفی
          </button>
        </div>
        <div id="keyInputs" class="space-y-6"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="gradeExam()" class="btn-secondary flex-1">
            <i class="fas fa-check-circle ml-2"></i> تصحیح آزمون
          </button>
          <button onclick="previewExam()" class="btn-purple flex-1">
            <i class="fas fa-eye ml-2"></i> پیش‌نمایش
          </button>
        </div>
      </div>

      <!-- Results -->
      <div id="results" class="mt-8 space-y-6"></div>
      
      <!-- دکمه‌های پایانی -->
      <div id="actionSection" class="hidden mt-8 text-center">
        <div class="flex flex-wrap gap-3 justify-center">
          <button onclick="saveExamResults()" class="btn-purple">
            <i class="fas fa-save ml-2"></i> ذخیره آزمون
          </button>
          <button onclick="printResults()" class="btn-accent">
            <i class="fas fa-print ml-2"></i> پرینت کارنامه
          </button>
          <button onclick="createSimilarExam()" class="btn-secondary">
            <i class="fas fa-copy ml-2"></i> آزمون مشابه
          </button>
          <button onclick="resetExam()" class="btn-gray">
            <i class="fas fa-redo ml-2"></i> آزمون جدید
          </button>
        </div>
      </div>
    </div>

    <!-- تب تاریخچه -->
    <div class="tab-content" id="content-history">
      <div class="modern-card p-6">
        <h2 class="text-2xl font-bold mb-6 text-white flex items-center">
          <i class="fas fa-history ml-2"></i> تاریخچه آزمون‌ها
        </h2>
        <div id="historyList" class="space-y-4">
          <!-- تاریخچه آزمون‌ها در اینجا نمایش داده می‌شود -->
        </div>
      </div>
    </div>

    <!-- تب تحلیل -->
    <div class="tab-content" id="content-analysis">
      <div class="modern-card p-6">
        <h2 class="text-2xl font-bold mb-6 text-white flex items-center">
          <i class="fas fa-chart-line ml-2"></i> تحلیل پیشرفت
        </h2>
        <div id="analysisContent">
          <!-- نمودارها و تحلیل‌ها در اینجا نمایش داده می‌شود -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // کلید ذخیره‌سازی در localStorage
    const STORAGE_KEY = 'vida_exam_history';
    const EXAM_STATE_KEY = 'vida_exam_current_state';
    
    const subjects = [
      { name: "زیست‌شناسی", id: "bioCount", icon: "fas fa-dna", color: "from-green-400 to-emerald-500" },
      { name: "فیزیک", id: "physCount", icon: "fas fa-atom", color: "from-blue-400 to-cyan-500" },
      { name: "شیمی", id: "chemCount", icon: "fas fa-flask", color: "from-purple-400 to-pink-500" },
      { name: "ریاضی", id: "mathCount", icon: "fas fa-square-root-alt", color: "from-yellow-400 to-orange-500" },
      { name: "زمین‌شناسی", id: "geoCount", icon: "fas fa-mountain", color: "from-orange-400 to-red-500" },
    ];

    let examStructure = [];
    let timerInterval;
    let timeLeft = 0;
    let selectedOptions = {};
    let globalQuestionCounter = 1;
    let currentExamResults = null;
    let isExamActive = false;
    let isTimerPaused = false;
    let originalTime = 0;

    // مدیریت تب‌ها
    function showTab(tabName) {
      // غیرفعال کردن همه تب‌ها
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // فعال کردن تب انتخاب شده
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`content-${tabName}`).classList.add('active');
      
      // بارگذاری داده‌های مربوطه
      if (tabName === 'history') {
        loadExamHistory();
      } else if (tabName === 'analysis') {
        showAnalysis();
      }
    }

    // بارگذاری تاریخچه آزمون‌ها
    function loadExamHistory() {
      const historyList = document.getElementById('historyList');
      const exams = getSavedExams();
      
      if (exams.length === 0) {
        historyList.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-history text-4xl mb-4"></i>
            <p>هیچ آزمونی ذخیره نشده است.</p>
            <p class="text-sm mt-2">پس از اتمام هر آزمون، می‌توانید آن را ذخیره کنید.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      exams.forEach((exam, index) => {
        const date = new Date(exam.timestamp);
        const dateStr = date.toLocaleDateString('fa-IR');
        const timeStr = date.toLocaleTimeString('fa-IR');
        
        html += `
          <div class="history-card p-4">
            <div class="flex justify-between items-center mb-3">
              <div>
                <h3 class="text-lg font-bold text-white">آزمون ${index + 1}</h3>
                <p class="text-sm text-gray-400">${dateStr} - ${timeStr}</p>
              </div>
              <div class="flex gap-2">
                <button onclick="viewExamDetails(${index})" class="btn-primary text-sm px-3 py-1">
                  <i class="fas fa-eye ml-1"></i> مشاهده
                </button>
                <button onclick="deleteExam(${index})" class="btn-accent text-sm px-3 py-1">
                  <i class="fas fa-trash ml-1"></i> حذف
                </button>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-3">
              <div class="text-center">
                <div class="text-green-400 font-bold">${exam.totalCorrect}</div>
                <div class="text-xs text-gray-400">صحیح</div>
              </div>
              <div class="text-center">
                <div class="text-red-400 font-bold">${exam.totalWrong}</div>
                <div class="text-xs text-gray-400">غلط</div>
              </div>
              <div class="text-center">
                <div class="text-yellow-400 font-bold">${exam.totalBlank}</div>
                <div class="text-xs text-gray-400">نزده</div>
              </div>
            </div>
            
            <div class="progress-modern mb-2">
              <div class="progress-fill bg-gradient-to-r ${exam.totalPercentage >= 70 ? 'from-green-400 to-emerald-500' : exam.totalPercentage >= 50 ? 'from-yellow-400 to-orange-500' : 'from-red-400 to-pink-500'}" 
                   style="width: ${exam.totalPercentage}%"></div>
            </div>
            
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">${exam.totalQuestions} سوال</span>
              <span class="font-bold ${exam.totalPercentage >= 70 ? 'text-green-400' : exam.totalPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                ${exam.totalPercentage.toFixed(1)}%
              </span>
            </div>
          </div>
        `;
      });
      
      historyList.innerHTML = html;
    }

    // مشاهده جزئیات آزمون
    function viewExamDetails(index) {
      const exams = getSavedExams();
      const exam = exams[index];
      
      if (!exam) return;
      
      let detailsHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
          <div class="modern-card p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold text-white">جزئیات آزمون</h3>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center p-3 bg-gray-800 rounded-lg">
                  <div class="text-2xl font-bold text-green-400">${exam.totalCorrectedPercentage.toFixed(1)}%</div>
                  <div class="text-sm text-gray-400">نمره نهایی</div>
                </div>
                <div class="text-center p-3 bg-gray-800 rounded-lg">
                  <div class="text-2xl font-bold text-blue-400">${exam.totalQuestions}</div>
                  <div class="text-sm text-gray-400">کل سوالات</div>
                </div>
                <div class="text-center p-3 bg-gray-800 rounded-lg">
                  <div class="text-2xl font-bold text-yellow-400">${exam.timeSpent}</div>
                  <div class="text-sm text-gray-400">زمان صرف شده</div>
                </div>
              </div>
      `;
      
      // نمایش نتایج هر درس
      exam.subjectResults.forEach(subject => {
        detailsHtml += `
          <div class="border border-gray-700 rounded-lg p-4">
            <h4 class="text-lg font-bold text-white mb-2">${subject.name}</h4>
            <div class="grid grid-cols-4 gap-2 mb-3">
              <div class="text-center">
                <div class="text-green-400 font-bold">${subject.correct}</div>
                <div class="text-xs text-gray-400">صحیح</div>
              </div>
              <div class="text-center">
                <div class="text-red-400 font-bold">${subject.wrong}</div>
                <div class="text-xs text-gray-400">غلط</div>
              </div>
              <div class="text-center">
                <div class="text-gray-400 font-bold">${subject.blank}</div>
                <div class="text-xs text-gray-400">نزده</div>
              </div>
              <div class="text-center">
                <div class="font-bold ${subject.correctedPercentage >= 70 ? 'text-green-400' : subject.correctedPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                  ${subject.correctedPercentage.toFixed(1)}%
                </div>
                <div class="text-xs text-gray-400">درصد</div>
              </div>
            </div>
          </div>
        `;
      });
      
      detailsHtml += `
            <div class="mt-6">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-primary w-full">
                بستن
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', detailsHtml);
    }

    // حذف آزمون
    function deleteExam(index) {
      if (!confirm('آیا از حذف این آزمون اطمینان دارید؟')) return;
      
      const exams = getSavedExams();
      exams.splice(index, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(exams));
      loadExamHistory();
      showNotification('آزمون با موفقیت حذف شد');
    }

    // نمایش تحلیل پیشرفت
    function showAnalysis() {
      const exams = getSavedExams();
      const analysisContent = document.getElementById('analysisContent');
      
      if (exams.length === 0) {
        analysisContent.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-chart-line text-4xl mb-4"></i>
            <p>داده‌ای برای تحلیل وجود ندارد.</p>
            <p class="text-sm mt-2">حداقل یک آزمون را ذخیره کنید.</p>
          </div>
        `;
        return;
      }
      
      // محاسبه آمار
      const totalExams = exams.length;
      const avgScore = exams.reduce((sum, exam) => sum + exam.totalCorrectedPercentage, 0) / totalExams;
      const bestScore = Math.max(...exams.map(exam => exam.totalCorrectedPercentage));
      const worstScore = Math.min(...exams.map(exam => exam.totalCorrectedPercentage));
      const totalQuestions = exams.reduce((sum, exam) => sum + exam.totalQuestions, 0);
      
      // ایجاد نمودار ساده پیشرفت
      let progressChart = '<div class="mb-6 p-4 bg-gray-800 rounded-lg">';
      progressChart += '<h4 class="text-lg font-bold text-white mb-3">روند پیشرفت</h4>';
      progressChart += '<div class="flex items-end h-40 gap-1">';
      
      exams.forEach((exam, index) => {
        const height = (exam.totalCorrectedPercentage / 100) * 150;
        progressChart += `
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-gradient-to-t ${exam.totalCorrectedPercentage >= 70 ? 'from-green-500 to-emerald-600' : exam.totalCorrectedPercentage >= 50 ? 'from-yellow-500 to-orange-600' : 'from-red-500 to-pink-600'}" 
                 style="height: ${height}px; border-radius: 4px 4px 0 0;"></div>
            <div class="text-xs text-gray-400 mt-1">${index + 1}</div>
          </div>
        `;
      });
      
      progressChart += '</div></div>';
      
      analysisContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="text-center p-4 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg">
            <div class="text-2xl font-bold text-white">${totalExams}</div>
            <div class="text-sm text-blue-100">تعداد آزمون‌ها</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg">
            <div class="text-2xl font-bold text-white">${avgScore.toFixed(1)}%</div>
            <div class="text-sm text-green-100">میانگین نمره</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg">
            <div class="text-2xl font-bold text-white">${bestScore.toFixed(1)}%</div>
            <div class="text-sm text-purple-100">بهترین نمره</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg">
            <div class="text-2xl font-bold text-white">${worstScore.toFixed(1)}%</div>
            <div class="text-sm text-orange-100">ضعیف‌ترین نمره</div>
          </div>
        </div>
        
        ${progressChart}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-lg font-bold text-white mb-3">آمار کلی</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-gray-400">کل سوالات پاسخ داده:</span>
                <span class="text-white font-bold">${totalQuestions}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">میانگین زمان هر آزمون:</span>
                <span class="text-white font-bold">${(exams.reduce((sum, exam) => {
                  const timeParts = exam.timeSpent.split(':');
                  return sum + (parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]));
                }, 0) / totalExams / 60).toFixed(1)} دقیقه</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">تاریخ اولین آزمون:</span>
                <span class="text-white font-bold">${new Date(exams[0].timestamp).toLocaleDateString('fa-IR')}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">تاریخ آخرین آزمون:</span>
                <span class="text-white font-bold">${new Date(exams[exams.length - 1].timestamp).toLocaleDateString('fa-IR')}</span>
              </div>
            </div>
          </div>
          
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-lg font-bold text-white mb-3">توصیه‌ها</h4>
            <div class="space-y-3">
              ${avgScore >= 70 ? 
                '<div class="text-green-400 flex items-center"><i class="fas fa-check-circle ml-2"></i> عملکرد عالی! به همین روال ادامه دهید.</div>' :
                avgScore >= 50 ?
                '<div class="text-yellow-400 flex items-center"><i class="fas fa-exclamation-circle ml-2"></i> عملکرد متوسط. روی نقاط ضعف تمرکز کنید.</div>' :
                '<div class="text-red-400 flex items-center"><i class="fas fa-times-circle ml-2"></i> نیاز به تلاش بیشتر. مطالعه‌ی عمیق‌تری داشته باشید.</div>'
              }
              ${exams.length >= 5 ?
                '<div class="text-blue-400 flex items-center"><i class="fas fa-chart-line ml-2"></i> تمرین مستمر دارید! این عالیه.</div>' :
                '<div class="text-orange-400 flex items-center"><i class="fas fa-calendar-alt ml-2"></i> آزمون‌های بیشتری برگزار کنید.</div>'
              }
              <div class="text-purple-400 flex items-center">
                <i class="fas fa-lightbulb ml-2"></i> 
                ${totalQuestions >= 100 ? 
                  'سوالات زیادی حل کرده‌اید! عالی.' :
                  'سعی کنید سوالات بیشتری حل کنید.'
                }
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // دریافت آزمون‌های ذخیره شده
    function getSavedExams() {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    }

    // ذخیره آزمون جدید
    function saveExamResults() {
      if (!currentExamResults) {
        showNotification('ابتدا آزمون را تصحیح کنید');
        return;
      }
      
      const exams = getSavedExams();
      const examData = {
        ...currentExamResults,
        timestamp: new Date().toISOString(),
        timeSpent: formatTimeSpent(timeLeft)
      };
      
      exams.push(examData);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(exams));
      
      showNotification('آزمون با موفقیت ذخیره شد');
      document.getElementById('actionSection').classList.add('hidden');
    }

    // فرمت زمان صرف شده
    function formatTimeSpent(secondsLeft) {
      const totalTime = parseInt(document.getElementById('examTime').value) * 60;
      const timeSpent = totalTime - secondsLeft;
      const minutes = Math.floor(timeSpent / 60);
      const seconds = timeSpent % 60;
      return `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    // ============ عملکردهای جدید ============
    
    // تولید آزمون جدید با امکان تغییر تنظیمات
    function generateExam() {
      // ذخیره تنظیمات فعلی
      saveCurrentSettings();
      
      // بررسی آیا حداقل یک سوال انتخاب شده
      const hasQuestions = subjects.some(subject => {
        return parseInt(document.getElementById(subject.id).value) > 0;
      });
      
      if (!hasQuestions) {
        showNotification('لطفاً حداقل برای یک درس سوال انتخاب کنید');
        return;
      }
      
      clearInterval(timerInterval);
      examStructure = [];
      selectedOptions = {};
      globalQuestionCounter = 1;
      isExamActive = true;
      
      const examDiv = document.getElementById('exam');
      examDiv.innerHTML = '';
      const keyInputsDiv = document.getElementById('keyInputs');
      keyInputsDiv.innerHTML = '';

      subjects.forEach(subject => {
        const count = parseInt(document.getElementById(subject.id).value);
        if (count > 0) {
          const startQuestion = globalQuestionCounter;
          
          examStructure.push({ 
            subject: subject.name, 
            count: count, 
            icon: subject.icon,
            color: subject.color,
            startQuestion: startQuestion
          });
          
          // ایجاد کارت سوالات
          examDiv.innerHTML += `
            <div class="modern-card p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-green-300 text-xl font-bold flex items-center">
                  <i class="${subject.icon} ml-2"></i> ${subject.name}
                </h3>
                <span class="text-sm bg-gray-700 px-3 py-1 rounded-full text-gray-300">${count} سوال</span>
              </div>
              <div class="space-y-4" id="questions-${subject.name.replace(/\s+/g, '-')}">
                ${[...Array(count)].map((_, i) => {
                  const questionNum = globalQuestionCounter++;
                  return `
                  <div class="question-item">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between bg-gray-700/30 p-4 rounded-lg gap-3">
                      <span class="text-gray-300">سوال ${questionNum}:</span>
                      <div class="flex items-center gap-3">
                        ${[1,2,3,4].map(num => `
                          <label class="option-modern">
                            <input type="radio" class="option-input" name="${subject.name}-q${questionNum}" 
                                   onclick="handleOptionClick('${subject.name}', ${questionNum}, ${num})">
                            <div class="option-box" data-question="${subject.name}-q${questionNum}" data-option="${num}">
                              <span class="option-number">${num}</span>
                            </div>
                          </label>
                        `).join('')}
                      </div>
                    </div>
                    <div class="result-card" id="result-${subject.name}-q${questionNum}"></div>
                  </div>
                `}).join('')}
              </div>
            </div>`;

          // ایجاد قسمت کلید پاسخ‌ها
          keyInputsDiv.innerHTML += `
            <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/50">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-green-400 font-bold flex items-center">
                  <i class="${subject.icon} ml-2"></i> ${subject.name}
                </h4>
                <button onclick="autoFillSubjectKeys('${subject.name}', ${count}, ${startQuestion})" class="text-purple-400 text-sm">
                  <i class="fas fa-random ml-1"></i> تصادفی
                </button>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                ${[...Array(count)].map((_, i) => {
                  const questionNum = startQuestion + i;
                  return `
                  <div class="flex items-center">
                    <label class="text-gray-300 mr-2">${questionNum}:</label>
                    <input type="number" min="1" max="4" id="key-${subject.name}-q${questionNum}" 
                           class="input-modern w-16 px-3 py-1 rounded-lg focus:outline-none text-center key-input">
                  </div>
                `}).join('')}
              </div>
            </div>`;
        }
      });

      // به‌روزرسانی رابط کاربری
      document.getElementById('answerKeys').classList.remove('hidden');
      document.getElementById('results').innerHTML = '';
      document.getElementById('actionSection').classList.add('hidden');
      
      // غیرفعال کردن تنظیمات
      disableSetupInputs();
      
      // به‌روزرسانی دکمه‌ها
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'block';
      document.getElementById('editBtn').style.display = 'block';
      
      // به‌روزرسانی وضعیت
      document.getElementById('setupStatus').textContent = 'آزمون فعال';
      document.getElementById('setupStatus').className = 'text-sm px-3 py-1 rounded-full bg-green-700 text-green-300';
      document.getElementById('setup').classList.add('setup-active');
      
      startTimer();
      
      // اسکرول به بخش آزمون
      document.getElementById('exam').scrollIntoView({ behavior: 'smooth' });
    }

    // غیرفعال کردن تنظیمات هنگام شروع آزمون
    function disableSetupInputs() {
      document.querySelectorAll('.setup-input').forEach(input => {
        input.disabled = true;
        input.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }

    // فعال کردن تنظیمات برای ویرایش
    function enableSetupInputs() {
      document.querySelectorAll('.setup-input').forEach(input => {
        input.disabled = false;
        input.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }

    // ذخیره تنظیمات فعلی
    function saveCurrentSettings() {
      const settings = {};
      subjects.forEach(subject => {
        settings[subject.id] = document.getElementById(subject.id).value;
      });
      settings.examTime = document.getElementById('examTime').value;
      localStorage.setItem('last_exam_settings', JSON.stringify(settings));
    }

    // بارگذاری تنظیمات ذخیره شده
    function loadLastSettings() {
      const saved = localStorage.getItem('last_exam_settings');
      if (saved) {
        const settings = JSON.parse(saved);
        subjects.forEach(subject => {
          if (settings[subject.id]) {
            document.getElementById(subject.id).value = settings[subject.id];
          }
        });
        if (settings.examTime) {
          document.getElementById('examTime').value = settings.examTime;
        }
      }
    }

    // ویرایش تنظیمات
    function editSettings() {
      if (confirm('با ویرایش تنظیمات، پاسخ‌های فعلی پاک می‌شوند. آیا ادامه می‌دهید؟')) {
        // فعال کردن تنظیمات
        enableSetupInputs();
        
        // پاک کردن آزمون فعلی
        document.getElementById('exam').innerHTML = '';
        document.getElementById('answerKeys').classList.add('hidden');
        document.getElementById('timer').classList.add('hidden');
        document.getElementById('results').innerHTML = '';
        document.getElementById('actionSection').classList.add('hidden');
        
        // توقف تایمر
        clearInterval(timerInterval);
        isExamActive = false;
        
        // به‌روزرسانی دکمه‌ها
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'none';
        document.getElementById('editBtn').style.display = 'none';
        
        // به‌روزرسانی وضعیت
        document.getElementById('setupStatus').textContent = 'آماده برای شروع';
        document.getElementById('setupStatus').className = 'text-sm px-3 py-1 rounded-full bg-gray-700 text-gray-300';
        document.getElementById('setup').classList.remove('setup-active');
        
        showNotification('حالا می‌توانید تنظیمات را تغییر دهید و آزمون جدیدی شروع کنید');
      }
    }

    // شروع مجدد آزمون
    function resetExam() {
      if (confirm('آیا مطمئن هستید که می‌خواهید آزمون را از نو شروع کنید؟ تمام پاسخ‌های فعلی پاک می‌شوند.')) {
        // پاک کردن همه چیز
        document.getElementById('exam').innerHTML = '';
        document.getElementById('answerKeys').classList.add('hidden');
        document.getElementById('timer').classList.add('hidden');
        document.getElementById('results').innerHTML = '';
        document.getElementById('actionSection').classList.add('hidden');
        
        // توقف تایمر
        clearInterval(timerInterval);
        isExamActive = false;
        
        // فعال کردن تنظیمات
        enableSetupInputs();
        
        // به‌روزرسانی دکمه‌ها
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'none';
        document.getElementById('editBtn').style.display = 'none';
        
        // به‌روزرسانی وضعیت
        document.getElementById('setupStatus').textContent = 'آماده برای شروع';
        document.getElementById('setupStatus').className = 'text-sm px-3 py-1 rounded-full bg-gray-700 text-gray-300';
        document.getElementById('setup').classList.remove('setup-active');
        
        // پاک کردن داده‌ها
        selectedOptions = {};
        examStructure = [];
        currentExamResults = null;
        
        showNotification('آزمون ریست شد. حالا می‌توانید تنظیمات جدیدی وارد کنید');
      }
    }

    // توقف/ادامه تایمر
    function pauseTimer() {
      const pauseBtn = document.getElementById('pauseBtn');
      
      if (!isTimerPaused) {
        clearInterval(timerInterval);
        isTimerPaused = true;
        pauseBtn.innerHTML = '<i class="fas fa-play ml-1"></i> ادامه';
        pauseBtn.classList.remove('btn-gray');
        pauseBtn.classList.add('btn-secondary');
        showNotification('تایمر متوقف شد');
      } else {
        startTimerFromCurrent();
        isTimerPaused = false;
        pauseBtn.innerHTML = '<i class="fas fa-pause ml-1"></i> توقف';
        pauseBtn.classList.remove('btn-secondary');
        pauseBtn.classList.add('btn-gray');
        showNotification('تایمر ادامه یافت');
      }
    }

    // ادامه تایمر از زمان فعلی
    function startTimerFromCurrent() {
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          showNotification("⏰ زمان آزمون به پایان رسید!");
          gradeExam();
        }
      }, 1000);
    }

    // پر کردن خودکار کلیدهای پاسخ
    function autoFillKeys() {
      if (!confirm('آیا می‌خواهید کلیدهای پاسخ به صورت تصادفی پر شوند؟')) return;
      
      examStructure.forEach(subject => {
        for (let i = 0; i < subject.count; i++) {
          const questionNum = subject.startQuestion + i;
          const questionId = `${subject.subject}-q${questionNum}`;
          const randomAnswer = Math.floor(Math.random() * 4) + 1;
          document.getElementById(`key-${questionId}`).value = randomAnswer;
        }
      });
      
      showNotification('کلیدهای پاسخ به صورت تصادفی پر شدند');
    }

    // پر کردن کلیدهای یک درس خاص
    function autoFillSubjectKeys(subjectName, count, startQuestion) {
      for (let i = 0; i < count; i++) {
        const questionNum = startQuestion + i;
        const questionId = `${subjectName}-q${questionNum}`;
        const randomAnswer = Math.floor(Math.random() * 4) + 1;
        document.getElementById(`key-${questionId}`).value = randomAnswer;
      }
      showNotification(`کلیدهای ${subjectName} به صورت تصادفی پر شد`);
    }

    // پیش‌نمایش آزمون
    function previewExam() {
      let unanswered = 0;
      let answered = 0;
      
      examStructure.forEach(subject => {
        for (let i = 0; i < subject.count; i++) {
          const questionNum = subject.startQuestion + i;
          const questionId = `${subject.subject}-q${questionNum}`;
          
          if (selectedOptions[questionId]) {
            answered++;
          } else {
            unanswered++;
          }
        }
      });
      
      const totalQuestions = answered + unanswered;
      const progress = Math.round((answered / totalQuestions) * 100);
      
      showNotification(`پیشرفت: ${answered} پاسخ داده شده، ${unanswered} پاسخ نداده (${progress}%)`);
    }

    // ایجاد آزمون مشابه
    function createSimilarExam() {
      if (!currentExamResults) {
        showNotification('ابتدا یک آزمون را تصحیح کنید');
        return;
      }
      
      // بارگذاری تنظیمات مشابه
      currentExamResults.subjectResults.forEach(subject => {
        const subjectId = subjects.find(s => s.name === subject.name)?.id;
        if (subjectId) {
          document.getElementById(subjectId).value = subject.count;
        }
      });
      
      // پاک کردن همه چیز
      document.getElementById('exam').innerHTML = '';
      document.getElementById('answerKeys').classList.add('hidden');
      document.getElementById('timer').classList.add('hidden');
      document.getElementById('results').innerHTML = '';
      document.getElementById('actionSection').classList.add('hidden');
      
      // فعال کردن تنظیمات
      enableSetupInputs();
      
      // به‌روزرسانی دکمه‌ها
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('editBtn').style.display = 'none';
      
      // به‌روزرسانی وضعیت
      document.getElementById('setupStatus').textContent = 'آماده برای شروع';
      document.getElementById('setupStatus').className = 'text-sm px-3 py-1 rounded-full bg-gray-700 text-gray-300';
      document.getElementById('setup').classList.remove('setup-active');
      
      showNotification('تنظیمات آزمون مشابه بارگذاری شد. حالا می‌توانید آزمون جدیدی شروع کنید');
    }

    // ادامه کدهای قبلی (handleOptionClick, startTimer, gradeExam, etc.)
    function handleOptionClick(subject, questionNum, optionNum) {
      if (!isExamActive) return;
      
      const questionId = `${subject}-q${questionNum}`;
      
      // Reset all options for this question
      document.querySelectorAll(`.option-box[data-question="${questionId}"]`).forEach(box => {
        box.classList.remove('selected');
        box.querySelector('.option-number').classList.remove('text-white', 'font-bold');
      });
      
      // Toggle selection
      if (selectedOptions[questionId] === optionNum) {
        delete selectedOptions[questionId];
      } else {
        selectedOptions[questionId] = optionNum;
        const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${optionNum}"]`);
        if (selectedBox) {
          selectedBox.classList.add('selected');
          selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
        }
      }
    }

    function startTimer() {
      const timeInMinutes = parseInt(document.getElementById('examTime').value);
      originalTime = timeInMinutes * 60;
      timeLeft = originalTime;
      
      const timerDiv = document.getElementById('timer');
      timerDiv.classList.remove('hidden');
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          showNotification("⏰ زمان آزمون به پایان رسید!");
          gradeExam();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const timeDisplay = document.getElementById('time-display');
      const timerDiv = document.getElementById('timer');
      
      timeDisplay.innerText = 
        `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      
      if (timeLeft <= 60) {
        timerDiv.classList.add('warning');
      } else {
        timerDiv.classList.remove('warning');
      }
    }

    function gradeExam() {
      clearInterval(timerInterval);
      isExamActive = false;
      let totalCorrect = 0;
      let totalWrong = 0;
      let totalBlank = 0;
      let totalQuestions = 0;
      let resultsHTML = '';
      let subjectResults = [];

      // راهنمای نمره دهی
      resultsHTML += `
        <div class="modern-card p-6 mb-6 animate-fade-in">
          <h3 class="text-lg font-bold mb-3 text-green-400 flex items-center">
            <i class="fas fa-info-circle ml-2"></i> راهنمای نمره دهی
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-green-500 ml-2"></div>
              <span>هر پاسخ صحیح: +1 نمره</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-red-500 ml-2"></div>
              <span>هر پاسخ غلط: -0.33 نمره</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-gray-500 ml-2"></div>
              <span>سوال نزده: 0 نمره</span>
            </div>
          </div>
        </div>`;

      // تحلیل درس به درس
      examStructure.forEach(subject => {
        let correct = 0;
        let wrong = 0;
        let blank = 0;

        for (let i = 0; i < subject.count; i++) {
          const questionNum = subject.startQuestion + i;
          const questionId = `${subject.subject}-q${questionNum}`;
          const selectedOption = selectedOptions[questionId];
          const correctAnswer = document.getElementById(`key-${questionId}`).value;
          const resultDiv = document.getElementById(`result-${questionId}`);

          // Reset all options for this question
          document.querySelectorAll(`.option-box[data-question="${questionId}"]`).forEach(box => {
            box.classList.remove('selected', 'correct', 'wrong', 'blank');
            box.querySelector('.option-number').className = 'option-number';
          });

          if (!selectedOption) {
            // سوال نزده
            blank++;
            const correctBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${correctAnswer}"]`);
            if (correctBox) {
              correctBox.classList.add('blank');
              correctBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
            }
            resultDiv.className = 'result-card blank';
            resultDiv.innerHTML = `
              <div class="flex items-center text-gray-300">
                <i class="fas fa-circle ml-2"></i>
                <span>سوال نزده - پاسخ صحیح: گزینه ${correctAnswer}</span>
              </div>`;
            resultDiv.style.display = 'block';
          } else if (selectedOption == correctAnswer) {
            // سوال صحیح
            correct++;
            const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${selectedOption}"]`);
            if (selectedBox) {
              selectedBox.classList.add('correct');
              selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
            }
            resultDiv.className = 'result-card correct';
            resultDiv.innerHTML = `
              <div class="flex items-center text-green-400">
                <i class="fas fa-check-circle ml-2"></i>
                <span>پاسخ صحیح</span>
              </div>`;
            resultDiv.style.display = 'block';
          } else {
            // سوال غلط
            wrong++;
            const selectedBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${selectedOption}"]`);
            const correctBox = document.querySelector(`.option-box[data-question="${questionId}"][data-option="${correctAnswer}"]`);
            
            if (selectedBox) {
              selectedBox.classList.add('wrong');
              selectedBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
            }
            if (correctBox) {
              correctBox.classList.add('correct');
              correctBox.querySelector('.option-number').classList.add('text-white', 'font-bold');
            }
            
            resultDiv.className = 'result-card wrong';
            resultDiv.innerHTML = `
              <div class="flex items-center text-red-400">
                <i class="fas fa-times-circle ml-2"></i>
                <span>پاسخ شما: گزینه ${selectedOption} - پاسخ صحیح: گزینه ${correctAnswer}</span>
              </div>`;
            resultDiv.style.display = 'block';
          }
        }

        const rawScore = correct;
        const correctedScore = Math.max(0, correct - (wrong / 3));
        const rawPercentage = (correct / subject.count) * 100;
        const correctedPercentage = (correctedScore / subject.count) * 100;
        const wrongPercentage = (wrong / subject.count) * 100;
        const blankPercentage = (blank / subject.count) * 100;

        // ذخیره نتایج
        subjectResults.push({
          name: subject.subject,
          count: subject.count,
          correct: correct,
          wrong: wrong,
          blank: blank,
          rawPercentage: rawPercentage,
          correctedPercentage: correctedPercentage,
          correctedScore: correctedScore
        });

        resultsHTML += `
          <div class="modern-card p-6 mb-6 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold flex items-center">
                <i class="${subject.icon} ml-2 text-${subject.color.split('-')[1]}-400"></i>
                <span>${subject.subject}</span>
              </h3>
              <span class="text-sm bg-gray-700 px-3 py-1 rounded-full">${subject.count} سوال</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-400">درصد خام:</span>
                  <span class="font-bold ${rawPercentage >= 70 ? 'text-green-400' : rawPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                    ${Math.round(rawPercentage)}%
                  </span>
                </div>
                <div class="progress-modern mb-4">
                  <div class="progress-fill bg-gradient-to-r ${subject.color}" style="width: ${rawPercentage}%"></div>
                </div>
                
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-400">درصد با نمره منفی:</span>
                  <span class="font-bold ${correctedPercentage >= 70 ? 'text-green-400' : correctedPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                    ${Math.round(correctedPercentage)}%
                  </span>
                </div>
                <div class="progress-modern">
                  <div class="progress-fill bg-gradient-to-r ${subject.color}" style="width: ${correctedPercentage}%"></div>
                </div>
              </div>
              
              <div>
                <div class="bg-gray-800/50 p-4 rounded-lg">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-green-400 flex items-center">
                      <i class="fas fa-check-circle ml-1"></i> صحیح:
                    </span>
                    <span>${correct} (${Math.round(rawPercentage)}%)</span>
                  </div>
                  
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-red-400 flex items-center">
                      <i class="fas fa-times-circle ml-1"></i> غلط:
                    </span>
                    <span>${wrong} (${Math.round(wrongPercentage)}%)</span>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <span class="text-gray-400 flex items-center">
                      <i class="fas fa-circle ml-1"></i> نزده:
                    </span>
                    <span>${blank} (${Math.round(blankPercentage)}%)</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-800/50 p-3 rounded-lg text-center">
              <div class="text-sm text-gray-400 mb-1">نمره نهایی این درس</div>
              <div class="text-2xl font-bold ${correctedPercentage >= 70 ? 'text-green-400' : correctedPercentage >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                ${correctedScore.toFixed(2)} از ${subject.count}
              </div>
            </div>
          </div>`;
        
        totalCorrect += correct;
        totalWrong += wrong;
        totalBlank += blank;
        totalQuestions += subject.count;
      });

      // نتایج کلی
      const totalRawPercentage = (totalCorrect / totalQuestions) * 100;
      const totalCorrectedScore = Math.max(0, totalCorrect - (totalWrong / 3));
      const totalCorrectedPercentage = (totalCorrectedScore / totalQuestions) * 100;
      const totalWrongPercentage = (totalWrong / totalQuestions) * 100;
      const totalBlankPercentage = (totalBlank / totalQuestions) * 100;

      resultsHTML += `
        <div class="modern-card p-6 border border-green-500/30 animate-fade-in">
          <h4 class="text-2xl font-bold mb-4 text-center text-green-400 flex items-center justify-center">
            <i class="fas fa-trophy ml-2"></i> نتیجه کلی آزمون
          </h4>
          
          <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-6">
            <div class="text-center">
              <div class="text-5xl font-bold text-green-400 mb-1">${Math.round(totalCorrectedPercentage)}%</div>
              <div class="text-gray-400">نمره نهایی با احتساب نمره منفی</div>
            </div>
            
            <div class="w-full md:w-1/2">
              <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden flex mb-2">
                <div class="bg-green-500 h-full" style="width:${totalRawPercentage}%"></div>
                <div class="bg-gray-500 h-full" style="width:${totalBlankPercentage}%"></div>
                <div class="bg-red-500 h-full" style="width:${totalWrongPercentage}%"></div>
              </div>
              
              <div class="flex justify-between text-sm">
                <span class="text-green-400">${totalCorrect} صحیح</span>
                <span class="text-gray-400">${totalBlank} نزده</span>
                <span class="text-red-400">${totalWrong} غلط</span>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mt-4">
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-green-400 font-bold text-xl">${totalQuestions}</div>
              <div class="text-gray-400 text-sm">کل سوالات</div>
            </div>
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-blue-400 font-bold text-xl">${Math.round(totalRawPercentage)}%</div>
              <div class="text-gray-400 text-sm">درصد صحیح</div>
            </div>
            <div class="bg-gray-700/50 p-3 rounded-lg text-center">
              <div class="text-yellow-400 font-bold text-xl">${Math.round(totalCorrectedPercentage)}%</div>
              <div class="text-gray-400 text-sm">درصد با نمره منفی</div>
            </div>
          </div>
          
          <div class="mt-6 bg-gray-700/50 p-4 rounded-lg text-center">
            <div class="text-lg text-gray-300 mb-2">نمره نهایی شما</div>
            <div class="text-4xl font-bold text-green-400">
              ${totalCorrectedScore.toFixed(2)} از ${totalQuestions}
            </div>
          </div>
        </div>`;

      document.getElementById('results').innerHTML = resultsHTML;
      document.getElementById('actionSection').classList.remove('hidden');
      
      // ذخیره داده‌ها برای ذخیره‌سازی
      currentExamResults = {
        subjectResults: subjectResults,
        totalQuestions: totalQuestions,
        totalCorrect: totalCorrect,
        totalWrong: totalWrong,
        totalBlank: totalBlank,
        totalPercentage: totalRawPercentage,
        totalCorrectedPercentage: totalCorrectedPercentage,
        totalCorrectedScore: totalCorrectedScore
      };
      
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // نمایش اعلان
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg border-l-4 border-green-500 flex items-center z-50 animate-fade-in';
      notification.innerHTML = `
        <i class="fas fa-info-circle ml-2 text-green-400"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // پرینت (نسخه ساده‌تر)
    function printResults() {
      window.print();
    }

    // بارگذاری اولیه
    document.addEventListener('DOMContentLoaded', function() {
      loadExamHistory();
      loadLastSettings();
    });
  </script>
</body>
</html>
